#  For more information about TARDIS pipelines, please refer to:
#
#    https://tardis-sn.github.io/tardis/contributing/development/continuous_integration.html

name: clean-docs

on:
  delete:
  pull_request_target:
    branches: ["*"]
    types: [closed]
  push:
    branches: [workflow_fixes]
  workflow_dispatch:

env:
  DEPLOY_BRANCH: gh-pages

jobs:
  clean:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ env.DEPLOY_BRANCH }}

      - name: Configure Git
        run: |
          git config user.name "TARDIS Bot"
          git config user.email tardis.sn.bot@gmail.com

      - name: Clean specific PR folder
        if: github.event_name == 'pull_request_target'
        run: |
          folder="pull/${{ github.event.number }}"
          if [[ -d "$folder" ]]; then
            git rm -rf "$folder"
            git commit -m "clean $folder"
            git push
          fi

      - name: Clean specific branch folder
        if: github.event_name == 'delete'
        run: |
          folder="${{ github.event.ref_type }}/${{ github.event.ref }}"
          if [[ -d "$folder" ]]; then
            git rm -rf "$folder"
            git commit -m "clean $folder"
            git push
          fi

      - name: Clean old PR folders
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        run: |
          if [[ -d pull ]]; then
            # Get 10 oldest PR folders based on modification time
            old_folders=$(find pull -maxdepth 1 -mindepth 1 -type d -printf "%T@ %p\n" | sort | head -10 | cut -d' ' -f2)
            
            if [[ -n "$old_folders" ]]; then
              echo "$old_folders" | xargs git rm -rf
              git commit -m "clean: remove old PR documentation folders"
              git push
            fi
          fi
