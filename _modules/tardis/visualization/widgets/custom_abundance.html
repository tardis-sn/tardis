

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-53HJHD1BWS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-53HJHD1BWS');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tardis.visualization.widgets.custom_abundance &mdash; tardis</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />

  
    <link rel="shortcut icon" href="../../../../_static/tardis_logo.ico"/>
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=3d5d8261"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.13/dist/embed-amd.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            tardis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/credits.html">Credits &amp; Publication Policies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/high_energy/run_high_energy_workflow.html">TARDIS High Energy Workflow Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/visualization/tutorial_montecarlo_packet_visualization.html">Montecarlo Packet Visualization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/index.html">Analyszing TARDIS Simulation Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/tutorial_read_configuration.html">Reading a Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/output/index.html">Additional Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../how-to/code_comparison/index.html">How to do Code Comparison using TARDIS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/intro/index.html">Physics Walkthrough Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/update_and_conv/update_and_conv.html">Updating Plasma and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/spectrum/index.html">Spectrum Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/tardisgamma/index.html">TARDIS-High Energy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/visualization_reference.html">Visualization Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/index.html">Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/hdf/index.html">Hierarchical Data Format (HDF5) Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/zreferences.html">Bibliography and Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/tools/index.html">Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/in_progress/index.html">Features In-Progress</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tardis.visualization.widgets.custom_abundance</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tardis.visualization.widgets.custom_abundance</h1><div class="highlight"><pre>
<span></span>&quot;&quot;&quot;Class to create and display Custom Abundance Widget.&quot;&quot;&quot;

from pathlib import Path

import ipywidgets as ipw
import numpy as np
import pandas as pd
import plotly.graph_objects as go
import yaml
from astropy import units as u
from radioactivedecay import Nuclide
from radioactivedecay.utils import Z_DICT, elem_to_Z

import tardis
import tardis.visualization.plot_util as pu
from tardis.io.atom_data.base import AtomData
from tardis.io.configuration.config_reader import Configuration
from tardis.io.configuration.config_validator import validate_dict
from tardis.io.model.parse_density_configuration import (
    calculate_exponential_density,
    calculate_power_law_density,
)
from tardis.io.model.readers.csvy import (
    load_csvy,
    parse_csv_mass_fractions,
)
from tardis.io.model.readers.generic_readers import read_uniform_mass_fractions
from tardis.model import SimulationState
from tardis.util.base import (
    atomic_number2element_symbol,
    is_valid_nuclide_or_elem,
    quantity_linspace,
)
from tardis.util.environment import Environment
from tardis.visualization.widgets.util import debounce
from tardis.configuration.sorting_globals import SORTING_ALGORITHM

BASE_DIR = tardis.__path__[0]
YAML_DELIMITER = &quot;---&quot;


<div class="viewcode-block" id="CustomAbundanceWidgetData">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidgetData">[docs]</a>
class CustomAbundanceWidgetData:
    &quot;&quot;&quot;The model information and data that required in custom
    abundance widget.

    Attributes
    ----------
    elements : list of str
        A list of elements or isotopes&#39; symbols.
    &quot;&quot;&quot;

    def __init__(self, density_t_0, density, abundance, velocity):
        &quot;&quot;&quot;Initialize CustomAbundanceWidgetData with model information.

        Parameters
        ----------
        density_t_0 : astropy.units.quantity.Quantity
            Initial time for the density in the model.
        density : astropy.units.quantity.Quantity
        abundance : pd.DataFrame
        velocity : astropy.units.quantity.Quantity
        &quot;&quot;&quot;
        self.density_t_0 = density_t_0.to(&quot;day&quot;)
        self.density = density.to(&quot;g cm^-3&quot;)
        self.abundance = abundance
        self.velocity = velocity.to(&quot;km/s&quot;)
        self.elements = self.get_symbols()

<div class="viewcode-block" id="CustomAbundanceWidgetData.get_symbols">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidgetData.get_symbols">[docs]</a>
    def get_symbols(self):
        &quot;&quot;&quot;Get symbol string from atomic number and mass number.&quot;&quot;&quot;
        str_symbols = np.array(
            self.abundance.index.get_level_values(0).map(
                atomic_number2element_symbol
            )
        )
        str_mass = np.array(
            self.abundance.index.get_level_values(1), dtype=&quot;str&quot;
        )
        return np.add(str_symbols, str_mass)</div>


<div class="viewcode-block" id="CustomAbundanceWidgetData.from_csvy">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidgetData.from_csvy">[docs]</a>
    @classmethod
    def from_csvy(cls, fpath):
        &quot;&quot;&quot;Create a new CustomAbundanceWidgetData instance with data
        from CSVY file.

        Parameters
        ----------
        fpath : str
            the path of CSVY file.

        Returns
        -------
        CustomAbundanceWidgetData
        &quot;&quot;&quot;
        csvy_model_config, csvy_model_data = load_csvy(fpath)
        csvy_schema_file = Path(BASE_DIR) / &quot;io&quot; / &quot;schemas&quot; / &quot;csvy_model.yml&quot;
        csvy_model_config = Configuration(
            validate_dict(csvy_model_config, schemapath=csvy_schema_file)
        )

        if hasattr(csvy_model_config, &quot;velocity&quot;):
            velocity = quantity_linspace(
                csvy_model_config.velocity.start,
                csvy_model_config.velocity.stop,
                csvy_model_config.velocity.num + 1,
            ).cgs
        else:
            velocity_field_index = [
                field[&quot;name&quot;] for field in csvy_model_config.datatype.fields
            ].index(&quot;velocity&quot;)
            velocity_unit = u.Unit(
                csvy_model_config.datatype.fields[velocity_field_index][&quot;unit&quot;]
            )
            velocity = csvy_model_data[&quot;velocity&quot;].values * velocity_unit

        no_of_shells = len(velocity) - 1

        if hasattr(csvy_model_config, &quot;density&quot;):
            adjusted_velocity = velocity.insert(0, 0)
            v_middle = (
                adjusted_velocity[1:] * 0.5 + adjusted_velocity[:-1] * 0.5
            )
            no_of_shells = len(adjusted_velocity) - 1

            d_conf = csvy_model_config.density
            density_type = d_conf.type
            if density_type == &quot;branch85_w7&quot;:
                density_0 = calculate_power_law_density(
                    v_middle, d_conf.w7_v_0, d_conf.w7_rho_0, -7
                )
                time_0 = d_conf.w7_time_0
            elif density_type == &quot;uniform&quot;:
                density_0 = d_conf.value.to(&quot;g cm^-3&quot;) * np.ones(no_of_shells)
                time_0 = d_conf.get(&quot;time_0&quot;, 0 * u.day)
            elif density_type == &quot;power_law&quot;:
                density_0 = calculate_power_law_density(
                    v_middle, d_conf.v_0, d_conf.rho_0, d_conf.exponent
                )
                time_0 = d_conf.get(&quot;time_0&quot;, 0 * u.day)
            elif density_type == &quot;exponential&quot;:
                density_0 = calculate_exponential_density(
                    v_middle, d_conf.v_0, d_conf.rho_0
                )
                time_0 = d_conf.get(&quot;time_0&quot;, 0 * u.day)
            else:
                raise ValueError(f&quot;Unrecognized density type {d_conf.type}&quot;)
        else:
            density_field_index = [
                field[&quot;name&quot;] for field in csvy_model_config.datatype.fields
            ].index(&quot;density&quot;)
            density_unit = u.Unit(
                csvy_model_config.datatype.fields[density_field_index][&quot;unit&quot;]
            )
            density_0 = csvy_model_data[&quot;density&quot;].values * density_unit
            time_0 = csvy_model_config.model_density_time_0

        if hasattr(csvy_model_config, &quot;abundance&quot;):
            abundances_section = csvy_model_config.abundance
            abundance, isotope_abundance = read_uniform_mass_fractions(
                abundances_section, no_of_shells
            )
        else:
            _, abundance, isotope_abundance = parse_csv_mass_fractions(
                csvy_model_data
            )
            abundance = abundance.loc[:, 1:]
            abundance.columns = np.arange(abundance.shape[1])
            isotope_abundance = isotope_abundance.loc[:, 1:]
            isotope_abundance.columns = np.arange(isotope_abundance.shape[1])

        abundance = abundance.replace(np.nan, 0.0)
        abundance = abundance[abundance.sum(axis=1) &gt; 0]
        isotope_abundance = isotope_abundance.replace(np.nan, 0.0)
        isotope_abundance = isotope_abundance[isotope_abundance.sum(axis=1) &gt; 0]

        # Combine elements and isotopes to one DataFrame
        abundance[&quot;mass_number&quot;] = &quot;&quot;
        abundance = abundance.set_index(&quot;mass_number&quot;, append=True)
        abundance = pd.concat([abundance, isotope_abundance])
        abundance = abundance.sort_index(kind=SORTING_ALGORITHM)

        return cls(
            density_t_0=time_0,
            density=density_0,
            abundance=abundance,
            velocity=velocity,
        )</div>


<div class="viewcode-block" id="CustomAbundanceWidgetData.from_yml">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidgetData.from_yml">[docs]</a>
    @classmethod
    def from_yml(cls, fpath, atom_data=None):
        &quot;&quot;&quot;Create a new CustomAbundanceWidgetData instance with data
        from YAML file.

        Parameters
        ----------
        fpath : str
            The path of YAML file.

        Returns
        -------
        CustomAbundanceWidgetData
        &quot;&quot;&quot;
        config = Configuration.from_yaml(fpath)
        if atom_data is None:
            atom_data = AtomData.from_hdf(config.atom_data)
        if hasattr(config, &quot;csvy_model&quot;):
            simulation_state = SimulationState.from_csvy(
                config, atom_data=atom_data
            )
        else:
            simulation_state = SimulationState.from_config(
                config, atom_data=atom_data
            )

        velocity = simulation_state.velocity
        density_t_0 = simulation_state.time_explosion
        density = simulation_state.density
        abundance = simulation_state.abundance
        isotopic_mass_fraction = (
            simulation_state.composition.isotopic_mass_fraction
        )

        # Combine elements and isotopes to one DataFrame
        abundance[&quot;mass_number&quot;] = &quot;&quot;
        abundance = abundance.set_index(&quot;mass_number&quot;, append=True)
        abundance = pd.concat([abundance, isotopic_mass_fraction])
        abundance = abundance.sort_index(kind=SORTING_ALGORITHM)

        return cls(
            density_t_0=density_t_0,
            density=density,
            abundance=abundance,
            velocity=velocity,
        )</div>


<div class="viewcode-block" id="CustomAbundanceWidgetData.from_hdf">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidgetData.from_hdf">[docs]</a>
    @classmethod
    def from_hdf(cls, fpath):
        &quot;&quot;&quot;Create a new CustomAbundanceWidgetData instance with data
        from HDF file.

        Parameters
        ----------
        fpath : str
            the path of HDF file.

        Returns
        -------
        CustomAbundanceWidgetData
        &quot;&quot;&quot;
        with pd.HDFStore(fpath, &quot;r&quot;) as hdf:
            abundance = hdf[&quot;/simulation/plasma/abundance&quot;]
            _density_t_0 = hdf[&quot;/simulation/model/homologous_density/scalars&quot;]
            _density = hdf[&quot;/simulation/model/homologous_density/density_0&quot;]
            v_inner = hdf[&quot;/simulation/model/v_inner&quot;]
            v_outer = hdf[&quot;/simulation/model/v_outer&quot;]

        density_t_0 = float(_density_t_0) * u.s
        density = np.array(_density) * u.g / (u.cm) ** 3
        velocity = np.append(v_inner, v_outer[len(v_outer) - 1]) * u.cm / u.s

        abundance[&quot;mass_number&quot;] = &quot;&quot;
        abundance = abundance.set_index(&quot;mass_number&quot;, append=True)

        return cls(
            density_t_0=density_t_0,
            density=density,
            abundance=abundance,
            velocity=velocity,
        )</div>


<div class="viewcode-block" id="CustomAbundanceWidgetData.from_simulation">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidgetData.from_simulation">[docs]</a>
    @classmethod
    def from_simulation(cls, sim):
        &quot;&quot;&quot;Create a new CustomAbundanceWidgetData instance from a
        Simulation object.

        Parameters
        ----------
        sim : Simulation

        Returns
        -------
        CustomAbundanceWidgetData
        &quot;&quot;&quot;
        abundance = sim.simulation_state.abundance.copy()
        isotope_abundance = (
            sim.simulation_state.composition.raw_isotope_abundance.copy()
        )

        # integrate element and isotope to one DataFrame
        abundance[&quot;mass_number&quot;] = &quot;&quot;
        abundance = abundance.set_index(&quot;mass_number&quot;, append=True)
        abundance = pd.concat([abundance, isotope_abundance])
        abundance = abundance.sort_index(kind=SORTING_ALGORITHM)

        velocity = sim.simulation_state.velocity
        density_t_0 = sim.simulation_state.time_explosion
        density = sim.simulation_state.density

        return cls(
            density_t_0=density_t_0,
            density=density,
            abundance=abundance,
            velocity=velocity,
        )</div>
</div>



<div class="viewcode-block" id="CustomYAML">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomYAML">[docs]</a>
class CustomYAML(yaml.YAMLObject):
    &quot;&quot;&quot;A custom YAML object generated by required properties.&quot;&quot;&quot;

    def __init__(
        self, name, d_time_0, i_time_0, v_inner_boundary, v_outer_boundary
    ):
        &quot;&quot;&quot;Initialize CustomYAML object with given properties.

        Parameters
        ----------
        name : str
            Name of the YAML file.
        d_time_0 : astropy.units.quantity.Quantity
            Initial time for the density in the model.
        i_time_0 : astropy.units.quantity.Quantity
            Initial time for isotope decay. Set to 0 for no isotopes.
        v_inner_boundary : astropy.units.quantity.Quantity
            Velocity of the inner boundary.
        v_outer_boundary : astropy.units.quantity.Quantity
            Velocity of the outer boundary.
        &quot;&quot;&quot;
        self.name = name
        self.model_density_time_0 = d_time_0
        self.model_isotope_time_0 = i_time_0
        self.tardis_model_config_version = &quot;v1.0&quot;
        self.datatype = {}
        self.datatype[&quot;fields&quot;] = []
        self.v_inner_boundary = v_inner_boundary
        self.v_outer_boundary = v_outer_boundary

<div class="viewcode-block" id="CustomYAML.create_fields_dict">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomYAML.create_fields_dict">[docs]</a>
    def create_fields_dict(self, elements):
        &quot;&quot;&quot;Create a dictionary to store the items in &#39;fields&#39; part.

        Parameters
        ----------
        elements : list of str
            A list of elements or isotopes&#39; symbols.
        &quot;&quot;&quot;
        for i in range(len(elements) + 2):
            field = {}

            if i == 0:
                field[&quot;name&quot;] = &quot;velocity&quot;
                field[&quot;unit&quot;] = &quot;km/s&quot;
            elif i == 1:
                field[&quot;name&quot;] = &quot;density&quot;
                field[&quot;unit&quot;] = &quot;g/cm^3&quot;
            else:
                field[&quot;name&quot;] = elements[i - 2]
                field[&quot;desc&quot;] = f&quot;fractional {elements[i - 2]} abundance&quot;

            self.datatype[&quot;fields&quot;].append(field)</div>
</div>



<div class="viewcode-block" id="CustomAbundanceWidget">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget">[docs]</a>
class CustomAbundanceWidget:
    &quot;&quot;&quot;Widget to edit abundances and densities of simulation model
    graphically.

    It generates a GUI based on input data. The GUI has a plot section
    to visualize the profile, an edit section to allow the user directly
    edit abundance and density profile, and an output section to output
    the model to CSVY file.

    Attributes
    ----------
    shell_no : int
        The selected shell number.
    no_of_shells : int
        The number of shells in the model.
    no_of_elements : int
        The number of elements in the model.
    checked_list : list of bool
        A list of bool to record whether the checkbox is checked.
        The index of the bool corresponds to the index of checkbox.
    fig : plotly.graph_objs._figurewidget.FigureWidget
        The figure object of abundance density plot.
    plot_cmap : str, default: &quot;jet&quot;, optional
        String defines the colormap used in abundance density plot.
    _trigger : bool
        If False, disable the callback when abundance input is changed.
    &quot;&quot;&quot;

    error_view = ipw.Output()

    def __init__(self, widget_data):
        &quot;&quot;&quot;Initialize CustomAbundanceWidget with data and generate
        the widgets and plot.

        Parameters
        ----------
        widget_data : CustomAbundanceWidgetData
        &quot;&quot;&quot;
        self.data = widget_data
        self.fig = go.FigureWidget()
        self._trigger = True

        self.create_widgets()
        self.generate_abundance_density_plot()
        self.density_editor = DensityEditor(
            self.data,
            self.fig,
            self.dpd_shell_no,
        )

    @property
    def shell_no(self):
        return self.dpd_shell_no.value

    @shell_no.setter
    def shell_no(self, value):
        self.dpd_shell_no.value = value

    @property
    def no_of_shells(self):
        return self.data.abundance.shape[1]

    @property
    def no_of_elements(self):
        return self.data.abundance.shape[0]

    @property
    def checked_list(self):  # A boolean list to store the value of checkboxes.
        _checked_list = []
        for check in self.checks:
            _checked_list.append(check.value)

        return _checked_list

<div class="viewcode-block" id="CustomAbundanceWidget.create_widgets">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.create_widgets">[docs]</a>
    def create_widgets(self):
        &quot;&quot;&quot;Create widget components in GUI and register callbacks for widgets.&quot;&quot;&quot;
        self.dpd_shell_no = ipw.Dropdown(
            options=list(range(1, self.no_of_shells + 1)),
            description=&quot;Shell No. &quot;,
            value=1,
            layout=ipw.Layout(width=&quot;160px&quot;),
        )
        self.dpd_shell_no.observe(self.dpd_shell_no_eventhandler, &quot;value&quot;)
        self.btn_prev = ipw.Button(
            icon=&quot;chevron-left&quot;,
            disabled=True,
            layout=ipw.Layout(width=&quot;30px&quot;, height=&quot;30px&quot;),
        )
        self.btn_prev.on_click(self.on_btn_prev)
        self.btn_next = ipw.Button(
            icon=&quot;chevron-right&quot;, layout=ipw.Layout(width=&quot;30px&quot;, height=&quot;30px&quot;)
        )
        self.btn_next.on_click(self.on_btn_next)

        self.checks = [
            ipw.Checkbox(
                indent=False,
                icon=&quot;lock&quot;,
                layout=ipw.Layout(
                    width=&quot;30px&quot;,
                ),
            )
            for element in self.data.elements
        ]
        self.input_items = [
            ipw.BoundedFloatText(min=0, max=1, step=0.01, description=element)
            for element in self.data.elements
        ]
        for i in range(self.no_of_elements):
            self.input_items[i].observe(self.input_item_eventhandler, &quot;value&quot;)
            self.input_items[i].index = i
            self.checks[i].observe(self.check_eventhandler, &quot;value&quot;)
            self.checks[i].index = i

        self.btn_norm = ipw.Button(
            description=&quot;Normalize&quot;,
            icon=&quot;cog&quot;,
            layout=ipw.Layout(width=&quot;100px&quot;, margin=&quot;0 0 0 50px&quot;),
        )
        self.btn_norm.on_click(self.on_btn_norm)
        self.norm_warning = ipw.Valid(
            value=False,
            readout=&quot;Unnormalized&quot;,
            style={&quot;description_width&quot;: &quot;initial&quot;},
            layout=ipw.Layout(visibility=&quot;hidden&quot;),
        )

        self.symb_warning = ipw.Valid(
            value=False, layout=ipw.Layout(visibility=&quot;hidden&quot;)
        )
        self.input_symb = ipw.Text(
            description=&quot;Element: &quot;,
            style={&quot;description_width&quot;: &quot;initial&quot;},
            placeholder=&quot;symbol&quot;,
            layout=ipw.Layout(width=&quot;125px&quot;),
        )
        self.input_symb.observe(self.input_symb_eventhandler, &quot;value&quot;)
        self.btn_add_element = ipw.Button(
            icon=&quot;plus-square&quot;,
            description=&quot;Add&quot;,
            disabled=True,
            layout=ipw.Layout(width=&quot;60px&quot;),
        )
        self.btn_add_element.on_click(self.on_btn_add_element)

        self.irs_shell_range = ipw.IntRangeSlider(
            min=1,
            max=self.no_of_shells,
            step=1,
            description=&quot;Shell No. &quot;,
            disabled=True,
            style={&quot;description_width&quot;: &quot;initial&quot;},
            continuous_update=False,
            layout=ipw.Layout(margin=&quot;5px 0 0 0&quot;),
        )
        self.irs_shell_range.observe(self.irs_shell_range_eventhandler, &quot;value&quot;)

        self.btn_add_shell = ipw.Button(
            icon=&quot;plus-square&quot;,
            description=&quot;Add&quot;,
            disabled=True,
            layout=ipw.Layout(
                width=&quot;80px&quot;,
            ),
        )
        self.btn_add_shell.on_click(self.on_btn_add_shell)
        self.input_v_start = ipw.FloatText(
            min=0,
            description=&quot;Add shell(s) with velocity range (km/s): &quot;,
            style={&quot;description_width&quot;: &quot;initial&quot;},
            layout=ipw.Layout(
                width=&quot;320px&quot;,
            ),
        )
        self.input_v_end = ipw.FloatText(
            min=0,
            description=&quot;to&quot;,
            style={&quot;description_width&quot;: &quot;initial&quot;},
            layout=ipw.Layout(width=&quot;110px&quot;),
        )
        self.input_v_start.observe(self.input_v_eventhandler, &quot;value&quot;)
        self.input_v_end.observe(self.input_v_eventhandler, &quot;value&quot;)
        self.overwrite_warning = ipw.HTML(
            value=&quot;&lt;font color=darkred&gt;&lt;b&gt;Warning:&lt;/b&gt;&lt;/font&gt; Existing shell(s) will be overwritten!&quot;,
            layout=ipw.Layout(visibility=&quot;hidden&quot;, margin=&quot;0 0 0 10px&quot;),
        )

        self.btn_output = ipw.Button(
            description=&quot;Output CSVY File&quot;,
        )
        self.btn_output.on_click(self.on_btn_output)

        self.input_path = ipw.Text(
            description=&quot;File path: &quot;, placeholder=&quot;Input file name or path&quot;
        )

        self.input_i_time_0 = ipw.FloatText(
            description=&quot;Isotope time_0 (day): &quot;,
            style={&quot;description_width&quot;: &quot;initial&quot;},
        )

        self.ckb_overwrite = ipw.Checkbox(
            description=&quot;overwrite&quot;,
            indent=False,
        )

        self.tbs_scale = ipw.ToggleButtons(
            options=[&quot;Linear&quot;, &quot;Log&quot;],
            description=&quot;Scale of yaxes: &quot;,
            style={&quot;description_width&quot;: &quot;initial&quot;},
            value=&quot;Linear&quot;,
        )
        self.tbs_scale.observe(self.tbs_scale_eventhandler, &quot;value&quot;)

        self.rbs_single_apply = ipw.RadioButtons(
            options=[&quot;Only selected shell&quot;],
            layout=ipw.Layout(margin=&quot;10px 0 0 0&quot;),
        )
        self.rbs_single_apply.observe(
            self.rbs_single_apply_eventhandler, &quot;value&quot;
        )
        self.rbs_multi_apply = ipw.RadioButtons(
            options=[&quot;A range of shells: &quot;],
            index=None,
            layout=ipw.Layout(width=&quot;130px&quot;, margin=&quot;10px 0 10px 0&quot;),
        )
        self.rbs_multi_apply.observe(self.rbs_multi_apply_eventhandler, &quot;value&quot;)</div>


<div class="viewcode-block" id="CustomAbundanceWidget.update_input_item_value">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.update_input_item_value">[docs]</a>
    def update_input_item_value(self, index, value):
        &quot;&quot;&quot;Update the value of the widget in the list of abundance inputs.

        Keep two decimal places for displayed value and disable
        `input_item_eventhandler` while changing the value.

        Parameters
        ----------
        index : int
            The index of the widget in the list of abundance inputs.
        value : float
            New abundance value.
        &quot;&quot;&quot;
        self._trigger = False
        # `input_items` is the list of  abundance input widgets.
        self.input_items[index].value = float(f&quot;{value:.2e}&quot;)
        self._trigger = True</div>


<div class="viewcode-block" id="CustomAbundanceWidget.read_abundance">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.read_abundance">[docs]</a>
    def read_abundance(self):
        &quot;&quot;&quot;Read abundances data in DataFrame to input items box when
        shell No. changes.
        &quot;&quot;&quot;
        for i in range(self.no_of_elements):
            value = self.data.abundance.iloc[i, self.shell_no - 1]
            self.update_input_item_value(i, value)</div>


<div class="viewcode-block" id="CustomAbundanceWidget.bound_locked_sum_to_1">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.bound_locked_sum_to_1">[docs]</a>
    def bound_locked_sum_to_1(self, index):
        &quot;&quot;&quot;Ensure the sum of locked abundances is no more than 1. If the
        locked sum is more than 1, calculate the maximum with the sum no
        more than 1 and return it.

        Parameters
        ----------
        index : int
            The index of the widget in the list of abundance inputs.
        &quot;&quot;&quot;
        locked_mask = np.array(self.checked_list)
        back_value = self.data.abundance.iloc[
            index, self.shell_no - 1
        ]  # abundance value in back end (DataFrame)
        front_value = self.input_items[
            index
        ].value  # abundance value in front end (widget)
        locked_sum = (
            self.data.abundance.loc[locked_mask, self.shell_no - 1].sum()
            - back_value
            + front_value
        )

        if locked_sum &gt; 1:
            new = 1 - (locked_sum - front_value)
            self.data.abundance.iloc[index, self.shell_no - 1] = new
            self.update_input_item_value(index, new)
            self.update_abundance_plot(index)</div>


<div class="viewcode-block" id="CustomAbundanceWidget.update_abundance_plot">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.update_abundance_plot">[docs]</a>
    def update_abundance_plot(self, index):
        &quot;&quot;&quot;Update the abundance line of certain element in the plot.

        Parameters
        ----------
        index : int
            The index of the widget in the list of abundance inputs.
        &quot;&quot;&quot;
        y = self.data.abundance.iloc[index]
        self.fig.data[index + 2].y = np.append(y, y.iloc[-1])</div>


<div class="viewcode-block" id="CustomAbundanceWidget.update_front_end">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.update_front_end">[docs]</a>
    def update_front_end(self):
        &quot;&quot;&quot;Update checkbox widgets, input widgets and plot in the front
        end when selected shell No. is changed.
        &quot;&quot;&quot;
        # Update checkboxes, input boxes and plot.
        for check in self.checks:
            check.value = False
        self.read_abundance()
        self.density_editor.read_density()
        with self.fig.batch_update():
            # Change bar diagonal
            x = list(self.fig.data[0].x)
            width = list(self.fig.data[0].width)
            x_inner = self.data.velocity[self.shell_no - 1].value
            x_outer = self.data.velocity[self.shell_no].value
            x[0] = (x_inner + x_outer) / 2
            self.fig.data[0].x = x
            width[0] = x_outer - x_inner
            self.fig.data[0].width = width</div>


<div class="viewcode-block" id="CustomAbundanceWidget.update_bar_diagonal">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.update_bar_diagonal">[docs]</a>
    def update_bar_diagonal(self):
        &quot;&quot;&quot;Update bar diagonal (and shell no dropdown) when the range
        of shells changed.
        &quot;&quot;&quot;
        if self.irs_shell_range.disabled:
            x = [self.fig.data[0].x[0]]
            width = [self.fig.data[0].width[0]]
            y = [1]
        else:
            self.shell_no = self.irs_shell_range.value[0]
            self.btn_next.disabled = True
            self.btn_prev.disabled = True

            (start_shell_no, end_shell_no) = self.irs_shell_range.value
            x_inner = self.data.velocity[start_shell_no - 1].value
            x_outer = self.data.velocity[end_shell_no].value
            x = [self.fig.data[0].x[0], (x_outer + x_inner) / 2]
            width = [self.fig.data[0].width[0], x_outer - x_inner]
            y = [1, 1]

        with self.fig.batch_update():
            self.fig.data[0].x = x
            self.fig.data[0].width = width
            self.fig.data[0].y = y</div>


<div class="viewcode-block" id="CustomAbundanceWidget.update_line_color">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.update_line_color">[docs]</a>
    def update_line_color(self):
        &quot;&quot;&quot;Update line color in the plot according to colormap.&quot;&quot;&quot;
        colorscale = pu.get_hex_color_strings(
            self.no_of_elements, self.plot_cmap
        )
        for i in range(self.no_of_elements):
            self.fig.data[2 + i].line.color = colorscale[i]</div>


<div class="viewcode-block" id="CustomAbundanceWidget.overwrite_existing_shells">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.overwrite_existing_shells">[docs]</a>
    def overwrite_existing_shells(self, v_0, v_1):
        &quot;&quot;&quot;Judge whether the existing shell(s) will be overwritten when
        inserting a new shell within the entered velocity range.

        Parameters
        ----------
        v_0 : float
            The velocity of inner boundary.
        v_1 : float
            The velocity of outer boundary.

        Returns
        -------
        bool
            True if the existing shell will be overwritten, False otherwise.
        &quot;&quot;&quot;
        v_vals = self.data.velocity.value
        position_0 = np.searchsorted(v_vals, v_0)
        position_1 = np.searchsorted(v_vals, v_1)

        index_0 = (
            position_0 - 1
            if np.isclose(v_vals[position_0 - 1], v_0)
            else position_0
        )
        index_1 = (
            position_1 - 1
            if np.isclose(v_vals[position_1 - 1], v_1)
            else position_1
        )

        return bool(
            index_1 - index_0 &gt; 1
            or index_1 - index_0 == 1
            and not np.isclose(v_vals[index_0], v_0)
        )</div>


<div class="viewcode-block" id="CustomAbundanceWidget.on_btn_add_shell">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.on_btn_add_shell">[docs]</a>
    def on_btn_add_shell(self, obj):
        &quot;&quot;&quot;Add new shell with given boundary velocities. Triggered if
        the button is clicked.

        Parameters
        ----------
        obj : ipywidgets.widgets.widget_button.Button
            The clicked button instance.
        &quot;&quot;&quot;
        v_start = self.input_v_start.value
        v_end = self.input_v_end.value
        v_vals = self.data.velocity.value

        position_0 = np.searchsorted(v_vals, v_start)
        position_1 = np.searchsorted(v_vals, v_end)
        start_index = (
            int(position_0 - 1)
            if np.isclose(v_vals[position_0 - 1], v_start)
            else int(position_0)
        )
        end_index = (
            int(position_1 - 1)
            if np.isclose(v_vals[position_1 - 1], v_end)
            else int(position_1)
        )

        if (
            end_index &lt; self.no_of_shells
            and np.isclose(v_vals[start_index], v_start)
            and np.isclose(v_vals[end_index], v_end)
            and end_index - start_index == 1
        ):
            return

        if start_index &lt; self.no_of_shells and np.isclose(
            v_vals[start_index], v_start
        ):
            new_shell_abundances = self.data.abundance[start_index]
        else:
            index = min(start_index - 1, self.no_of_shells - 1)
            new_shell_abundances = self.data.abundance[max(index, 0)]

        # Delete the overwritten shell (abundances and velocities).
        if end_index &lt; len(v_vals) and np.isclose(v_vals[end_index], v_end):
            # New shell will overwrite the original shell that ends at v_end.
            v_vals = np.delete(v_vals, end_index)
            self.data.abundance = self.data.abundance.drop(
                max(0, end_index - 1), 1
            )

        # Insert new velocities calculate new densities according
        # to new velocities through interpolation.
        v_vals = np.insert(v_vals, [start_index, end_index], [v_start, v_end])
        v_vals = np.delete(v_vals, slice(start_index + 1, end_index + 1))

        self.data.density = (
            np.interp(
                v_vals,
                self.data.velocity[1:].value,
                self.data.density[1:].value,
            )
            * self.data.density.unit
        )
        self.data.velocity = v_vals * self.data.velocity.unit

        # Change abundances after adding new shell.
        if start_index != end_index:
            self.data.abundance.insert(start_index, &quot;&quot;, new_shell_abundances)
            self.data.abundance = self.data.abundance.drop(
                self.data.abundance.iloc[:, start_index : end_index - 1],
                1,
            )
        else:
            if start_index == 0:
                self.data.abundance.insert(0, &quot;new&quot;, new_shell_abundances)
                self.data.abundance.insert(
                    0, &quot;gap&quot;, new_shell_abundances
                )  # Add a shell to fill the gap.
            else:
                self.data.abundance.insert(
                    start_index - 1, &quot;new&quot;, new_shell_abundances
                )
                self.data.abundance.insert(
                    start_index - 1, &quot;gap&quot;, new_shell_abundances
                )  # Add a shell to fill the gap with original abundances

        self.data.abundance.columns = range(self.no_of_shells)

        # Update data and x axis in plot.
        with self.fig.batch_update():
            self.fig.layout.xaxis.autorange = True
            self.fig.data[1].x = self.data.velocity
            self.fig.data[1].y = np.append(
                self.data.density[1:], self.data.density[-1]
            )
            for i in range(self.no_of_elements):
                self.fig.data[i + 2].x = self.data.velocity
                self.update_abundance_plot(i)

        self.dpd_shell_no.options = list(range(1, self.no_of_shells + 1))
        self.update_bar_diagonal()
        self.update_front_end()
        self.irs_shell_range.max = self.no_of_shells
        self.overwrite_warning.layout.visibility = &quot;hidden&quot;</div>


<div class="viewcode-block" id="CustomAbundanceWidget.tbs_scale_eventhandler">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.tbs_scale_eventhandler">[docs]</a>
    def tbs_scale_eventhandler(self, obj):
        &quot;&quot;&quot;Switch the scale type of y axis between linear mode and log
        mode. Triggered if the toggle button is changed.

        Parameters
        ----------
        obj : traitlets.utils.bunch.Bunch
            A dictionary holding the information about the change.
        &quot;&quot;&quot;
        scale_mode = obj.new

        if scale_mode == &quot;Linear&quot;:
            self.fig.update_layout(
                yaxis=dict(
                    type=&quot;linear&quot;,
                    range=[0, 1],
                ),
                yaxis2=dict(type=&quot;linear&quot;),
            )
        else:
            self.fig.update_layout(
                yaxis=dict(
                    type=&quot;log&quot;,
                    range=[-8, 0],
                ),
                yaxis2=dict(type=&quot;log&quot;),
            )</div>


<div class="viewcode-block" id="CustomAbundanceWidget.input_item_eventhandler">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.input_item_eventhandler">[docs]</a>
    def input_item_eventhandler(self, obj):
        &quot;&quot;&quot;Update the data and the widget when it gets new abundance
        input. Triggered if the abundance input is changed.

        Parameters
        ----------
        obj : traitlets.utils.bunch.Bunch
            A dictionary holding the information about the change.
        &quot;&quot;&quot;
        if self._trigger:
            item_index = obj.owner.index
            is_locked = self.checks[item_index]

            if is_locked:
                self.bound_locked_sum_to_1(item_index)

            self.data.abundance.iloc[item_index, self.shell_no - 1] = (
                obj.owner.value
            )

            if self.rbs_multi_apply.index is None:
                self.update_abundance_plot(item_index)
            else:
                self.apply_to_multiple_shells(item_index)

        if np.isclose(self.data.abundance.iloc[:, self.shell_no - 1].sum(), 1):
            self.norm_warning.layout.visibility = &quot;hidden&quot;
        else:
            self.norm_warning.layout.visibility = &quot;visible&quot;</div>


<div class="viewcode-block" id="CustomAbundanceWidget.check_eventhandler">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.check_eventhandler">[docs]</a>
    def check_eventhandler(self, obj):
        &quot;&quot;&quot;Triggered if the checkbox is changed.

        Parameters
        ----------
        obj : traitlets.utils.bunch.Bunch
            A dictionary holding the information about the change.
        &quot;&quot;&quot;
        item_index = obj.owner.index

        if obj.new is True:
            self.bound_locked_sum_to_1(item_index)</div>


<div class="viewcode-block" id="CustomAbundanceWidget.dpd_shell_no_eventhandler">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.dpd_shell_no_eventhandler">[docs]</a>
    def dpd_shell_no_eventhandler(self, obj):
        &quot;&quot;&quot;Make the data in widgets correspond with the selected shell.
        Triggered if the dropdown value is changed.

        Parameters
        ----------
        obj : traitlets.utils.bunch.Bunch
            A dictionary holding the information about the change.
        &quot;&quot;&quot;
        # Disable &quot;previous&quot; and &quot;next&quot; buttons when shell no comes to boundaries.
        if obj.new == 1:
            self.btn_prev.disabled = True
        else:
            self.btn_prev.disabled = False

        if obj.new == self.no_of_shells:
            self.btn_next.disabled = True
        else:
            self.btn_next.disabled = False

        self.update_front_end()</div>


<div class="viewcode-block" id="CustomAbundanceWidget.on_btn_prev">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.on_btn_prev">[docs]</a>
    def on_btn_prev(self, obj):
        &quot;&quot;&quot;Move to previous shell.

        Parameters
        ----------
        obj : ipywidgets.widgets.widget_button.Button
            The clicked button instance.
        &quot;&quot;&quot;
        self.shell_no -= 1</div>


<div class="viewcode-block" id="CustomAbundanceWidget.on_btn_next">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.on_btn_next">[docs]</a>
    def on_btn_next(self, obj):
        &quot;&quot;&quot;Move to next shell.

        Parameters
        ----------
        obj : ipywidgets.widgets.widget_button.Button
            The clicked button instance.
        &quot;&quot;&quot;
        self.shell_no += 1</div>


<div class="viewcode-block" id="CustomAbundanceWidget.on_btn_norm">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.on_btn_norm">[docs]</a>
    def on_btn_norm(self, obj):
        &quot;&quot;&quot;Normalize unlocked abundances to 1. Triggered if the
        normalize button is clicked.

        Parameters
        ----------
        obj : ipywidgets.widgets.widget_button.Button
            The clicked button instance.
        &quot;&quot;&quot;
        locked_mask = np.array(self.checked_list)
        locked_sum = self.data.abundance.loc[
            locked_mask, self.shell_no - 1
        ].sum()
        unlocked_arr = self.data.abundance.loc[~locked_mask, self.shell_no - 1]

        # if abundances are all zero
        if unlocked_arr.sum() == 0:
            return

        self.data.abundance.loc[~locked_mask, self.shell_no - 1] = (
            (1 - locked_sum) * unlocked_arr / unlocked_arr.sum()
        )

        self.read_abundance()

        for i in range(self.no_of_elements):
            if self.rbs_multi_apply.index is None:
                # Only normalize selected shell
                self.update_abundance_plot(i)
            else:
                self.apply_to_multiple_shells(i)</div>


    @debounce(0.5)
    def input_symb_eventhandler(self, obj):
        &quot;&quot;&quot;Judge whether the input symbol is valid. Triggered after 0.5s
        when the symbol input is changed.

        Parameters
        ----------
        obj : traitlets.utils.bunch.Bunch
            A dictionary holding the information about the change.
        &quot;&quot;&quot;
        element_symbol_string = obj.new.capitalize()

        if element_symbol_string == &quot;&quot;:
            self.symb_warning.layout.visibility = &quot;hidden&quot;
            self.btn_add_element.disabled = True
            return

        if element_symbol_string in self.data.elements:
            self.symb_warning.layout.visibility = &quot;visible&quot;
            self.btn_add_element.disabled = True
            self.symb_warning.readout = &quot;Already exists!&quot;
            return

        try:
            if is_valid_nuclide_or_elem(element_symbol_string):
                self.symb_warning.layout.visibility = &quot;hidden&quot;
                self.btn_add_element.disabled = False
                return

        except RuntimeError:
            pass

        self.symb_warning.layout.visibility = &quot;visible&quot;
        self.btn_add_element.disabled = True
        self.symb_warning.readout = &quot;invalid&quot;

<div class="viewcode-block" id="CustomAbundanceWidget.on_btn_add_element">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.on_btn_add_element">[docs]</a>
    def on_btn_add_element(self, obj):
        &quot;&quot;&quot;Add new element and update the display in the front end.
        Triggered if the add button is clicked.

        Parameters
        ----------
        obj : ipywidgets.widgets.widget_button.Button
            The clicked button instance.
        &quot;&quot;&quot;
        element_symbol_string = self.input_symb.value.capitalize()

        if element_symbol_string in Z_DICT.values():
            z = elem_to_Z(element_symbol_string)
            self.data.abundance.loc[(z, &quot;&quot;), :] = 0
        else:
            nuc = Nuclide(element_symbol_string)
            mass_no = nuc.A
            z = nuc.Z
            self.data.abundance.loc[(z, mass_no), :] = 0

        self.data.abundance = self.data.abundance.sort_index(kind=SORTING_ALGORITHM)

        # Add new BoundedFloatText control and Checkbox control.
        item = ipw.BoundedFloatText(min=0, max=1, step=0.01)
        check = ipw.Checkbox(indent=False, layout=ipw.Layout(width=&quot;30px&quot;))
        item.index = self.no_of_elements - 1
        check.index = self.no_of_elements - 1
        item.observe(self.input_item_eventhandler, &quot;value&quot;)
        check.observe(self.check_eventhandler, &quot;value&quot;)
        self.input_items.append(item)
        self.checks.append(check)

        # Keep the order of description same with atomic number
        self.data.elements = self.data.get_symbols()
        for i in range(self.no_of_elements):
            self.input_items[i].description = self.data.elements[i]

        self.box_editor.children = [
            ipw.VBox(self.input_items),
            ipw.VBox(self.checks),
        ]

        with self.fig.batch_update():
            # Add new trace to plot.
            self.fig.add_scatter(
                x=self.data.velocity,  # convert to km/s
                y=[0] * (self.no_of_shells + 1),
                mode=&quot;lines+markers&quot;,
                name=element_symbol_string,
                line=dict(shape=&quot;hv&quot;),
            )
            # Sort the legend in atomic order.
            fig_data_lst = list(self.fig.data)
            fig_data_lst.insert(
                np.argwhere(self.data.elements == element_symbol_string)[0][0]
                + 2,
                self.fig.data[-1],
            )
            self.fig.data = fig_data_lst[:-1]

            self.update_line_color()

        self.read_abundance()

        # Clear symbol input box.
        self.input_symb.value = &quot;&quot;</div>


<div class="viewcode-block" id="CustomAbundanceWidget.apply_to_multiple_shells">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.apply_to_multiple_shells">[docs]</a>
    def apply_to_multiple_shells(self, item_index):
        &quot;&quot;&quot;Apply the changed abundances to specified range of shell(s).

        Parameters
        ----------
        item_index : int
            The index of the widget in the list of abundance inputs.
        &quot;&quot;&quot;
        start_index = self.irs_shell_range.value[0] - 1
        end_index = self.irs_shell_range.value[1]
        applied_shell_index = self.shell_no - 1

        self.data.abundance.iloc[item_index, start_index:end_index] = (
            self.data.abundance.iloc[item_index, applied_shell_index]
        )

        self.update_abundance_plot(item_index)</div>


<div class="viewcode-block" id="CustomAbundanceWidget.input_v_eventhandler">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.input_v_eventhandler">[docs]</a>
    def input_v_eventhandler(self, obj):
        &quot;&quot;&quot;Judge whether the input velocity range is valid. Triggered if the
        velocity input is changed.

        Parameters
        ----------
        obj : traitlets.utils.bunch.Bunch
            A dictionary holding the information about the change.
        &quot;&quot;&quot;
        v_start = self.input_v_start.value
        v_end = self.input_v_end.value

        if v_start &gt;= v_end or v_start &lt; 0 or v_end &lt; 0:
            self.btn_add_shell.disabled = True
            return
        else:
            self.btn_add_shell.disabled = False

        # Whether overwrite existing shells
        if self.overwrite_existing_shells(v_start, v_end):
            self.overwrite_warning.layout.visibility = &quot;visible&quot;
        else:
            self.overwrite_warning.layout.visibility = &quot;hidden&quot;</div>


<div class="viewcode-block" id="CustomAbundanceWidget.on_btn_output">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.on_btn_output">[docs]</a>
    def on_btn_output(self, obj):
        &quot;&quot;&quot;Triggered if the output button is clicked.

        Parameters
        ----------
        obj : ipywidgets.widgets.widget_button.Button
            The clicked button instance.
        &quot;&quot;&quot;
        path = self.input_path.value
        overwrite = self.ckb_overwrite.value

        self.to_csvy(path, overwrite)</div>


<div class="viewcode-block" id="CustomAbundanceWidget.rbs_single_apply_eventhandler">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.rbs_single_apply_eventhandler">[docs]</a>
    def rbs_single_apply_eventhandler(self, obj):
        &quot;&quot;&quot;Switch to single shell editing mode. Triggered if the
        first radio button is selected.

        Parameters
        ----------
        obj : ipywidgets.widgets.widget_button.Button
            The clicked button instance.
        &quot;&quot;&quot;
        self.abundance_note.layout.visibility = &quot;hidden&quot;

        self.rbs_multi_apply.unobserve(
            self.rbs_multi_apply_eventhandler, &quot;value&quot;
        )
        self.rbs_multi_apply.index = None
        self.rbs_multi_apply.observe(self.rbs_multi_apply_eventhandler, &quot;value&quot;)

        self.dpd_shell_no.disabled = False
        self.btn_next.disabled = False
        self.btn_prev.disabled = False
        self.irs_shell_range.disabled = True
        self.update_bar_diagonal()</div>


<div class="viewcode-block" id="CustomAbundanceWidget.rbs_multi_apply_eventhandler">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.rbs_multi_apply_eventhandler">[docs]</a>
    def rbs_multi_apply_eventhandler(self, obj):
        &quot;&quot;&quot;Switch to multi-shells editing mode. Triggered if the
        second radio button is selected.

        Parameters
        ----------
        obj : ipywidgets.widgets.widget_button.Button
            The clicked button instance.
        &quot;&quot;&quot;
        self.abundance_note.layout.visibility = &quot;visible&quot;

        self.shell_no = self.irs_shell_range.value[0]

        self.rbs_single_apply.unobserve(
            self.rbs_single_apply_eventhandler, &quot;value&quot;
        )
        self.rbs_single_apply.index = None
        self.rbs_single_apply.observe(
            self.rbs_single_apply_eventhandler, &quot;value&quot;
        )
        # self.irs_shell_range.value = [self.shell_no, self.shell_no]
        self.dpd_shell_no.disabled = True
        self.btn_next.disabled = True
        self.btn_prev.disabled = True
        self.irs_shell_range.disabled = False
        self.update_bar_diagonal()</div>


<div class="viewcode-block" id="CustomAbundanceWidget.irs_shell_range_eventhandler">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.irs_shell_range_eventhandler">[docs]</a>
    def irs_shell_range_eventhandler(self, obj):
        &quot;&quot;&quot;Select the velocity range of new shell and highlight the range
        in the plot. Triggered if the shell range slider is changed.

        Parameters
        ----------
        obj : ipywidgets.widgets.widget_button.Button
            The clicked button instance.
        &quot;&quot;&quot;
        self.update_bar_diagonal()</div>


<div class="viewcode-block" id="CustomAbundanceWidget.generate_abundance_density_plot">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.generate_abundance_density_plot">[docs]</a>
    def generate_abundance_density_plot(self):
        &quot;&quot;&quot;Generate abundance and density plot in different shells.&quot;&quot;&quot;
        title = &quot;Abundance/Density vs Velocity&quot;
        abundance = self.data.abundance
        velocity = self.data.velocity
        density = self.data.density

        # Bar Diagonal
        self.fig.add_trace(
            go.Bar(
                x=[(velocity[0].value + velocity[1].value) / 2],
                y=[1],
                width=[velocity[1].value - velocity[0].value],
                name=&quot;Selected shell&quot;,
                marker=dict(
                    color=&quot;rgb(253,205,172)&quot;,
                ),
                hoverinfo=&quot;none&quot;,
            )
        )

        self.fig.add_trace(
            go.Scatter(
                x=velocity,
                y=np.append(density[1:], density[-1]),
                mode=&quot;lines+markers&quot;,
                name=&quot;&lt;b&gt;Density&lt;/b&gt;&quot;,
                yaxis=&quot;y2&quot;,
                line=dict(color=&quot;black&quot;, shape=&quot;hv&quot;),
                marker_symbol=&quot;square&quot;,
            ),
        )

        for i in range(self.no_of_elements):
            self.fig.add_trace(
                go.Scatter(
                    x=velocity,
                    y=np.append(abundance.iloc[i], abundance.iloc[i, -1]),
                    mode=&quot;lines+markers&quot;,
                    line=dict(shape=&quot;hv&quot;),
                    name=self.data.elements[i],
                ),
            )

        self.fig.update_layout(
            xaxis=dict(
                title=&quot;Velocity (km/s)&quot;,
                tickformat=&quot;f&quot;,
            ),
            yaxis=dict(
                title=&quot;Fractional Abundance&quot;,
                exponentformat=&quot;e&quot;,
                range=[0, 1],
            ),
            yaxis2=dict(
                title=&quot;Density (g/cm^3)&quot;,
                exponentformat=&quot;e&quot;,
                overlaying=&quot;y&quot;,
                side=&quot;right&quot;,
            ),
            height=500,
            title=title,
            hovermode=&quot;closest&quot;,
            legend=dict(
                x=1.15,
            ),
        )</div>


<div class="viewcode-block" id="CustomAbundanceWidget.display">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.display">[docs]</a>
    def display(self, cmap=&quot;jet&quot;):
        &quot;&quot;&quot;Display the GUI.

        Parameters
        ----------
        cmap : str, default: &quot;jet&quot;, optional
            String defines the colormap used in abundance density plot.

        Returns
        -------
        ipywidgets.widgets.widget_box.VBox
            A box that contains all the widgets in the GUI.
        &quot;&quot;&quot;
        if not Environment.allows_widget_display():
            print(&quot;Please use a notebook to display the widget&quot;)
        else:
            # --------------Combine widget components--------------
            self.box_editor = ipw.HBox(
                [
                    ipw.VBox(self.input_items),
                    ipw.VBox(
                        self.checks, layout=ipw.Layout(margin=&quot;0 0 0 10px&quot;)
                    ),
                ]
            )

            box_add_shell = ipw.HBox(
                [
                    self.input_v_start,
                    self.input_v_end,
                    self.btn_add_shell,
                    self.overwrite_warning,
                ],
                layout=ipw.Layout(margin=&quot;0 0 0 50px&quot;),
            )

            box_head = ipw.HBox(
                [self.dpd_shell_no, self.btn_prev, self.btn_next, box_add_shell]
            )

            box_add_element = ipw.HBox(
                [self.input_symb, self.btn_add_element, self.symb_warning],
                layout=ipw.Layout(margin=&quot;0 0 0 80px&quot;),
            )

            help_note = ipw.HTML(
                value=&quot;&lt;p style=&#39;text-indent: 40px&#39;&gt;* Select a checkbox &quot;
                &quot;to lock the abundance of corresponding element. &lt;/p&gt;&quot;
                &quot;&lt;p style=&#39;text-indent: 40px&#39;&gt; On clicking the &#39;Normalize&#39; &quot;
                &quot;button, the locked abundance(s) will &lt;b&gt;not be normalized&lt;/b&gt;.&quot;
                &quot; &lt;/p&gt;&quot;,
                indent=True,
            )

            self.abundance_note = ipw.HTML(
                description=&quot;(The following abundances are for the innermost &quot;
                &quot;shell in selected range.)&quot;,
                layout=ipw.Layout(visibility=&quot;hidden&quot;),
                style={&quot;description_width&quot;: &quot;initial&quot;},
            )

            box_norm = ipw.HBox([self.btn_norm, self.norm_warning])

            box_apply = ipw.VBox(
                [
                    ipw.Label(value=&quot;Apply abundance(s) to:&quot;),
                    self.rbs_single_apply,
                    ipw.HBox(
                        [
                            self.rbs_multi_apply,
                            self.irs_shell_range,
                            self.abundance_note,
                        ]
                    ),
                ],
                layout=ipw.Layout(margin=&quot;0 0 15px 50px&quot;),
            )

            box_features = ipw.VBox([box_norm, help_note])
            box_abundance = ipw.VBox(
                [
                    box_apply,
                    ipw.HBox([self.box_editor, box_features]),
                    box_add_element,
                ]
            )
            box_density = self.density_editor.display()

            main_tab = ipw.Tab([box_abundance, box_density])
            main_tab.set_title(0, &quot;Edit Abundance&quot;)
            main_tab.set_title(1, &quot;Edit Density&quot;)

            hint = ipw.HTML(
                value=&quot;&lt;b&gt;&lt;font size=&#39;3&#39;&gt;Save model as file: &lt;/font&gt;&lt;/b&gt;&quot;
            )
            box_output = ipw.VBox(
                [
                    hint,
                    self.input_i_time_0,
                    ipw.HBox(
                        [self.input_path, self.btn_output, self.ckb_overwrite]
                    ),
                ]
            )

            # Initialize the widget and plot colormap
            self.plot_cmap = cmap
            self.update_line_color()
            self.read_abundance()
            self.density_editor.read_density()

            return ipw.VBox(
                [
                    self.tbs_scale,
                    self.fig,
                    box_head,
                    main_tab,
                    box_output,
                    self.error_view,
                ]
            )</div>


<div class="viewcode-block" id="CustomAbundanceWidget.to_csvy">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.to_csvy">[docs]</a>
    @error_view.capture(clear_output=True)
    def to_csvy(self, path, overwrite):
        &quot;&quot;&quot;Output CSVY file on the specified path.

        Parameters
        ----------
        path : str
            Output path.
        overwrite : bool
            True if overwriting, False otherwise.
        &quot;&quot;&quot;
        posix_path = Path(path)
        posix_path = posix_path.with_suffix(&quot;.csvy&quot;)

        if posix_path.exists() and not overwrite:
            raise FileExistsError(
                &quot;The file already exists. Click the &#39;overwrite&#39; checkbox to overwrite it.&quot;
            )
        else:
            self.write_yaml_portion(posix_path)
            self.write_csv_portion(posix_path)</div>


<div class="viewcode-block" id="CustomAbundanceWidget.write_yaml_portion">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.write_yaml_portion">[docs]</a>
    @error_view.capture(clear_output=True)
    def write_yaml_portion(self, path):
        &quot;&quot;&quot;Write the YAML portion of the output file.

        Parameters
        ----------
        path : pathlib.PosixPath
        &quot;&quot;&quot;
        name = path.name
        d_time_0 = self.data.density_t_0
        i_time_0 = self.input_i_time_0.value * u.day
        custom_yaml = CustomYAML(
            name,
            d_time_0,
            i_time_0,
            self.data.velocity[0],
            self.data.velocity[-1],
        )
        custom_yaml.create_fields_dict(self.data.elements)

        with path.open(&quot;w&quot;) as f:
            yaml_output = yaml.dump(custom_yaml, sort_keys=False)

            # Add YAML delimiter
            yaml_output_snippets = yaml_output.split(&quot;\n&quot;)
            yaml_output_snippets[0] = yaml_output_snippets[-1] = YAML_DELIMITER
            yaml_output = &quot;\n&quot;.join(yaml_output_snippets) + &quot;\n&quot;

            f.write(yaml_output)

        print(&quot;Saved Successfully!&quot;)</div>


<div class="viewcode-block" id="CustomAbundanceWidget.write_csv_portion">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.write_csv_portion">[docs]</a>
    def write_csv_portion(self, path):
        &quot;&quot;&quot;Write the CSV portion of the output file.

        Parameters
        ----------
        path : pathlib.PosixPath
        &quot;&quot;&quot;
        try:
            data = self.data.abundance.T
            data.columns = self.data.elements
            first_row = [0] * self.no_of_elements
            data.loc[-1] = first_row
            data.index += 1  # shifting index
            data = data.sort_index(kind=SORTING_ALGORITHM)

            formatted_v = pd.Series(self.data.velocity.value).apply(
                lambda x: f&quot;{x:.3e}&quot;
            )
            # Make sure velocity is within the boundary.
            formatted_v[0] = self.data.velocity.value[0]
            formatted_v[-1] = self.data.velocity.value[-1]

            density = self.data.density
            data.insert(0, &quot;velocity&quot;, formatted_v)
            data.insert(1, &quot;density&quot;, density)

            data.to_csv(path, mode=&quot;a&quot;, index=False)
        except pd.errors.EmptyDataError:
            data = None</div>


<div class="viewcode-block" id="CustomAbundanceWidget.from_csvy">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.from_csvy">[docs]</a>
    @classmethod
    def from_csvy(cls, fpath):
        &quot;&quot;&quot;Create a new CustomAbundanceWidget instance with data from CSVY file.

        Parameters
        ----------
        fpath : str
            the path of CSVY file.

        Returns
        -------
        CustomAbundanceWidget
        &quot;&quot;&quot;
        widget_data = CustomAbundanceWidgetData.from_csvy(fpath)

        return cls(widget_data)</div>


<div class="viewcode-block" id="CustomAbundanceWidget.from_yml">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.from_yml">[docs]</a>
    @classmethod
    def from_yml(cls, fpath):
        &quot;&quot;&quot;Create a new CustomAbundanceWidget instance with data from YAML file.

        Parameters
        ----------
        fpath : str
            The path of YAML file.

        Returns
        -------
        CustomAbundanceWidget
        &quot;&quot;&quot;
        widget_data = CustomAbundanceWidgetData.from_yml(fpath)

        return cls(widget_data)</div>


<div class="viewcode-block" id="CustomAbundanceWidget.from_hdf">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.from_hdf">[docs]</a>
    @classmethod
    def from_hdf(cls, fpath):
        &quot;&quot;&quot;Create a new CustomAbundanceWidget instance with data from HDF file.

        Parameters
        ----------
        fpath : str
            the path of HDF file.

        Returns
        -------
        CustomAbundanceWidget
        &quot;&quot;&quot;
        widget_data = CustomAbundanceWidgetData.from_hdf(fpath)

        return cls(widget_data)</div>


<div class="viewcode-block" id="CustomAbundanceWidget.from_simulation">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.CustomAbundanceWidget.from_simulation">[docs]</a>
    @classmethod
    def from_simulation(cls, sim):
        &quot;&quot;&quot;Create a new CustomAbundanceWidget instance from a Simulation object.

        Parameters
        ----------
        sim : Simulation

        Returns
        -------
        CustomAbundanceWidget
        &quot;&quot;&quot;
        widget_data = CustomAbundanceWidgetData.from_simulation(sim)

        return cls(widget_data)</div>
</div>



<div class="viewcode-block" id="DensityEditor">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.DensityEditor">[docs]</a>
class DensityEditor:
    &quot;&quot;&quot;Widget to edit density profile of the model.

    It provides an interface to allow the user directly change
    the density, or calculate the density with given type and
    parameters.

    Attributes
    ----------
    shell_no : int
        The selected shell number.
    _trigger : bool
        If False, disable the callback when density input is changed.
    &quot;&quot;&quot;

    def __init__(self, widget_data, fig, shell_no_widget):
        &quot;&quot;&quot;Initialize DensityEditor with data and widget components.

        Parameters
        ----------
        widget_data : CustomAbundanceWidgetData
            Data in the custom abundance widget.
        fig : plotly.graph_objs._figurewidget.FigureWidget
            The figure object of density plot.
        shell_no_widget : ipywidgets.widgets.widget_selection.Dropdown
            A widget to record the selected shell number.
        &quot;&quot;&quot;
        self.data = widget_data
        self.fig = fig
        self.shell_no_widget = shell_no_widget

        self.create_widgets()
        self._trigger = True

    @property
    def shell_no(self):
        return self.shell_no_widget.value

<div class="viewcode-block" id="DensityEditor.create_widgets">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.DensityEditor.create_widgets">[docs]</a>
    def create_widgets(self):
        &quot;&quot;&quot;Create widget components in density editor GUI and register
        callbacks for widgets.
        &quot;&quot;&quot;
        self.input_d = ipw.FloatText(
            description=&quot;Density&quot;,
            layout=ipw.Layout(
                width=&quot;230px&quot;,
            ),
        )
        self.input_d.observe(self.input_d_eventhandler, &quot;value&quot;)

        self.input_d_time_0 = ipw.FloatText(
            value=self.data.density_t_0.value,
            description=&quot;Density time_0 (day): &quot;,
            style={&quot;description_width&quot;: &quot;initial&quot;},
            layout=ipw.Layout(margin=&quot;0 0 20px 0&quot;),
        )
        self.input_d_time_0.observe(self.input_d_time_0_eventhandler, &quot;value&quot;)

        self.input_d_time_0 = ipw.FloatText(
            value=self.data.density_t_0.value,
            description=&quot;Density time_0 (day): &quot;,
            style={&quot;description_width&quot;: &quot;initial&quot;},
            layout=ipw.Layout(margin=&quot;0 0 20px 0&quot;),
        )
        self.input_d_time_0.observe(self.input_d_time_0_eventhandler, &quot;value&quot;)

        self.dpd_dtype = ipw.Dropdown(
            options=[&quot;-&quot;, &quot;uniform&quot;, &quot;exponential&quot;, &quot;power_law&quot;],
            description=&quot;Density type: &quot;,
            style={&quot;description_width&quot;: &quot;initial&quot;},
            layout=ipw.Layout(width=&quot;300px&quot;),
        )
        self.dpd_dtype.observe(self.dpd_dtype_eventhandler, &quot;value&quot;)

        self.input_rho_0 = ipw.FloatText(
            description=&quot;rho_0&quot;, layout=ipw.Layout(width=&quot;300px&quot;)
        )

        self.input_exp = ipw.FloatText(
            description=&quot;exponent&quot;, layout=ipw.Layout(width=&quot;300px&quot;)
        )

        self.input_v_0 = ipw.FloatText(
            description=&quot;v_0&quot;, layout=ipw.Layout(width=&quot;300px&quot;)
        )

        self.input_value = ipw.FloatText(
            description=&quot;value&quot;, layout=ipw.Layout(width=&quot;300px&quot;)
        )

        self.btn_calculate = ipw.Button(
            icon=&quot;calculator&quot;,
            description=&quot;Calculate Density&quot;,
            layout=ipw.Layout(width=&quot;300px&quot;),
        )
        self.btn_calculate.on_click(self.on_btn_calculate)

        self.uniform_box = ipw.HBox(
            [self.input_value, ipw.Label(value=&quot;g cm^3&quot;)]
        )

        # Formula to compute density profile
        form_exp = ipw.HTMLMath(
            value=r&quot;$$\rho = \rho_0 \times \exp \left( -\frac{v}{v_0} \right)$$&quot;,
            layout=ipw.Layout(margin=&quot;0 0 0 100px&quot;),
        )
        form_pow = ipw.HTMLMath(
            value=r&quot;$$\rho = \rho_0 \times \left( \frac{v}{v_0} \right)^n$$&quot;,
            layout=ipw.Layout(margin=&quot;0 0 0 100px&quot;),
        )

        self.exp_box = ipw.VBox(
            [
                form_exp,
                ipw.HBox([self.input_rho_0, ipw.Label(value=&quot;g cm^3&quot;)]),
                ipw.HBox([self.input_v_0, ipw.Label(value=&quot;km/s&quot;)]),
            ]
        )
        self.pow_box = ipw.VBox(
            [
                form_pow,
                ipw.HBox([self.input_rho_0, ipw.Label(value=&quot;g cm^3&quot;)]),
                ipw.HBox([self.input_v_0, ipw.Label(value=&quot;km/s&quot;)]),
                self.input_exp,
            ]
        )</div>


<div class="viewcode-block" id="DensityEditor.read_density">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.DensityEditor.read_density">[docs]</a>
    def read_density(self):
        &quot;&quot;&quot;Read density data in DataFrame to density input box when
        shell No. changes.
        &quot;&quot;&quot;
        dvalue = self.data.density[self.shell_no].value
        self._trigger = False
        self.input_d.value = float(f&quot;{dvalue:.3e}&quot;)
        self._trigger = True</div>


<div class="viewcode-block" id="DensityEditor.update_density_plot">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.DensityEditor.update_density_plot">[docs]</a>
    def update_density_plot(self):
        &quot;&quot;&quot;Update the density line in the plot.&quot;&quot;&quot;
        y = np.append(self.data.density[1:], self.data.density[-1])
        self.fig.data[1].y = y</div>


<div class="viewcode-block" id="DensityEditor.input_d_eventhandler">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.DensityEditor.input_d_eventhandler">[docs]</a>
    def input_d_eventhandler(self, obj):
        &quot;&quot;&quot;Update the data and the widgets when the widget gets new
        density input.

        Parameters
        ----------
        obj : traitlets.utils.bunch.Bunch
            A dictionary holding the information about the change.
        &quot;&quot;&quot;
        if self._trigger:
            new_value = obj.new
            self.data.density[self.shell_no] = (
                new_value * self.data.density.unit
            )

            self.update_density_plot()</div>


    def input_d_time_0_eventhandler(self, obj):
        &quot;&quot;&quot;Update density time 0 data when the widget gets new input.

        Parameters
        ----------
        obj : traitlets.utils.bunch.Bunch
            A dictionary holding the information about the change.
        &quot;&quot;&quot;
        new_value = obj.new
        self.data.density_t_0 = new_value * self.data.density_t_0.unit

<div class="viewcode-block" id="DensityEditor.input_d_time_0_eventhandler">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.DensityEditor.input_d_time_0_eventhandler">[docs]</a>
    def input_d_time_0_eventhandler(self, obj):
        &quot;&quot;&quot;Update density time 0 data when the widget gets new input.

        Parameters
        ----------
        obj : traitlets.utils.bunch.Bunch
            A dictionary holding the information about the change.
        &quot;&quot;&quot;
        new_value = obj.new
        self.data.density_t_0 = new_value * self.data.density_t_0.unit</div>


    dtype_out = ipw.Output()

<div class="viewcode-block" id="DensityEditor.dpd_dtype_eventhandler">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.DensityEditor.dpd_dtype_eventhandler">[docs]</a>
    @dtype_out.capture(clear_output=True)
    def dpd_dtype_eventhandler(self, obj):
        &quot;&quot;&quot;Display the input boxes of the specified density type.
        Triggered if the density type dropdown is changed.

        Parameters
        ----------
        obj : traitlets.utils.bunch.Bunch
            A dictionary holding the information about the change.

        Returns
        -------
        ipywidgets.widgets.widget_box.VBox
            A box widget that contains the input boxes of certain density
            type parameters.
        &quot;&quot;&quot;
        if obj.new == &quot;uniform&quot;:
            display(self.uniform_box)
        elif obj.new == &quot;exponential&quot;:
            display(self.exp_box)
        elif obj.new == &quot;power_law&quot;:
            display(self.pow_box)</div>


<div class="viewcode-block" id="DensityEditor.on_btn_calculate">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.DensityEditor.on_btn_calculate">[docs]</a>
    def on_btn_calculate(self, obj):
        &quot;&quot;&quot;Calculate density according to density parameters input.
        Triggered if the density calculate button is clicked.

        Parameters
        ----------
        obj : ipywidgets.widgets.widget_button.Button
            The clicked button instance.
        &quot;&quot;&quot;
        dtype = self.dpd_dtype.value
        density = self.data.density
        velocity = self.data.velocity

        if dtype == &quot;-&quot;:
            return

        if dtype == &quot;uniform&quot;:
            if self.input_value.value == 0:
                return

            self.data.density = (
                self.input_value.value * density.unit * np.ones(len(density))
            )
        else:
            if self.input_v_0.value == 0 or self.input_rho_0.value == 0:
                return

            adjusted_velocity = velocity.insert(0, 0)
            v_middle = (
                adjusted_velocity[1:] * 0.5 + adjusted_velocity[:-1] * 0.5
            )
            v_0 = self.input_v_0.value * velocity.unit
            rho_0 = self.input_rho_0.value * density.unit

            if dtype == &quot;exponential&quot;:
                self.data.density = calculate_exponential_density(
                    v_middle, v_0, rho_0
                )

            elif dtype == &quot;power_law&quot;:
                exponent = self.input_exp.value
                self.data.density = calculate_power_law_density(
                    v_middle, v_0, rho_0, exponent
                )

        self.read_density()
        self.update_density_plot()</div>


<div class="viewcode-block" id="DensityEditor.display">
<a class="viewcode-back" href="../../../../api/tardis.visualization.widgets.custom_abundance.html#tardis.visualization.widgets.custom_abundance.DensityEditor.display">[docs]</a>
    def display(self):
        &quot;&quot;&quot;Display the GUI.

        Returns
        -------
        ipywidgets.widgets.widget_box.VBox
            A box that contains all the widgets in the GUI.
        &quot;&quot;&quot;
        hint1 = ipw.HTML(
            value=&quot;&lt;font size=&#39;3&#39;&gt;1) Edit density of the selected shell:&lt;/font&gt;&quot;
        )
        hint2 = ipw.HTML(
            value=&quot;&lt;font size=&#39;3&#39;&gt;2) Edit densities for all shells:&lt;/font&gt;&quot;
        )
        d_box = ipw.HBox(
            [self.input_d, ipw.Label(value=&quot;g/cm^3&quot;)],
            layout=ipw.Layout(margin=&quot;0 0 20px 0&quot;),
        )
        return ipw.VBox(
            [
                self.input_d_time_0,
                hint1,
                d_box,
                hint2,
                self.dpd_dtype,
                self.dtype_out,
                self.btn_calculate,
            ]
        )</div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 12 Oct 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>