

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-53HJHD1BWS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-53HJHD1BWS');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spectrum Generation with Virtual Packets &mdash; tardis</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />

  
    <link rel="shortcut icon" href="../../_static/tardis_logo.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.13/dist/embed-amd.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Spectrum Generation with the Formal Integral" href="formal_integral.html" />
    <link rel="prev" title="Basic Spectrum Generation" href="basic.html" />
    <link href="../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            tardis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Input/Output</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../io/hdf/index.html">Hierarchical Data Format (HDF5)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/configuration/index.html">Configuration (Required Input)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/model/index.html">Reading Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/output/index.html">Additional Outputs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analyzing Tardis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../analyzing_tardis/visualization/index.html">Visualization Tools &amp; Widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzing_tardis/spectrum/index.html">Analyzing TARDIS Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzing_tardis/liv_plot_notebook.html">Analyzing Last Interaction Velocity (LIV) Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzing_tardis/rpacket_plot_notebook.html">Analysing Montecarlo Packets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzing_tardis/analysing_convergence_plot.html">Convergence Plots</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/index.html">Physics Walkthrough Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../update_and_conv/update_and_conv.html">Updating Plasma and Convergence</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Spectrum Generation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic.html">Basic Spectrum Generation</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Spectrum Generation with Virtual Packets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id4">Virtual Packets</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#virtual-packet-procedure">Virtual Packet Procedure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#interpretation">Interpretation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="formal_integral.html">Spectrum Generation with the Formal Integral</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tardisgamma/index.html">TARDIS-High Energy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/tools/index.html">Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/in_progress/index.html">Features In-Progress</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../resources/credits.html">Credits &amp; Publication Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/code_comparison/index.html">Code Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/zreferences.html">References and Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Spectrum Generation</a></li>
      <li class="breadcrumb-item active">Spectrum Generation with Virtual Packets</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/physics/spectrum/virtualpackets.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="spectrum-generation-with-virtual-packets">
<span id="virtual-packets"></span><h1>Spectrum Generation with Virtual Packets<a class="headerlink" href="#spectrum-generation-with-virtual-packets" title="Link to this heading">¶</a></h1>
<p>The main purpose of TARDIS is the generation of synthetic spectra. Currently,
two methods are implemented to calculate the spectrum during the main Monte
Carlo calculation. One follows the obvious approach of recording the properties
of all escaping Monte Carlo packets and binning their contributions in
frequency (or wavelength) space. This “real packet” spectrum will naturally
suffer from Monte Carlo noise, and if one tries to improve its signal-to-noise
ratio, one immediately encounters a fundamental characteristic of Monte Carlo
approaches. Since Monte Carlo processes are typically governed by Poisson
statistics, the level of stochastic fluctuations decreases only as <span class="math notranslate nohighlight">\(\propto
N^{-\frac{1}{2}}\)</span>, with <span class="math notranslate nohighlight">\(N\)</span> denoting the number of Monte Carlo
experiments. Thus, to decrease the noise by an order of magnitude, 100 times
more experiments have to be performed. In the case of the real packet spectrum,
this translates into using 100 times more packets, which would increase the
runtime by about the same factor.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>More details about Monte Carlo errors and noise behaviour may be found in
the standard literature, for example in <span id="id1">[<a class="reference internal" href="../../resources/zreferences.html#id5" title="M. H. Kalos and P. A. Whitlock. Monte Carlo Methods: Second Revised and Enlarged Edition. Wiley-VCH Verlag, 2008.">KalosWhitlock08</a>]</span>.</p>
</div>
<p>It is difficult to avoid this fundamental behaviour of Monte Carlo techniques.
However, sophisticated Monte Carlo techniques exist, which make better use of
the computational resources. One such approach, which achieves a better noise
behaviour for the same computational costs, is implemented in TARDIS. It relies
on the concept of so-called “virtual packets” and goes back to the works by
<span id="id2">[<a class="reference internal" href="../../resources/zreferences.html#id7" title="K. S. Long and C. Knigge. Modeling the Spectral Signatures of Accretion Disk Winds: A New Monte Carlo Approach. Astrophysical Journal, 579:725-740, November 2002. arXiv:arXiv:astro-ph/0208011, doi:10.1086/342879.">LongKnigge02</a>]</span> and <span id="id3">[<a class="reference internal" href="../../resources/zreferences.html#id16" title="S. A. Sim, D. Proga, L. Miller, K. S. Long, and T. J. Turner. Multidimensional modelling of X-ray spectra for AGN accretion disc outflows - III. Application to a hydrodynamical simulation. Monthly Notices of the RAS, 408:1396-1408, November 2010. arXiv:1006.3449, doi:10.1111/j.1365-2966.2010.17215.x.">SimProgaMiller+10</a>]</span>.</p>
<section id="id4">
<h2>Virtual Packets<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h2>
<p>The virtual packet scheme is best explained by first detailing how it works and
then illustrating the physical reasoning for introducing this scheme. More
information about this scheme may be found in <span id="id5">[<a class="reference internal" href="../../resources/zreferences.html#id6" title="W. E. Kerzendorf and S. A. Sim. A spectral synthesis code for rapid modelling of supernovae. Monthly Notices of the RAS, 440:387-404, May 2014. arXiv:1401.5469, doi:10.1093/mnras/stu055.">KerzendorfSim14</a>]</span>.</p>
<section id="virtual-packet-procedure">
<h3>Virtual Packet Procedure<a class="headerlink" href="#virtual-packet-procedure" title="Link to this heading">¶</a></h3>
<p>In the virtual packet scheme, a new population of Monte Carlo packets is
introduced. Every time a real packet is launched or performs a physical
interaction, a pre-defined number of virtual packets, <span class="math notranslate nohighlight">\(N_v\)</span>, are
generated. These propagation of these “virtual packets” is followed in a
similar fashion to the real ones with the important distinction that their
trajectory is never changed. However, the optical depth the virtual packet
accumulates during its propagation to the ejecta surface due to electron
scattering and atomic line interactions is tracked. Once the virtual packet
escapes, its contribution to the spectrum is then weighted by this total
optical depth. In particular, it contributes with the</p>
<div class="math notranslate nohighlight">
\[\Delta L_{\nu} = \varepsilon_{\nu} \exp(-\tau) \frac{1}{\Delta t \Delta \nu}\]</div>
<p>to the emergent luminosity in the frequency interval <span class="math notranslate nohighlight">\([\nu, \nu + \Delta
\nu]\)</span>. Here, <span class="math notranslate nohighlight">\(\Delta t\)</span> denotes the physical duration of the simulation
step (the same duration which is used during the initialization process at the
photosphere, see <a class="reference internal" href="../montecarlo/propagation.html#propagation"><span class="std std-ref">Propagation</span></a>), and <span class="math notranslate nohighlight">\(\varepsilon\)</span> is
the energy of the virtual packet when it was generated.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>TARDIS is a time-independent radiative transfer scheme. Thus, <span class="math notranslate nohighlight">\(\Delta
t\)</span> should be interpreted as the physical duration of the emission process
at the photosphere.</p>
</div>
<p>The initialization process for virtual packets is slightly different from real
ones. For example, whenever a real packet is emitted by the photosphere,
<span class="math notranslate nohighlight">\(N_v\)</span> virtual packets are spawned, as well. The propagation direction of
these virtual packets is assigned uniformly. However, since <span class="math notranslate nohighlight">\(N_v\)</span> is
typically small, an unequal sampling of the solid angle is avoided by selecting
<span class="math notranslate nohighlight">\(N_v\)</span> equal <span class="math notranslate nohighlight">\(\mu\)</span> bins and sampling the direction uniformly within
these bins. Since the emitted radiation field has a different angular
dependence (represented by the non-uniform sampling rule for real packets,
<span class="math notranslate nohighlight">\(\mu = \sqrt{z}\)</span>), the energy of each virtual packet is weighted accordingly</p>
<div class="math notranslate nohighlight">
\[\varepsilon_v = \varepsilon \frac{2 \mu}{N_v}.\]</div>
<p>Here, <span class="math notranslate nohighlight">\(\varepsilon\)</span> is the energy of the real packet that spawned the
virtual ones. If virtual packets are generated during a real packet interaction
at the location <span class="math notranslate nohighlight">\(r\)</span>, their propagation direction is sampled uniformly
from the interval <span class="math notranslate nohighlight">\([\mu_{\mathrm{min}}, 1]\)</span>.</p>
<div class="math notranslate nohighlight">
\[\mu_{\mathrm{min}} = - \sqrt{1 - \left(\frac{R_{\mathrm{phot}}}{r}\right)^2}\]</div>
<p>Setting this lower limit avoids virtual packet trajectories intercepting the
photosphere at <span class="math notranslate nohighlight">\(R_{\mathrm{phot}}\)</span> (in which case the virtual packet
could not contribute to the emergent spectrum and computational resources would
have been wasted on this packet). The amount of radiation being backscattered
towards the photosphere is accounted for by modifying the energy of the virtual
packets</p>
<div class="math notranslate nohighlight">
\[\varepsilon_v = \varepsilon \frac{1 - \mu_{\mathrm{min}}}{2 N_v}.\]</div>
</section>
<section id="interpretation">
<h3>Interpretation<a class="headerlink" href="#interpretation" title="Link to this heading">¶</a></h3>
<p>The basic idea underlying the virtual packet scheme may be illustrated by
considering the formal solution of the time-independent radiative transfer
problem :</p>
<div class="math notranslate nohighlight">
\[I(R, \mu, \nu) = I(R_{\mathrm{phot}}, \mu, \nu) \exp(-\tau(s_0)) +
\int_0^{s_0} \eta(R - \mu s, \mu, \nu) \exp(-\tau(s)) \mathrm{d}s\]</div>
<p>This formulation of the formal solution is valid for the supernova ejecta problem and
involves the location of the photosphere, the radius of the ejecta surface
<span class="math notranslate nohighlight">\(R\)</span> and the packet trajectory <span class="math notranslate nohighlight">\(s\)</span>. Here, the optical depth
<span class="math notranslate nohighlight">\(\tau(s)\)</span> measures the optical depth from <span class="math notranslate nohighlight">\(s\)</span> to the ejecta surface.
For more details see <a class="reference internal" href="../montecarlo/basicprinciples.html#montecarlo-basics"><span class="std std-ref">Monte Carlo Radiative Transfer - Basic Principles</span></a>.</p>
<p>Essentially, the virtual packets solve this formal solution equation along a
large number of directional rays. In particular, the virtual packets spawned at
the photosphere solve the first part of the formal solution, namely by
determining which fraction of the photospheric radiation field remains at the
surface of the ejecta. The virtual packets which are generated whenever a real
packet interacts, account for the second part of the formal solution. In this
interpretation, the purpose of the real packet population is simply to “sample”
the emissivity of the medium.</p>
<p>This outline of the virtual packet scheme is concluded with a remark about its
benefits. The advantages of using a combination of real and virtual packets
compared to calculation based purely on real packets lies in lower
computational costs which are associated with solving the propagation of
virtual packets. These always propagate along a straight line, whereas real
packets may be deflected multiple times, thus making the determination of the
entire propagation path more expensive.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="basic.html" class="btn btn-neutral float-left" title="Basic Spectrum Generation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="formal_integral.html" class="btn btn-neutral float-right" title="Spectrum Generation with the Formal Integral" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 19 May 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>