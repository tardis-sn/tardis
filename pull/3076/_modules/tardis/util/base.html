

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-53HJHD1BWS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-53HJHD1BWS');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tardis.util.base &mdash; tardis</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />

  
    <link rel="shortcut icon" href="../../../_static/tardis_logo.ico"/>
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.13/dist/embed-amd.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href="../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            tardis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Input/Output</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../io/hdf/index.html">Hierarchical Data Format (HDF5)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/configuration/index.html">Configuration (Required Input)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/model/index.html">Reading Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io/output/index.html">Additional Outputs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analyzing Tardis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../analyzing_tardis/visualization/index.html">Visualization Tools &amp; Widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../analyzing_tardis/spectrum/index.html">Analyzing TARDIS Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../analyzing_tardis/liv_plot_notebook.html">Analyzing Last Interaction Velocity (LIV) Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../analyzing_tardis/rpacket_plot_notebook.html">Analysing Montecarlo Packets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../analyzing_tardis/analysing_convergence_plot.html">Convergence Plots</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/intro/index.html">Physics Walkthrough Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/update_and_conv/update_and_conv.html">Updating Plasma and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/spectrum/index.html">Spectrum Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../physics/tardisgamma/index.html">TARDIS-High Energy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/tools/index.html">Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/in_progress/index.html">Features In-Progress</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/credits.html">Credits &amp; Publication Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/code_comparison/index.html">Code Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../resources/zreferences.html">References and Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tardis.util.base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tardis.util.base</h1><div class="highlight"><pre>
<span></span>import functools
import logging
import os
import re
import warnings
from collections import OrderedDict

import numexpr as ne
import numpy as np
import pandas as pd
import tqdm
import tqdm.notebook
import yaml
from astropy import units as u
from IPython import display, get_ipython
from radioactivedecay import DEFAULTDATA
from radioactivedecay.utils import Z_DICT, parse_nuclide

import tardis
from tardis import constants
from tardis.io.util import get_internal_data_path

k_B_cgs = constants.k_B.cgs.value
c_cgs = constants.c.cgs.value
h_cgs = constants.h.cgs.value
m_e_cgs = constants.m_e.cgs.value
e_charge_gauss = constants.e.gauss.value

logger = logging.getLogger(__name__)
tardis_dir = os.path.realpath(tardis.__path__[0])

ATOMIC_SYMBOLS_DATA = (
    pd.read_csv(
        get_internal_data_path(&quot;atomic_symbols.dat&quot;),
        # The argument `delim_whitespace` was changed to `sep`
        #   because the first one is deprecated since version 2.2.0.
        #   The regular expression means: the separation is one or
        #   more spaces together (simple space, tabs, new lines).
        sep=r&quot;\s+&quot;,
        names=[&quot;atomic_number&quot;, &quot;symbol&quot;],
    )
    .set_index(&quot;atomic_number&quot;)
    .squeeze()
)

ATOMIC_NUMBER2SYMBOL = OrderedDict(ATOMIC_SYMBOLS_DATA.to_dict())
SYMBOL2ATOMIC_NUMBER = OrderedDict(
    (y, x) for x, y in ATOMIC_NUMBER2SYMBOL.items()
)

synpp_default_yaml_fname = get_internal_data_path(&quot;synpp_default.yaml&quot;)


NUMERAL_MAP = tuple(
    zip(
        (1000, 900, 500, 400, 100, 90, 50, 40, 10, 9, 5, 4, 1),
        (&quot;M&quot;, &quot;CM&quot;, &quot;D&quot;, &quot;CD&quot;, &quot;C&quot;, &quot;XC&quot;, &quot;L&quot;, &quot;XL&quot;, &quot;X&quot;, &quot;IX&quot;, &quot;V&quot;, &quot;IV&quot;, &quot;I&quot;),
    )
)


<div class="viewcode-block" id="MalformedError">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.MalformedError">[docs]</a>
class MalformedError(Exception):
    pass</div>



<div class="viewcode-block" id="MalformedSpeciesError">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.MalformedSpeciesError">[docs]</a>
class MalformedSpeciesError(MalformedError):
    def __init__(self, malformed_element_symbol):
        self.malformed_element_symbol = malformed_element_symbol

    def __str__(self):
        return (
            &#39;Expecting a species notation (e.g. &quot;Si 2&quot;, &quot;Si II&quot;, &quot;Fe IV&quot;) &#39;
            f&quot;- supplied {self.malformed_element_symbol}&quot;
        )</div>



<div class="viewcode-block" id="MalformedElementSymbolError">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.MalformedElementSymbolError">[docs]</a>
class MalformedElementSymbolError(MalformedError):
    def __init__(self, malformed_element_symbol):
        self.malformed_element_symbol = malformed_element_symbol

    def __str__(self):
        return f&quot;Expecting an atomic symbol (e.g. Fe) - supplied {self.malformed_element_symbol}&quot;</div>



<div class="viewcode-block" id="MalformedQuantityError">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.MalformedQuantityError">[docs]</a>
class MalformedQuantityError(MalformedError):
    def __init__(self, malformed_quantity_string):
        self.malformed_quantity_string = malformed_quantity_string

    def __str__(self):
        return (
            f&#39;Expecting a quantity string(e.g. &quot;5 km/s&quot;) for keyword &#39;
            f&quot;- supplied {self.malformed_quantity_string}&quot;
        )</div>



<div class="viewcode-block" id="int_to_roman">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.int_to_roman">[docs]</a>
def int_to_roman(i):
    &quot;&quot;&quot;
    Convert an integer into its roman numeral representation.

    Parameters
    ----------
    i : int
        Integer to be converted into roman numerals

    Returns
    -------
    str
        Returns roman numeral representation of i in str format.
    &quot;&quot;&quot;
    result = []
    for integer, numeral in NUMERAL_MAP:
        count = i // integer
        result.append(numeral * count)
        i -= integer * count
    return &quot;&quot;.join(result)</div>



<div class="viewcode-block" id="roman_to_int">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.roman_to_int">[docs]</a>
def roman_to_int(roman_string):
    &quot;&quot;&quot;
    Convert a roman numeral into its corresponding integer.

    Parameters
    ----------
    roman_string : str
        Roman numeral to be converted into an integer

    Returns
    -------
    int
        Returns integer representation of roman_string
    &quot;&quot;&quot;
    NUMERALS_SET = set(list(zip(*NUMERAL_MAP))[1])
    roman_string = roman_string.upper()
    if len(set(roman_string.upper()) - NUMERALS_SET) != 0:
        raise ValueError(f&quot;{roman_string} does not seem to be a roman numeral&quot;)
    i = result = 0
    for integer, numeral in NUMERAL_MAP:
        while roman_string[i : i + len(numeral)] == numeral:
            result += integer
            i += len(numeral)
    if result &lt; 1:
        raise ValueError(f&quot;Can not interpret Roman Numeral {roman_string}&quot;)
    return result</div>



<div class="viewcode-block" id="calculate_luminosity">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.calculate_luminosity">[docs]</a>
def calculate_luminosity(
    spec_fname,
    distance,
    wavelength_column=0,
    wavelength_unit=u.angstrom,
    flux_column=1,
    flux_unit=u.Unit(&quot;erg / (Angstrom cm2 s)&quot;),
):
    &quot;&quot;&quot;
    Calculates luminosity of star.

    Parameters
    ----------
    spec_fname : file or str
        File or file name to be read
    distance : float
        Distance to star
    wavelength_column : int, optional(default = 0)
        Column index in which the wavelength is stored
    wavelength_unit : float, optional(default = u.angstrom)
        Dictates units used for calculating wavelength.
    flux_column : int, optional(default = 1)
        Column index in which the flux is stored
    flux_unit : str, optional(default = u.Unit(&#39;erg / (Angstrom cm2 s)&#39;)
        Dictates units used for flux

    Returns
    -------
    luminosity.value : float
        Returned luminosity value of star.
    wavelength.min() : float
        Minimum value of wavelength of light
    wavelength.max() : float
        Maximum value of wavelength of light
    &quot;&quot;&quot;
    # BAD STYLE change to parse quantity
    distance = u.Unit(distance)

    wavelength, flux = np.loadtxt(
        spec_fname, usecols=(wavelength_column, flux_column), unpack=True
    )

    flux_density = np.trapz(flux, wavelength) * (flux_unit * wavelength_unit)
    luminosity = (flux_density * 4 * np.pi * distance**2).to(&quot;erg/s&quot;)

    return luminosity.value, wavelength.min(), wavelength.max()</div>



<div class="viewcode-block" id="create_synpp_yaml">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.create_synpp_yaml">[docs]</a>
def create_synpp_yaml(radial1d_mdl, fname, shell_no=0, lines_db=None):
    &quot;&quot;&quot;
    Create a yaml file that is readable from syn++

    Parameters
    ----------
    radial1d_mdl : SimulationState
        Inputted object that will be read into YAML file
    fname : str
        File name for the synpp yaml
    shell_no : int, optional(default = 0)
        Number of shells
    lines_db : file, optional(default = None)

    Raises
    ------
    ValueError
        If the current dataset does not contain necessary reference files
    &quot;&quot;&quot;
    logger.warning(&quot;Currently only works with Si and a special setup&quot;)
    if radial1d_mdl.atom_data.synpp_refs is not None:
        raise ValueError(
            &quot;The current atom dataset does not contain the &quot;
            &quot;necessary reference files (please contact the authors)&quot;
        )

    radial1d_mdl.atom_data.synpp_refs[&quot;ref_log_tau&quot;] = -99.0
    for key, value in radial1d_mdl.atom_data.synpp_refs.iterrows():
        try:
            radial1d_mdl.atom_data.synpp_refs[&quot;ref_log_tau&quot;].loc[
                key
            ] = np.log10(
                radial1d_mdl.plasma.tau_sobolevs[0].loc[value[&quot;line_id&quot;]]
            )
        except KeyError:
            logger.debug(
                &quot;Synpp Ref does not have valid KEY for ref_log_tau in Radial1D Model&quot;
            )

    relevant_synpp_refs = radial1d_mdl.atom_data.synpp_refs[
        radial1d_mdl.atom_data.synpp_refs[&quot;ref_log_tau&quot;] &gt; -50
    ]

    with open(synpp_default_yaml_fname) as stream:
        yaml_reference = yaml.load(stream, Loader=yaml.CLoader)

    if lines_db is not None:
        yaml_reference[&quot;opacity&quot;][&quot;line_dir&quot;] = os.path.join(lines_db, &quot;lines&quot;)
        yaml_reference[&quot;opacity&quot;][&quot;line_dir&quot;] = os.path.join(
            lines_db, &quot;refs.dat&quot;
        )

    yaml_reference[&quot;output&quot;][&quot;min_wl&quot;] = float(
        radial1d_mdl.transport.spectrum.wavelength.to(&quot;angstrom&quot;).value.min()
    )
    yaml_reference[&quot;output&quot;][&quot;max_wl&quot;] = float(
        radial1d_mdl.transport.spectrum.wavelength.to(&quot;angstrom&quot;).value.max()
    )

    # raise Exception(&quot;there&#39;s a problem here with units what units does synpp expect?&quot;)
    yaml_reference[&quot;opacity&quot;][&quot;v_ref&quot;] = float(
        (
            radial1d_mdl.tardis_config.structure.v_inner[0].to(&quot;km/s&quot;)
            / (1000.0 * u.km / u.s)
        ).value
    )
    yaml_reference[&quot;grid&quot;][&quot;v_outer_max&quot;] = float(
        (
            radial1d_mdl.tardis_config.structure.v_outer[-1].to(&quot;km/s&quot;)
            / (1000.0 * u.km / u.s)
        ).value
    )

    # pdb.set_trace()

    yaml_setup = yaml_reference[&quot;setups&quot;][0]
    yaml_setup[&quot;ions&quot;] = []
    yaml_setup[&quot;log_tau&quot;] = []
    yaml_setup[&quot;active&quot;] = []
    yaml_setup[&quot;temp&quot;] = []
    yaml_setup[&quot;v_min&quot;] = []
    yaml_setup[&quot;v_max&quot;] = []
    yaml_setup[&quot;aux&quot;] = []

    for species, synpp_ref in relevant_synpp_refs.iterrows():
        yaml_setup[&quot;ions&quot;].append(100 * species[0] + species[1])
        yaml_setup[&quot;log_tau&quot;].append(float(synpp_ref[&quot;ref_log_tau&quot;]))
        yaml_setup[&quot;active&quot;].append(True)
        yaml_setup[&quot;temp&quot;].append(yaml_setup[&quot;t_phot&quot;])
        yaml_setup[&quot;v_min&quot;].append(yaml_reference[&quot;opacity&quot;][&quot;v_ref&quot;])
        yaml_setup[&quot;v_max&quot;].append(yaml_reference[&quot;grid&quot;][&quot;v_outer_max&quot;])
        yaml_setup[&quot;aux&quot;].append(1e200)

    with open(fname, &quot;w&quot;) as f:
        yaml.dump(yaml_reference, stream=f, explicit_start=True)</div>



<div class="viewcode-block" id="intensity_black_body">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.intensity_black_body">[docs]</a>
def intensity_black_body(nu, temperature):
    &quot;&quot;&quot;
    Calculate the intensity of a black-body according to the following formula

    .. math::
        I(\\nu, temperature) = \\frac{2h\\nu^3}{c^2}\\frac{1}
        {e^{h\\nu \\beta_\\textrm{rad}} - 1}

    Parameters
    ----------
    nu : float
        Frequency of light
    temperature : float
        Temperature in kelvin

    Returns
    -------
    Intensity : float
        Returns the intensity of the black body
    &quot;&quot;&quot;
    beta_rad = 1 / (k_B_cgs * temperature)
    coefficient = 2 * h_cgs / c_cgs**2
    intensity = ne.evaluate(
        &quot;coefficient * nu**3 / &quot; &quot;(exp(h_cgs * nu * beta_rad) -1 )&quot;
    )
    return intensity</div>



<div class="viewcode-block" id="species_tuple_to_string">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.species_tuple_to_string">[docs]</a>
def species_tuple_to_string(species_tuple, roman_numerals=True):
    &quot;&quot;&quot;
    Convert a species tuple to its corresponding string representation.

    Parameters
    ----------
    species_tuple : tuple
        Tuple of 2 values indicated atomic number and number of
        electrons missing
    roman_numerals : bool, optional(default = TRUE)
        Indicates whether the returned ion number is in roman numerals

    Returns
    -------
    element_symbol, roman_ion_number : str
        Returns corresponding string representation of given tuple
    &quot;&quot;&quot;
    atomic_number, ion_number = species_tuple
    element_symbol = ATOMIC_NUMBER2SYMBOL[atomic_number]
    if roman_numerals:
        roman_ion_number = int_to_roman(ion_number + 1)
        return f&quot;{str(element_symbol)} {roman_ion_number}&quot;
    else:
        return f&quot;{element_symbol} {ion_number:d}&quot;</div>



<div class="viewcode-block" id="species_string_to_tuple">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.species_string_to_tuple">[docs]</a>
def species_string_to_tuple(species_string):
    &quot;&quot;&quot;
    Convert a species string to its corresponding tuple representation

    Parameters
    ----------
    species_string : str
        String containing species symbol (e.g. Si II, Fe III)

    Returns
    -------
    atomic_number, ion_number : tuple
        Returns tuple of length 2 indicating atomic number and ion number

    Raises
    ------
    MalformedSpeciesError
        If the inputted string does not match the species format
    &quot;&quot;&quot;
    try:
        element_symbol, ion_number_string = re.match(
            r&quot;^(\w+)\s*(\d+)&quot;, species_string
        ).groups()
    except AttributeError:
        try:
            element_symbol, ion_number_string = species_string.split()
        except ValueError:
            raise MalformedSpeciesError(
                f&#39;Species string &quot;{species_string}&quot; is not of format &lt;element_symbol&gt;&lt;number&gt;&#39;
                f&quot; (e.g. Fe 2, Fe2, ..)&quot;
            )

    atomic_number = element_symbol2atomic_number(element_symbol)

    try:
        ion_number = roman_to_int(ion_number_string)
    except ValueError:
        logger.debug(
            &quot;Ion Number does not contain a Roman Numeral. Checking for integer value&quot;
        )
        try:
            ion_number = int(ion_number_string)
        except ValueError:
            raise MalformedSpeciesError(
                f&quot;Given ion number (&#39;{ion_number_string}&#39;) could not be parsed&quot;
            )

    if ion_number - 1 &gt; atomic_number:
        raise ValueError(
            &quot;Species given does not exist: ion number &gt; atomic number&quot;
        )

    return atomic_number, ion_number - 1</div>



<div class="viewcode-block" id="parse_quantity">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.parse_quantity">[docs]</a>
def parse_quantity(quantity_string):
    &quot;&quot;&quot;
    Changes a string into it&#39;s corresponding astropy.Quantity object.

    Parameters
    ----------
    quantity_string : str
        String to be converted into astropy.Quantity

    Returns
    -------
    q : u.Quantity
        Corresponding astropy.Quantity object for passed string

    Raises
    ------
    MalformedQuantityError
        If string is not properly formatted for Astropy Quantity
    &quot;&quot;&quot;
    if not isinstance(quantity_string, str):
        raise MalformedQuantityError(quantity_string)

    try:
        value_string, unit_string = quantity_string.split()
    except ValueError:
        raise MalformedQuantityError(quantity_string)

    try:
        value = float(value_string)
    except ValueError:
        raise MalformedQuantityError(quantity_string)

    try:
        q = u.Quantity(value, unit_string)
    except ValueError:
        raise MalformedQuantityError(quantity_string)

    return q</div>



<div class="viewcode-block" id="element_symbol2atomic_number">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.element_symbol2atomic_number">[docs]</a>
def element_symbol2atomic_number(element_string):
    &quot;&quot;&quot;
    Takes an element symbol and returns its corresponding atomic number

    Parameters
    ----------
    element_string : str
        Inputted element symbol

    Returns
    -------
    int
        Returned atomic number
    &quot;&quot;&quot;
    reformatted_element_string = reformat_element_symbol(element_string)
    if reformatted_element_string not in SYMBOL2ATOMIC_NUMBER:
        raise MalformedElementSymbolError(element_string)
    return SYMBOL2ATOMIC_NUMBER[reformatted_element_string]</div>



<div class="viewcode-block" id="atomic_number2element_symbol">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.atomic_number2element_symbol">[docs]</a>
def atomic_number2element_symbol(atomic_number):
    &quot;&quot;&quot;
    Convert atomic number to string

    Parameters
    ----------
    atomic_number : int
        Inputted atomic number

    Returns
    -------
    str
       Returned corresponding element symbol
    &quot;&quot;&quot;
    return ATOMIC_NUMBER2SYMBOL[atomic_number]</div>



<div class="viewcode-block" id="reformat_element_symbol">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.reformat_element_symbol">[docs]</a>
def reformat_element_symbol(element_string):
    &quot;&quot;&quot;
    Reformat the string so the first letter is uppercase and all subsequent
     letters lowercase.

    Parameters
    ----------
    element_string : str
        Inputted element symbol

    Returns
    -------
    str
        Returned reformatted element symbol
    &quot;&quot;&quot;
    return element_string[0].upper() + element_string[1:].lower()</div>



<div class="viewcode-block" id="is_valid_nuclide_or_elem">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.is_valid_nuclide_or_elem">[docs]</a>
def is_valid_nuclide_or_elem(input_nuclide):
    &quot;&quot;&quot;
    Parses nuclide string into symbol - mass number format and returns
    whether the nuclide is either contained in the decay dataset or is a
    raw element string.

    Parameters
    ----------
    input_nuclide : str or int
        Nuclide name string or element string.

    Returns
    -------
    bool
        Bool indicating if the input nuclide is contained in the decay dataset
        or is a valid element.
    &quot;&quot;&quot;
    try:
        parse_nuclide(input_nuclide, DEFAULTDATA.nuclides, &quot;ICRP-107&quot;)
        is_nuclide = True
    except:
        is_nuclide = input_nuclide in Z_DICT.values()

    return is_nuclide</div>



<div class="viewcode-block" id="quantity_linspace">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.quantity_linspace">[docs]</a>
def quantity_linspace(start, stop, num, **kwargs):
    &quot;&quot;&quot;
    Essentially the same input parameters as linspace, but
    calculated for an astropy quantity start and stop.

    Parameters
    ----------
    start : astropy.Quantity
        Starting value of the sequence
    stop : astropy.Quantity
        End value of the sequence
    num : int
        Number of samples to generate

    Returns
    -------
    astropy.Quantity
        Returns num evenly spaced characters of type astropy.Quantity

    Raises
    ------
    ValueError
        If start and stop values have no unit attribute.
    &quot;&quot;&quot;
    if not (hasattr(start, &quot;unit&quot;) and hasattr(stop, &quot;unit&quot;)):
        raise ValueError(
            &quot;Both start and stop need to be quantities with a &quot; &quot;unit attribute&quot;
        )

    return (
        np.linspace(start.value, stop.to(start.unit).value, num, **kwargs)
        * start.unit
    )</div>



<div class="viewcode-block" id="convert_abundances_format">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.convert_abundances_format">[docs]</a>
def convert_abundances_format(fname, delimiter=r&quot;\s+&quot;):
    &quot;&quot;&quot;
    Changes format of file containing abundances into data frame

    Parameters
    ----------
    fname : file, str
        File or file name that contains abundance info
    delimiter : str, optional(default = &#39;\\s+&#39;)
        Determines the separator for splitting file

    Returns
    -------
    DataFrame
        Corresponding data frame
    &quot;&quot;&quot;
    df = pd.read_csv(fname, delimiter=delimiter, comment=&quot;#&quot;, header=None)
    # Drop shell index column
    df = df.drop(df.columns[0], axis=1)
    # Assign header row
    df.columns = [Z_DICT[i] for i in range(1, df.shape[1] + 1)]
    return df</div>



<div class="viewcode-block" id="is_notebook">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.is_notebook">[docs]</a>
def is_notebook():
    &quot;&quot;&quot;
    Checking the shell environment where the simulation is run is Jupyter based

    Returns
    -------
    True : if the shell environment is IPython Based
    False : if the shell environment is Terminal or anything else
    &quot;&quot;&quot;
    try:
        # Trying to import the ZMQInteractiveShell for Jupyter based environments
        from ipykernel.zmqshell import ZMQInteractiveShell
    except NameError:
        logger.debug(
            &quot;Cannot Import ipykernel.zmqshell. Not present inside Jupyter Environment&quot;
        )
        # If the class cannot be imported then we are automatically return False Value
        # Raised due to Name Error with the imported Class
        return False

    try:
        # Trying to import Interactive Terminal based IPython shell
        from IPython.core.interactiveshell import InteractiveShell
    except NameError:
        logger.debug(
            &quot;Cannot Import IPython.core.interactiveshell. Not present in IPython shell&quot;
        )
        # If the class cannot be imported then we are automatically return False Value
        # Raised due to Name Error with the imported Class
        return False

    try:
        # Trying to get the value of the shell via the get_ipython() method
        shell = get_ipython()
    except NameError:
        logger.debug(&quot;Cannot infer Shell Id&quot;)
        # Returns False if the shell name cannot be inferred correctly
        return False

    # Checking if the shell instance is Jupyter based &amp; if True, returning True
    if isinstance(shell, ZMQInteractiveShell):
        return True
    # Checking if the shell instance is Terminal IPython based &amp; if True, returning False
    elif isinstance(shell, InteractiveShell):
        return False
    # All other shell instances are returned False
    else:
        return False</div>



if is_notebook():
    iterations_pbar = tqdm.notebook.tqdm(
        desc=&quot;Iterations:&quot;,
        bar_format=&quot;{desc:&lt;}{bar}{n_fmt}/{total_fmt} [{elapsed}&lt;{remaining}, {rate_fmt}]&quot;,
    )
    iterations_pbar.container.close()
    packet_pbar = tqdm.notebook.tqdm(
        desc=&quot;Packets:   &quot;,
        postfix=&quot;0&quot;,
        bar_format=&quot;{desc:&lt;}{bar}{n_fmt}/{total_fmt} [{elapsed}&lt;{remaining}, {rate_fmt}]&quot;,
    )
    packet_pbar.container.close()

else:
    iterations_pbar = tqdm.tqdm(
        desc=&quot;Iterations:&quot;,
        bar_format=&quot;{desc:&lt;}{bar:80}{n_fmt}/{total_fmt} [{elapsed}&lt;{remaining}, {rate_fmt}]&quot;,
    )
    packet_pbar = tqdm.tqdm(
        desc=&quot;Packets:   &quot;,
        postfix=&quot;0&quot;,
        bar_format=&quot;{desc:&lt;}{bar:80}{n_fmt}/{total_fmt} [{elapsed}&lt;{remaining}, {rate_fmt}]&quot;,
    )


<div class="viewcode-block" id="update_packet_pbar">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.update_packet_pbar">[docs]</a>
def update_packet_pbar(i, current_iteration, no_of_packets, total_iterations):
    &quot;&quot;&quot;
    Update progress bars as each packet is propagated.

    Parameters
    ----------
    i : int
        Amount by which the progress bar needs to be updated.
    current_iteration : int
        Current iteration number.
    no_of_packets : int
        Total number of packets in one iteration.
    total_iterations : int
        Total number of iterations.
    &quot;&quot;&quot;
    if packet_pbar.postfix == &quot;&quot;:
        packet_pbar.postfix = &quot;0&quot;
    bar_iteration = int(packet_pbar.postfix) - 1

    # fix bar layout when run_tardis is called for the first time
    if iterations_pbar.total == None:
        fix_bar_layout(iterations_pbar, total_iterations=total_iterations)
    if packet_pbar.total == None:
        fix_bar_layout(packet_pbar, no_of_packets=no_of_packets)

    # display and reset progress bar when run_tardis is called again
    if iterations_pbar.n == total_iterations:
        if type(iterations_pbar).__name__ == &quot;tqdm_notebook&quot;:
            iterations_pbar.container.close()
        fix_bar_layout(iterations_pbar, total_iterations=total_iterations)

    if bar_iteration &gt; current_iteration:
        packet_pbar.postfix = current_iteration
        if type(packet_pbar).__name__ == &quot;tqdm_notebook&quot;:
            # stop displaying last container
            packet_pbar.container.close()
        fix_bar_layout(packet_pbar, no_of_packets=no_of_packets)

    # reset progress bar with each iteration
    if bar_iteration &lt; current_iteration:
        packet_pbar.reset(total=no_of_packets)
        packet_pbar.postfix = str(current_iteration + 1)

    packet_pbar.update(i)</div>



<div class="viewcode-block" id="refresh_packet_pbar">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.refresh_packet_pbar">[docs]</a>
def refresh_packet_pbar():
    &quot;&quot;&quot;
    Refresh packet progress bar after each iteration.

    &quot;&quot;&quot;
    packet_pbar.refresh()</div>



<div class="viewcode-block" id="update_iterations_pbar">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.update_iterations_pbar">[docs]</a>
def update_iterations_pbar(i):
    &quot;&quot;&quot;
    Update progress bar for each iteration.

    Parameters
    ----------
    i : int
        Amount by which the progress bar needs to be updated.
    &quot;&quot;&quot;
    iterations_pbar.update(i)</div>



<div class="viewcode-block" id="fix_bar_layout">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.fix_bar_layout">[docs]</a>
def fix_bar_layout(bar, no_of_packets=None, total_iterations=None):
    &quot;&quot;&quot;
    Fix the layout of progress bars.

    Parameters
    ----------
    bar : tqdm instance
        Progress bar to change the layout of.
    no_of_packets : int, optional
        Number of packets to be propagated.
    total_iterations : int, optional
        Total number of iterations.
    &quot;&quot;&quot;
    if type(bar).__name__ == &quot;tqdm_notebook&quot;:
        bar.container = bar.status_printer(
            bar.fp,
            bar.total,
            bar.desc,
            bar.ncols,
        )
        if no_of_packets is not None:
            bar.reset(total=no_of_packets)
        if total_iterations is not None:
            bar.reset(total=total_iterations)

        # change the amount of space the prefix string of the bar takes
        # here, either packets or iterations
        bar.container.children[0].layout.width = &quot;6%&quot;

        # change the length of the bar
        bar.container.children[1].layout.width = &quot;60%&quot;

        # display the progress bar
        display.display(bar.container)

    else:
        if no_of_packets is not None:
            bar.reset(total=no_of_packets)
        if total_iterations is not None:
            bar.reset(total=total_iterations)
        else:
            pass</div>



<div class="viewcode-block" id="deprecated">
<a class="viewcode-back" href="../../../api/tardis.util.base.html#tardis.util.base.deprecated">[docs]</a>
def deprecated(func):
    &quot;&quot;&quot;
    A decorator to add a deprecation warning to a function that is no longer used

    Parameters
    ----------
    func : function
    &quot;&quot;&quot;

    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        warnings.warn(&quot;This function is deprecated.&quot;, DeprecationWarning)
        return func(*args, **kwargs)

    return wrapper</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 19 May 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>