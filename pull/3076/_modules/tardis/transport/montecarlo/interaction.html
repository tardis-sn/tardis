

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-53HJHD1BWS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-53HJHD1BWS');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tardis.transport.montecarlo.interaction &mdash; tardis</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />

  
    <link rel="shortcut icon" href="../../../../_static/tardis_logo.ico"/>
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.13/dist/embed-amd.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            tardis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Input/Output</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/hdf/index.html">Hierarchical Data Format (HDF5)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/index.html">Configuration (Required Input)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/model/index.html">Reading Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/output/index.html">Additional Outputs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analyzing Tardis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/visualization/index.html">Visualization Tools &amp; Widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/spectrum/index.html">Analyzing TARDIS Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/liv_plot_notebook.html">Analyzing Last Interaction Velocity (LIV) Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/rpacket_plot_notebook.html">Analysing Montecarlo Packets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/analysing_convergence_plot.html">Convergence Plots</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/intro/index.html">Physics Walkthrough Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/update_and_conv/update_and_conv.html">Updating Plasma and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/spectrum/index.html">Spectrum Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/tardisgamma/index.html">TARDIS-High Energy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/tools/index.html">Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/in_progress/index.html">Features In-Progress</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/credits.html">Credits &amp; Publication Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/code_comparison/index.html">Code Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/zreferences.html">References and Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tardis.transport.montecarlo.interaction</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tardis.transport.montecarlo.interaction</h1><div class="highlight"><pre>
<span></span>import numpy as np
from numba import njit

import tardis.transport.montecarlo.configuration.montecarlo_globals as montecarlo_globals
from tardis import constants as const
from tardis.transport.frame_transformations import (
    angle_aberration_CMF_to_LF,
    get_doppler_factor,
    get_inverse_doppler_factor,
)
from tardis.transport.montecarlo import njit_dict_no_parallel
from tardis.transport.montecarlo.macro_atom import (
    MacroAtomTransitionType,
    macro_atom,
)
from tardis.transport.montecarlo.numba_interface import (
    LineInteractionType,
)
from tardis.transport.montecarlo.r_packet import (
    PacketStatus,
)
from tardis.transport.montecarlo.utils import get_random_mu

K_B = const.k_B.cgs.value
H = const.h.cgs.value


<div class="viewcode-block" id="determine_bf_macro_activation_idx">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.determine_bf_macro_activation_idx">[docs]</a>
@njit(**njit_dict_no_parallel)
def determine_bf_macro_activation_idx(
    opacity_state, nu, chi_bf_contributions, active_continua
):
    &quot;&quot;&quot;
    Determine the macro atom activation level after bound-free absorption.

    Parameters
    ----------
    nu : float
        Comoving frequency of the r-packet.
    chi_bf_contributions : numpy.ndarray, dtype float
        Cumulative distribution of bound-free opacities at frequency
        `nu`.
    active_continua : numpy.ndarray, dtype int
        Continuum ids for which absorption is possible for frequency `nu`.

    Returns
    -------
    float
        Macro atom activation idx.
    &quot;&quot;&quot;
    # Perform a MC experiment to determine the continuum for absorption
    index = np.searchsorted(chi_bf_contributions, np.random.random())
    continuum_id = active_continua[index]

    # Perform a MC experiment to determine whether thermal or
    # ionization energy is created
    nu_threshold = opacity_state.photo_ion_nu_threshold_mins[continuum_id]
    fraction_ionization = nu_threshold / nu
    if (
        np.random.random() &lt; fraction_ionization
    ):  # Create ionization energy (i-packet)
        destination_level_idx = opacity_state.photo_ion_activation_idx[
            continuum_id
        ]
    else:  # Create thermal energy (k-packet)
        destination_level_idx = opacity_state.k_packet_idx
    return destination_level_idx</div>



<div class="viewcode-block" id="determine_continuum_macro_activation_idx">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.determine_continuum_macro_activation_idx">[docs]</a>
@njit(**njit_dict_no_parallel)
def determine_continuum_macro_activation_idx(
    opacity_state, nu, chi_bf, chi_ff, chi_bf_contributions, active_continua
):
    &quot;&quot;&quot;
    Determine the macro atom activation level after a continuum absorption.

    Parameters
    ----------
    nu : float
        Comoving frequency of the r-packet.
    chi_bf : numpy.ndarray, dtype float
        Bound-free opacity.
    chi_bf : numpy.ndarray, dtype float
        Free-free opacity.
    chi_bf_contributions : numpy.ndarray, dtype float
        Cumulative distribution of bound-free opacities at frequency
        `nu`.
    active_continua : numpy.ndarray, dtype int
        Continuum ids for which absorption is possible for frequency `nu`.

    Returns
    -------
    float
        Macro atom activation idx.
    &quot;&quot;&quot;
    fraction_bf = chi_bf / (chi_bf + chi_ff)
    # TODO: In principle, we can also decide here whether a Thomson
    # scattering event happens and need one less RNG call.
    if np.random.random() &lt; fraction_bf:  # Bound-free absorption
        destination_level_idx = determine_bf_macro_activation_idx(
            opacity_state, nu, chi_bf_contributions, active_continua
        )
    else:  # Free-free absorption (i.e. k-packet creation)
        destination_level_idx = opacity_state.k_packet_idx
    return destination_level_idx</div>



<div class="viewcode-block" id="sample_nu_free_free">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.sample_nu_free_free">[docs]</a>
@njit(**njit_dict_no_parallel)
def sample_nu_free_free(opacity_state, shell):
    &quot;&quot;&quot;
    Attributes
    ----------
    nu_ff_sampler : float
        Frequency of the free-free emission process

    &quot;&quot;&quot;
    temperature = opacity_state.t_electrons[shell]
    zrand = np.random.random()
    return -K_B * temperature / H * np.log(zrand)</div>



<div class="viewcode-block" id="sample_nu_free_bound">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.sample_nu_free_bound">[docs]</a>
@njit(**njit_dict_no_parallel)
def sample_nu_free_bound(opacity_state, shell, continuum_id):
    &quot;&quot;&quot;
    Attributes
    ----------
    nu_fb_sampler : float
        Frequency of the free-bounds emission process
    &quot;&quot;&quot;
    start = opacity_state.photo_ion_block_references[continuum_id]
    end = opacity_state.photo_ion_block_references[continuum_id + 1]
    phot_nus_block = opacity_state.phot_nus[start:end]
    em = opacity_state.emissivities[start:end, shell]

    zrand = np.random.random()
    idx = np.searchsorted(em, zrand, side=&quot;right&quot;)

    return phot_nus_block[idx] - (em[idx] - zrand) / (em[idx] - em[idx - 1]) * (
        phot_nus_block[idx] - phot_nus_block[idx - 1]
    )</div>



<div class="viewcode-block" id="continuum_event">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.continuum_event">[docs]</a>
@njit(**njit_dict_no_parallel)
def continuum_event(
    r_packet,
    time_explosion,
    opacity_state,
    chi_bf_tot,
    chi_ff,
    chi_bf_contributions,
    current_continua,
    enable_full_relativity,
):
    &quot;&quot;&quot;
    continuum event handler - activate the macroatom and run the handler

    Parameters
    ----------
    r_packet : tardis.transport.montecarlo.r_packet.RPacket
    time_explosion : float
    opacity_state : tardis.transport.montecarlo.numba_interface.OpacityState
    continuum : tardis.transport.montecarlo.numba_interface.Continuum
    &quot;&quot;&quot;
    old_doppler_factor = get_doppler_factor(
        r_packet.r, r_packet.mu, time_explosion, enable_full_relativity
    )

    r_packet.mu = get_random_mu()
    inverse_doppler_factor = get_inverse_doppler_factor(
        r_packet.r, r_packet.mu, time_explosion, enable_full_relativity
    )
    comov_energy = r_packet.energy * old_doppler_factor
    comov_nu = (
        r_packet.nu * old_doppler_factor
    )  # make sure frequency should be updated
    r_packet.energy = comov_energy * inverse_doppler_factor
    r_packet.nu = comov_nu * inverse_doppler_factor

    destination_level_idx = determine_continuum_macro_activation_idx(
        opacity_state,
        comov_nu,
        chi_bf_tot,
        chi_ff,
        chi_bf_contributions,
        current_continua,
    )

    macro_atom_event(
        destination_level_idx,
        r_packet,
        time_explosion,
        opacity_state,
        enable_full_relativity,
    )</div>



<div class="viewcode-block" id="macro_atom_event">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.macro_atom_event">[docs]</a>
@njit(**njit_dict_no_parallel)
def macro_atom_event(
    destination_level_idx,
    r_packet,
    time_explosion,
    opacity_state,
    enable_full_relativity,
):
    &quot;&quot;&quot;
    Macroatom event handler - run the macroatom and handle the result

    Parameters
    ----------
    destination_level_idx : int
    r_packet : tardis.transport.montecarlo.r_packet.RPacket
    time_explosion : float
    opacity_state : tardis.transport.montecarlo.numba_interface.OpacityState
    &quot;&quot;&quot;
    transition_id, transition_type = macro_atom(
        destination_level_idx, r_packet.current_shell_id, opacity_state
    )

    if (
        montecarlo_globals.CONTINUUM_PROCESSES_ENABLED
        and transition_type == MacroAtomTransitionType.FF_EMISSION
    ):
        free_free_emission(
            r_packet, time_explosion, opacity_state, enable_full_relativity
        )

    elif (
        montecarlo_globals.CONTINUUM_PROCESSES_ENABLED
        and transition_type == MacroAtomTransitionType.BF_EMISSION
    ):
        bound_free_emission(
            r_packet,
            time_explosion,
            opacity_state,
            transition_id,
            enable_full_relativity,
        )
    elif (
        montecarlo_globals.CONTINUUM_PROCESSES_ENABLED
        and transition_type == MacroAtomTransitionType.BF_COOLING
    ):
        bf_cooling(
            r_packet, time_explosion, opacity_state, enable_full_relativity
        )

    elif (
        montecarlo_globals.CONTINUUM_PROCESSES_ENABLED
        and transition_type == MacroAtomTransitionType.ADIABATIC_COOLING
    ):
        adiabatic_cooling(r_packet)

    elif transition_type == MacroAtomTransitionType.BB_EMISSION:
        line_emission(
            r_packet,
            transition_id,
            time_explosion,
            opacity_state,
            enable_full_relativity,
        )
    else:
        raise Exception(&quot;No Interaction Found!&quot;)</div>



<div class="viewcode-block" id="bf_cooling">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.bf_cooling">[docs]</a>
@njit(**njit_dict_no_parallel)
def bf_cooling(r_packet, time_explosion, opacity_state, enable_full_relativity):
    &quot;&quot;&quot;
    Bound-Free Cooling - Determine and run bf emission from cooling

    Parameters
    ----------
    r_packet : tardis.transport.montecarlo.r_packet.RPacket
    time_explosion : float
    opacity_state : tardis.transport.montecarlo.numba_interface.OpacityState
    &quot;&quot;&quot;
    fb_cooling_prob = opacity_state.p_fb_deactivation[
        :, r_packet.current_shell_id
    ]
    p = fb_cooling_prob[0]
    i = 0
    zrand = np.random.random()
    while p &lt;= zrand:  # Can&#39;t search-sorted this because it&#39;s not cumulative
        i += 1
        p += fb_cooling_prob[i]
    continuum_idx = i
    bound_free_emission(
        r_packet,
        time_explosion,
        opacity_state,
        continuum_idx,
        enable_full_relativity,
    )</div>



<div class="viewcode-block" id="adiabatic_cooling">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.adiabatic_cooling">[docs]</a>
@njit(**njit_dict_no_parallel)
def adiabatic_cooling(r_packet):
    &quot;&quot;&quot;
    Adiabatic cooling - equivalent to destruction of the packet

    Parameters
    ----------
    r_packet: tardis.transport.montecarlo.r_packet.RPacket
    &quot;&quot;&quot;
    r_packet.status = PacketStatus.ADIABATIC_COOLING</div>



<div class="viewcode-block" id="get_current_line_id">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.get_current_line_id">[docs]</a>
@njit(**njit_dict_no_parallel)
def get_current_line_id(nu, line_list):
    &quot;&quot;&quot;
    Get the line id corresponding to a frequency nu in a line list

    Parameters
    ----------
    nu : float
    line_list : np.ndarray
    &quot;&quot;&quot;
    # Note: Since this reverses the array,
    # it may be faster to just write our own reverse-binary-search

    reverse_line_list = line_list[::-1]
    number_of_lines = len(line_list)
    line_id = number_of_lines - np.searchsorted(reverse_line_list, nu)
    return line_id</div>



<div class="viewcode-block" id="free_free_emission">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.free_free_emission">[docs]</a>
@njit(**njit_dict_no_parallel)
def free_free_emission(
    r_packet, time_explosion, opacity_state, enable_full_relativity
):
    &quot;&quot;&quot;
    Free-Free emission - set the frequency from electron-ion interaction

    Parameters
    ----------
    r_packet : tardis.transport.montecarlo.r_packet.RPacket
    time_explosion : float
    opacity_state : tardis.transport.montecarlo.numba_interface.OpacityState
    &quot;&quot;&quot;
    inverse_doppler_factor = get_inverse_doppler_factor(
        r_packet.r, r_packet.mu, time_explosion, enable_full_relativity
    )
    comov_nu = sample_nu_free_free(opacity_state, r_packet.current_shell_id)
    r_packet.nu = comov_nu * inverse_doppler_factor
    current_line_id = get_current_line_id(comov_nu, opacity_state.line_list_nu)
    r_packet.next_line_id = current_line_id

    if enable_full_relativity:
        r_packet.mu = angle_aberration_CMF_to_LF(
            r_packet, time_explosion, r_packet.mu
        )</div>



<div class="viewcode-block" id="bound_free_emission">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.bound_free_emission">[docs]</a>
@njit(**njit_dict_no_parallel)
def bound_free_emission(
    r_packet,
    time_explosion,
    opacity_state,
    continuum_id,
    enable_full_relativity,
):
    &quot;&quot;&quot;
    Bound-Free emission - set the frequency from photo-ionization

    Parameters
    ----------
    r_packet : tardis.transport.montecarlo.r_packet.RPacket
    time_explosion : float
    opacity_state : tardis.transport.montecarlo.numba_interface.OpacityState
    continuum_id : int
    &quot;&quot;&quot;
    inverse_doppler_factor = get_inverse_doppler_factor(
        r_packet.r, r_packet.mu, time_explosion, enable_full_relativity
    )

    comov_nu = sample_nu_free_bound(
        opacity_state, r_packet.current_shell_id, continuum_id
    )
    r_packet.nu = comov_nu * inverse_doppler_factor
    current_line_id = get_current_line_id(comov_nu, opacity_state.line_list_nu)
    r_packet.next_line_id = current_line_id

    if enable_full_relativity:
        r_packet.mu = angle_aberration_CMF_to_LF(
            r_packet, time_explosion, r_packet.mu
        )</div>



<div class="viewcode-block" id="thomson_scatter">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.thomson_scatter">[docs]</a>
@njit(**njit_dict_no_parallel)
def thomson_scatter(r_packet, time_explosion, enable_full_relativity):
    &quot;&quot;&quot;
    Thomson scattering â€” no longer line scattering
    \n1) get the doppler factor at that position with the old angle
    \n2) convert the current energy and nu into the comoving frame with the old mu
    \n3) Scatter and draw new mu - update mu
    \n4) Transform the comoving energy and nu back using the new mu

    Parameters
    ----------
    r_packet : tardis.transport.montecarlo.r_packet.RPacket
    time_explosion : float
        time since explosion in seconds
    &quot;&quot;&quot;
    old_doppler_factor = get_doppler_factor(
        r_packet.r, r_packet.mu, time_explosion, enable_full_relativity
    )
    comov_nu = r_packet.nu * old_doppler_factor
    comov_energy = r_packet.energy * old_doppler_factor
    r_packet.mu = get_random_mu()
    inverse_new_doppler_factor = get_inverse_doppler_factor(
        r_packet.r, r_packet.mu, time_explosion, enable_full_relativity
    )

    r_packet.nu = comov_nu * inverse_new_doppler_factor
    r_packet.energy = comov_energy * inverse_new_doppler_factor
    if enable_full_relativity:
        r_packet.mu = angle_aberration_CMF_to_LF(
            r_packet, time_explosion, r_packet.mu
        )
    temp_doppler_factor = get_doppler_factor(
        r_packet.r, r_packet.mu, time_explosion, enable_full_relativity
    )</div>



<div class="viewcode-block" id="line_scatter">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.line_scatter">[docs]</a>
@njit(**njit_dict_no_parallel)
def line_scatter(
    r_packet,
    time_explosion,
    line_interaction_type,
    opacity_state,
    enable_full_relativity,
):
    &quot;&quot;&quot;
    Line scatter function that handles the scattering itself, including new angle drawn, and calculating nu out using macro atom

    Parameters
    ----------
    r_packet : tardis.transport.montecarlo.r_packet.RPacket
    time_explosion : float
    line_interaction_type : enum
    opacity_state : tardis.transport.montecarlo.numba_interface.OpacityState
    &quot;&quot;&quot;
    old_doppler_factor = get_doppler_factor(
        r_packet.r, r_packet.mu, time_explosion, enable_full_relativity
    )
    r_packet.mu = get_random_mu()

    inverse_new_doppler_factor = get_inverse_doppler_factor(
        r_packet.r, r_packet.mu, time_explosion, enable_full_relativity
    )

    comov_energy = r_packet.energy * old_doppler_factor
    r_packet.energy = comov_energy * inverse_new_doppler_factor

    if line_interaction_type == LineInteractionType.SCATTER:
        line_emission(
            r_packet,
            r_packet.next_line_id,
            time_explosion,
            opacity_state,
            enable_full_relativity,
        )
    else:  # includes both macro atom and downbranch - encoded in the transition probabilities
        comov_nu = r_packet.nu * old_doppler_factor  # Is this necessary?
        r_packet.nu = comov_nu * inverse_new_doppler_factor
        activation_level_id = opacity_state.line2macro_level_upper[
            r_packet.next_line_id
        ]
        macro_atom_event(
            activation_level_id,
            r_packet,
            time_explosion,
            opacity_state,
            enable_full_relativity,
        )</div>



<div class="viewcode-block" id="line_emission">
<a class="viewcode-back" href="../../../../api/tardis.transport.montecarlo.interaction.html#tardis.transport.montecarlo.interaction.line_emission">[docs]</a>
@njit(**njit_dict_no_parallel)
def line_emission(
    r_packet,
    emission_line_id,
    time_explosion,
    opacity_state,
    enable_full_relativity,
):
    &quot;&quot;&quot;
    Sets the frequency of the RPacket properly given the emission channel

    Parameters
    ----------
    r_packet : tardis.transport.montecarlo.r_packet.RPacket
    emission_line_id : int
    time_explosion : float
    opacity_state : tardis.transport.montecarlo.numba_interface.OpacityState
    &quot;&quot;&quot;
    r_packet.last_line_interaction_out_id = emission_line_id
    r_packet.last_line_interaction_shell_id = r_packet.current_shell_id
    r_packet.last_interaction_in_r = r_packet.r

    if emission_line_id != r_packet.next_line_id:
        pass
    inverse_doppler_factor = get_inverse_doppler_factor(
        r_packet.r, r_packet.mu, time_explosion, enable_full_relativity
    )
    r_packet.nu = (
        opacity_state.line_list_nu[emission_line_id] * inverse_doppler_factor
    )
    r_packet.next_line_id = emission_line_id + 1
    nu_line = opacity_state.line_list_nu[emission_line_id]

    if enable_full_relativity:
        r_packet.mu = angle_aberration_CMF_to_LF(
            r_packet, time_explosion, r_packet.mu
        )</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 19 May 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>