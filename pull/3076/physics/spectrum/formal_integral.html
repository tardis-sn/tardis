

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-53HJHD1BWS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-53HJHD1BWS');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spectrum Generation with the Formal Integral &mdash; tardis</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />

  
    <link rel="shortcut icon" href="../../_static/tardis_logo.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.13/dist/embed-amd.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="TARDIS-High Energy" href="../tardisgamma/index.html" />
    <link rel="prev" title="Spectrum Generation with Virtual Packets" href="virtualpackets.html" />
    <link href="../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            tardis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Input/Output</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../io/hdf/index.html">Hierarchical Data Format (HDF5)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/configuration/index.html">Configuration (Required Input)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/model/index.html">Reading Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io/output/index.html">Additional Outputs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analyzing Tardis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../analyzing_tardis/visualization/index.html">Visualization Tools &amp; Widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzing_tardis/spectrum/index.html">Analyzing TARDIS Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzing_tardis/liv_plot_notebook.html">Analyzing Last Interaction Velocity (LIV) Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzing_tardis/rpacket_plot_notebook.html">Analysing Montecarlo Packets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzing_tardis/analysing_convergence_plot.html">Convergence Plots</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro/index.html">Physics Walkthrough Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../update_and_conv/update_and_conv.html">Updating Plasma and Convergence</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Spectrum Generation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic.html">Basic Spectrum Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="virtualpackets.html">Spectrum Generation with Virtual Packets</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Spectrum Generation with the Formal Integral</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#deriving-the-integral">Deriving the Integral</a></li>
<li class="toctree-l3"><a class="reference internal" href="#summary-of-implementation">Summary of Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#calculating-i-nu-p">Calculating <span class="math notranslate nohighlight">\(I_\nu(p)\)</span></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#setting-up">Setting Up</a></li>
<li class="toctree-l4"><a class="reference internal" href="#constructing-the-source-function">Constructing the Source Function</a></li>
<li class="toctree-l4"><a class="reference internal" href="#incrementing-the-intensity">Incrementing the Intensity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rays-intersecting-the-photosphere">Rays Intersecting the Photosphere</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#current-limitations">Current Limitations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tardisgamma/index.html">TARDIS-High Energy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/tools/index.html">Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/in_progress/index.html">Features In-Progress</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../resources/credits.html">Credits &amp; Publication Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/code_comparison/index.html">Code Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources/zreferences.html">References and Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Spectrum Generation</a></li>
      <li class="breadcrumb-item active">Spectrum Generation with the Formal Integral</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/physics/spectrum/formal_integral.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="spectrum-generation-with-the-formal-integral">
<span id="formal-integral"></span><h1>Spectrum Generation with the Formal Integral<a class="headerlink" href="#spectrum-generation-with-the-formal-integral" title="Link to this heading">¶</a></h1>
<p><span id="id1">[<a class="reference internal" href="../../resources/zreferences.html#id12" title="L. B. Lucy. Improved Monte Carlo techniques for the spectral synthesis of supernovae. Astronomy and Astrophysics, 345:211-220, May 1999.">Lucy99b</a>]</span> describes an alternative method for calculating the TARDIS spectrum while eliminating nearly all Monte Carlo noise. Instead of calculating the spectrum directly from the Monte Carlo (or virtual) packets, we use information from the Monte Carlo simulation to build an analytical solution for the supernova spectrum.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The current implementation of the formal integral has several limitations.
Please consult the corresponding section below to ensure that these
limitations do not apply to your TARDIS.</p>
</div>
<section id="deriving-the-integral">
<h2>Deriving the Integral<a class="headerlink" href="#deriving-the-integral" title="Link to this heading">¶</a></h2>
<p>The spectrum generated by TARDIS includes light that is released in all directions. However, we approximate the supernova as spherically symmetric, meaning the light is released isotropically (equally in all directions). Thus, it will suffice to calculate the spectrum of light propagating in a single direction, call it the positive z-direction, and then sum over every direction. Specifically, we have</p>
<div class="math notranslate nohighlight">
\[L_\nu = \int L_{\nu z} d\Omega = L_{\nu z} \int d\Omega = 4\pi L_{\nu z}\]</div>
<p>where <span class="math notranslate nohighlight">\(L_\nu\)</span> is the luminosity density at a frequency <span class="math notranslate nohighlight">\(\nu\)</span>, <span class="math notranslate nohighlight">\(L_{\nu z}\)</span> is the luminosity density at a frequency <span class="math notranslate nohighlight">\(\nu\)</span> for light propagating in the positive z-direction, and <span class="math notranslate nohighlight">\(\Omega\)</span> is the solid angle.</p>
<p>We now must calculate <span class="math notranslate nohighlight">\(L_{\nu z}\)</span>, starting with more symmetry considerations. The figures below show various rays of light (in black) coming out of the supernova at various values of <span class="math notranslate nohighlight">\(p\)</span>, the impact parameter (defined as the distance from the x-axis, and can be seen as the value along the blue <span class="math notranslate nohighlight">\(p\)</span>-axis). By symmetry, the intensity <span class="math notranslate nohighlight">\(I_\nu\)</span> (luminosity density per unit area) along the ray will be identical anywhere on the blue circles shown (each of which has a constant impact parameter). Each circle has a circumference of <span class="math notranslate nohighlight">\(2\pi p\)</span>. The luminosity density per unit distance on any given circle would then be <span class="math notranslate nohighlight">\(I_\nu(p)\times 2\pi p\)</span> (specifically, we are integrating the constant intensity around the circumference of the circle). Finally, to get <span class="math notranslate nohighlight">\(L_{\nu z}\)</span>, we must integrate <span class="math notranslate nohighlight">\(I_\nu(p)\times 2\pi p\)</span> over every possible impact parameter, whose values range from zero to the outer radius of the supernova, <span class="math notranslate nohighlight">\(r_\mathrm{boundary\_outer}\)</span>. So,</p>
<div class="math notranslate nohighlight">
\[L_{\nu z} = \int_0^{r_\mathrm{boundary\_outer}} I_\nu(p)\times 2\pi p dp = 2\pi \int_0^{r_\mathrm{boundary\_outer}} I_\nu(p) p dp.\]</div>
<p>Putting this all together, we get</p>
<div class="math notranslate nohighlight">
\[L_\nu = 8\pi^2 \int_0^{r_\mathrm{boundary\_outer}} I_\nu(p) p dp.\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A separate integral must be done for each frequency.</p>
</div>
<a class="reference internal image-reference" href="../../_images/formal_integral_sphere.jpg"><img alt="../../_images/formal_integral_sphere.jpg" src="../../_images/formal_integral_sphere.jpg" style="width: 1000px;" />
</a>
</section>
<section id="summary-of-implementation">
<h2>Summary of Implementation<a class="headerlink" href="#summary-of-implementation" title="Link to this heading">¶</a></h2>
<p>Since there is a continuum of frequencies represented in a spectrum, the formal integral cannot calculate the luminosity density at <em>every</em> frequency. Instead, we calculate <span class="math notranslate nohighlight">\(L_\nu\)</span> at a finite number of frequencies between the <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">stop</span></code> wavelengths provided in the <a class="reference internal" href="../../io/configuration/components/spectrum.html#spectrum-config"><span class="std std-ref">Spectrum Configuration</span></a> (converting between frequency and wavelength using <span class="math notranslate nohighlight">\(\nu=\frac{c}{\lambda}\)</span> where <span class="math notranslate nohighlight">\(\lambda\)</span> is wavelength and <span class="math notranslate nohighlight">\(c\)</span> is the speed of light) to give us an approximate spectrum. The number of frequencies we use is the <code class="docutils literal notranslate"><span class="pre">num</span></code> argument in the configuration. The frequencies are evenly spaced <strong>in wavelength space</strong> (exactly like histogram bins in <a class="reference internal" href="basic.html"><span class="doc">Basic Spectrum Generation</span></a> – see near the bottom of that page for more information).</p>
<p>Similarly, when doing the integral for a particular frequency, there is a continuum of impact parameters, so we cannot calculate <span class="math notranslate nohighlight">\(I_\nu(p)\)</span> for every single one. We instead use a finite list of impact parameters between 0 and the supernova’s outer boundary. The number of impact parameters we use is the value of <code class="docutils literal notranslate"><span class="pre">points</span></code> provided in the <code class="docutils literal notranslate"><span class="pre">integrated</span></code> section of the spectrum configuration.</p>
<p>For each frequency in our list of frequencies, TARDIS calculates <span class="math notranslate nohighlight">\(I_\nu(p)\)</span> for each <span class="math notranslate nohighlight">\(p\)</span> in the list of impact parameters, and then performs the integral <span class="math notranslate nohighlight">\(\int_0^{r_\mathrm{boundary\_outer}} I_\nu(p) p dp\)</span> using <a class="reference external" href="https://en.wikipedia.org/wiki/Trapezoidal_rule">trapezoid integration</a>. Our result is then multiplied by <span class="math notranslate nohighlight">\(8\pi^2\)</span> to get the correct luminosity density. The most involved part of the calculation is calculating <span class="math notranslate nohighlight">\(I_\nu(p)\)</span> for every combination of <span class="math notranslate nohighlight">\(\nu\)</span> in the list of frequencies and <span class="math notranslate nohighlight">\(p\)</span> in the list of impact parameters. This step is described in detail in the following section:</p>
</section>
<section id="calculating-i-nu-p">
<h2>Calculating <span class="math notranslate nohighlight">\(I_\nu(p)\)</span><a class="headerlink" href="#calculating-i-nu-p" title="Link to this heading">¶</a></h2>
<section id="setting-up">
<h3>Setting Up<a class="headerlink" href="#setting-up" title="Link to this heading">¶</a></h3>
<p>We now calculate <span class="math notranslate nohighlight">\(I_\nu(p)\)</span>, which is the intensity of the light with a <strong>lab frame</strong> (see <a class="reference internal" href="../montecarlo/propagation.html#referenceframes"><span class="std std-ref">Reference Frames</span></a>) frequency <span class="math notranslate nohighlight">\(\nu\)</span> exiting a the supernova along a ray with impact parameter <span class="math notranslate nohighlight">\(p\)</span>, as shown in the diagram below (we use the lab frame frequency as that is the frame in which the spectrum is observed). Specifically, we are looking for the intensity of light with a frequency <span class="math notranslate nohighlight">\(\nu\)</span> traveling to the right on the right side of the ray. We start by discussing the case where <span class="math notranslate nohighlight">\(p&gt;r_\mathrm{boundary\_inner}\)</span> (where the ray does not intersect the photosphere). After, we will comment on what occurs when <span class="math notranslate nohighlight">\(p&lt;r_\mathrm{boundary\_inner}\)</span>.</p>
<img alt="../../_images/formal_integral_2d_above.png" src="../../_images/formal_integral_2d_above.png" />
<p>Since every point on the ray has the same lab frame frequency, the co-moving frequency will vary along the ray. Specifically, at the point <span class="math notranslate nohighlight">\(z_k\)</span>, we have</p>
<div class="math notranslate nohighlight">
\[\nu_{\mathrm{co-moving},k}=(1-\beta_k \mu_k)\nu = \left( 1-\frac{r_k \cos(\theta)}{ct_\mathrm{explosion}}\right) \nu.\]</div>
<p>But, <span class="math notranslate nohighlight">\(\cos(\theta)=\frac{z_k}{r_k}\)</span>, so</p>
<div class="math notranslate nohighlight">
\[\nu_{\mathrm{co-moving},k}= \left( 1-\frac{z_k}{ct_\mathrm{explosion}}\right) \nu.\]</div>
<p>Notice that the co-moving frequency decreases as you move farther to the right, i.e. as the z-coordinate increases. With this, we can see where along the ray each line resonance occurs – a line with a frequency <span class="math notranslate nohighlight">\(\nu_\mathrm{line}\)</span> (which comes into resonance in the co-moving frame) will come into resonance at <span class="math notranslate nohighlight">\(z=ct_\mathrm{explosion}\left(1-\frac{\nu_\mathrm{line}}{\nu}\right)\)</span>. The highest line frequency that can resonate on our ray is <span class="math notranslate nohighlight">\(\nu_\mathrm{max}=\left(1-\frac{z_\mathrm{min}}{ct_\mathrm{explosion}}\right)\nu\)</span>, and the lowest line frequency that can resonate on our ray is <span class="math notranslate nohighlight">\(\nu_\mathrm{min}=\left(1-\frac{z_\mathrm{max}}{ct_\mathrm{explosion}}\right)\nu\)</span>, where <span class="math notranslate nohighlight">\(z_\mathrm{max}=\sqrt{r_\mathrm{boundary\_outer}^2-p^2}\)</span> and by symmetry <span class="math notranslate nohighlight">\(z_\mathrm{min}=-z_\mathrm{max}\)</span>. Every line between those frequencies will resonate on our ray – the points at which each line resonates is shown on the diagram (though in reality there are far more resonances than in this shown in this example diagram). The line resonating at the point <span class="math notranslate nohighlight">\(z_0\)</span> has the highest frequency of any line with a frequency below <span class="math notranslate nohighlight">\(\nu_\mathrm{max}\)</span>, and the line resonating at the point <span class="math notranslate nohighlight">\(z_{N-1}\)</span> (the Nth line) has the highest frequency of any line with a frequency above <span class="math notranslate nohighlight">\(\nu_\mathrm{min}\)</span>. Finally, we denote the intensity along the ray directly to the left of a point <span class="math notranslate nohighlight">\(z_k\)</span> as <span class="math notranslate nohighlight">\(I_k^b\)</span> with “b” for blue, as it has a slightly higher (“bluer”) frequency than the line resonating at <span class="math notranslate nohighlight">\(z_k\)</span>. Similarly, we denote the intensity along the ray directly to the right of a point <span class="math notranslate nohighlight">\(z_k\)</span> as <span class="math notranslate nohighlight">\(I_k^r\)</span> with “r” for red, as it has a slightly lower (“redder”) frequency than the line resonating at <span class="math notranslate nohighlight">\(z_k\)</span>.</p>
<p>Our goal is to find <span class="math notranslate nohighlight">\(I_{N-1}^r\)</span>, as this is the light that will exit the supernova. We start with <span class="math notranslate nohighlight">\(I_0^b=0\)</span> (as we assume no light is entering the supernova externally). We then increment the intensity along the ray. To do this, we will need the line source function.</p>
</section>
<section id="constructing-the-source-function">
<h3>Constructing the Source Function<a class="headerlink" href="#constructing-the-source-function" title="Link to this heading">¶</a></h3>
<p>Our problem is to determine the intensity that is added to the ray at a line resonance <span class="math notranslate nohighlight">\(l\rightarrow u\)</span> based on the Monte Carlo packets.</p>
<p>Consider another transition <span class="math notranslate nohighlight">\(i\rightarrow u\)</span>. We know (see <a class="reference internal" href="../montecarlo/estimators.html#edotlu"><span class="std std-ref">\dot{E}_{lu} Estimator</span></a>) that the rate at which energy density interacts with the transition is <span class="math notranslate nohighlight">\(\dot{E}_{iu}\)</span>, i.e. the <code class="docutils literal notranslate"><span class="pre">Edotlu</span></code> estimator for the transition <span class="math notranslate nohighlight">\(i\rightarrow u\)</span>. Now, sum up these estimators for every level <span class="math notranslate nohighlight">\(i\)</span> that can be excited to the level <span class="math notranslate nohighlight">\(u\)</span> – this will give us the rate at which energy density is added to the level <span class="math notranslate nohighlight">\(u\)</span> from all line transitions that can be excited to <span class="math notranslate nohighlight">\(u\)</span>:</p>
<div class="math notranslate nohighlight">
\[\dot{E}_u = \sum_{i &lt; u} \dot E_{iu}.\]</div>
<p>The rate at which energy density is then de-excited from <span class="math notranslate nohighlight">\(u\rightarrow l\)</span> (and thus be deposited into the ray’s intensity at the resonance point of <span class="math notranslate nohighlight">\(l\rightarrow u\)</span>) is <span class="math notranslate nohighlight">\(q_{ul}\dot{E}_u\)</span>, where <span class="math notranslate nohighlight">\(q_{ul}\)</span> is the fraction of energy at the level <span class="math notranslate nohighlight">\(u\)</span> which de-excites in the transition <span class="math notranslate nohighlight">\(u\rightarrow l\)</span>. To turn this into the intensity added to the ray at a resonance point, for reasons presented in <span id="id2">[<a class="reference internal" href="../../resources/zreferences.html#id12" title="L. B. Lucy. Improved Monte Carlo techniques for the spectral synthesis of supernovae. Astronomy and Astrophysics, 345:211-220, May 1999.">Lucy99b</a>]</span>, we include a factor of <span class="math notranslate nohighlight">\(\frac{\lambda_{ul} t_\mathrm{explosion}}{4 \pi}\)</span> where <span class="math notranslate nohighlight">\(\lambda_{ul}\)</span> is the wavelength of the light released in the transition <span class="math notranslate nohighlight">\(u\rightarrow l\)</span>. So, the intensity that is added to our ray at the resonance point of <span class="math notranslate nohighlight">\(l\rightarrow u\)</span>, which we will label as <span class="math notranslate nohighlight">\(\left( 1- e^{-\tau_{lu}}\right) S_{ul}\)</span>, is</p>
<div class="math notranslate nohighlight">
\[\left( 1- e^{-\tau_{lu}}\right) S_{ul} = \frac{\lambda_{ul} t}{4 \pi} q_{ul}\dot E_u.\]</div>
<p>Here, <span class="math notranslate nohighlight">\(S_{ul}\)</span> is the source function – interpret it as the intensity that is eligible to interact and end up on our ray (i.e. the source of the intensity that ends up on our ray). The actual intensity that ends up being added to the ray is the source function times the probability of the transition <span class="math notranslate nohighlight">\(l\rightarrow u\)</span>, which is <span class="math notranslate nohighlight">\(\left( 1- e^{-\tau_{lu}}\right)\)</span>.</p>
</section>
<section id="incrementing-the-intensity">
<h3>Incrementing the Intensity<a class="headerlink" href="#incrementing-the-intensity" title="Link to this heading">¶</a></h3>
<p>With this, we can now show how the intensity along our ray is incremented. First, at the kth line resonance there is an <span class="math notranslate nohighlight">\(e^{-\tau_{k}}\)</span> probability that light does not interact with the line. So, on the red side of the line we only have <span class="math notranslate nohighlight">\(e^{-\tau_k}\)</span> times the intensity on the blue side. But, we also have an intensity <span class="math notranslate nohighlight">\(\left(1- e^{-\tau_k}\right) S_k\)</span> that is added to the ray at the line resonance, so in total we have</p>
<div class="math notranslate nohighlight">
\[I_k^r = I_k^b e^{-\tau_k} + \left( 1- e^{-\tau_k}\right) S_{k}.\]</div>
<p>If there is no electron scattering, this would be it; we would have <span class="math notranslate nohighlight">\(I^b_{k+1}=I^r_k\)</span> (the intensity on the left of a line would be the intensity on the right of the next line, since no interactions would take place between the locations of line resonances). However, with electron scattering, this is not the case. In between line resonances, light has a probability of <span class="math notranslate nohighlight">\(e^{-\Delta \tau_e}\)</span> of not scattering, where <span class="math notranslate nohighlight">\(\Delta \tau_e=\sigma_{\mathrm{T}} n_e \Delta z\)</span> is the electron scattering optical depth (see <a class="reference internal" href="../montecarlo/propagation.html#physical-interactions"><span class="std std-ref">Physical Interactions</span></a>). So, we would have <span class="math notranslate nohighlight">\(I^b_{k+1}=I^r_ke^{-\Delta \tau_e}\)</span>. But, light can also scatter onto the ray. The intensity is increased by the mean intensity between the two resonance points times the probability of light scattering (and thus ending up on the ray), this probability being <span class="math notranslate nohighlight">\(1-e^{-\Delta \tau_e}\)</span>. For the intensity between <span class="math notranslate nohighlight">\(z_k\)</span> and <span class="math notranslate nohighlight">\(z_{k+1}\)</span> we use the average of the mean intensity to the right of <span class="math notranslate nohighlight">\(z_k\)</span> and the mean intensity to the left of <span class="math notranslate nohighlight">\(z_{k+1}\)</span>, which is <span class="math notranslate nohighlight">\(\frac{1}{2}\left(J_k^r+J_{k+1}^b\right)\)</span>. Here, <span class="math notranslate nohighlight">\(J^b_{k}\)</span> is calculated from the <code class="docutils literal notranslate"><span class="pre">j_blue</span></code> estimator for the kth line transition (see <a class="reference internal" href="../montecarlo/estimators.html#j-blue-estimator"><span class="std std-ref">J^b_{lu} Estimator</span></a>), and then</p>
<div class="math notranslate nohighlight">
\[J_k^r = J_k^b e^{-\tau_k} + \left( 1- e^{-\tau_k}\right) S_{k}\]</div>
<p>for the same reasoning as before (since <span class="math notranslate nohighlight">\(J\)</span>, like <span class="math notranslate nohighlight">\(I\)</span>, is an intensity and thus by identical logic is increased by <span class="math notranslate nohighlight">\(\left( 1- e^{-\tau_k}\right) S_{k}\)</span> at line resonances).</p>
<p>This gives us</p>
<div class="math notranslate nohighlight">
\[I_{k+1}^b = I_k^r e^{-\Delta \tau_e} + (1-e^{-\Delta \tau_e})*\frac{1}{2}\left(J_k^r+J_{k+1}^b\right).\]</div>
<p>Note that here the mean intensity is acting as the source function. The final step, for computational ease, approximates <span class="math notranslate nohighlight">\(e^{-\Delta \tau_e}\approx 1-\Delta \tau_e\)</span> since the resonance points will be so close together that <span class="math notranslate nohighlight">\(\Delta \tau_e &lt;&lt; 1\)</span>. Our final result is then</p>
<div class="math notranslate nohighlight">
\[I_{k+1}^b = I_k^r + \Delta \tau_e \left[ \frac{1}{2}\left(J_k^r + J_{k+1}^b\right) - I_k^r  \right].\]</div>
<p><strong>In summary</strong>, when calculating <span class="math notranslate nohighlight">\(I_\nu(p)\)</span> for some ray, we start with <span class="math notranslate nohighlight">\(I_0^b=0\)</span> and then calculate <span class="math notranslate nohighlight">\(I_0^r\)</span>, then <span class="math notranslate nohighlight">\(I_1^b\)</span>, then <span class="math notranslate nohighlight">\(I_1^r\)</span>, etc. via the relations</p>
<div class="math notranslate nohighlight">
\[I_k^r = I_k^b e^{-\tau_k} + \left( 1- e^{-\tau_k}\right) S_{k}\]</div>
<div class="math notranslate nohighlight">
\[I_{k+1}^b = I_k^r + \Delta \tau_e \left[ \frac{1}{2}\left(J_k^r + J_{k+1}^b\right) - I_k^r  \right]\]</div>
<p>until we get to <span class="math notranslate nohighlight">\(I_{N-1}^r\)</span>, which is then used as the value of <span class="math notranslate nohighlight">\(I_\nu(p)\)</span> that goes into the integral <span class="math notranslate nohighlight">\(L_\nu = 8\pi^2 \int_0^{r_\mathrm{boundary\_outer}} I_\nu(p) p dp\)</span>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The values for the source function (and the quantities and estimators used to calculate it), Sobolev optical depths, electron densities, the mean intensity, and all other non-constant quantities are taken in the cell in which the line resonance takes place. However, to improve results, TARDIS breaks down the model into more cells than used in the rest of the simulation and interpolates the values of these quantities. The number of shells TARDIS uses for this interpolation process is specified in the <a class="reference internal" href="../../io/configuration/components/spectrum.html"><span class="doc">spectrum configuration</span></a>.</p>
</div>
</section>
<section id="rays-intersecting-the-photosphere">
<h3>Rays Intersecting the Photosphere<a class="headerlink" href="#rays-intersecting-the-photosphere" title="Link to this heading">¶</a></h3>
<p>Since the photosphere is modeled as being optically thick, if a ray intersects the photosphere, anything that happens prior to the photosphere does not matter – the photosphere absorbs all light that hits it. Because of this, to calculate <span class="math notranslate nohighlight">\(I_\nu(p)\)</span> over a ray that starts by exiting the photosphere, we must slightly adjust our approach, as shown in the diagram below. In this case, we now have that the minimum z-coordinate is <span class="math notranslate nohighlight">\(z_\mathrm{min}=\sqrt{r_\mathrm{boundary\_inner}^2-p^2}\)</span>, and we use this to determine the lowest possible resonant frequency on the ray as before, which will then give us <span class="math notranslate nohighlight">\(z_0\)</span>, as it did before. Finally, since light along this ray is released from the photosphere, we have</p>
<div class="math notranslate nohighlight">
\[I_0^b = B_\nu(T_\mathrm{inner})= \frac{2h}{c^2}\frac{\nu^3}{e^{h\nu/k_BT}-1}.\]</div>
<p>which is the Planck function (see <a class="reference internal" href="../montecarlo/initialization.html"><span class="doc">Energy Packet Initialization</span></a>). After making those small adjustments, we increment the intensity exactly as in the other case.</p>
<a class="reference internal image-reference" href="../../_images/formal_integral_2d_below.png"><img alt="../../_images/formal_integral_2d_below.png" src="../../_images/formal_integral_2d_below.png" style="width: 700px;" />
</a>
</section>
</section>
<section id="current-limitations">
<h2>Current Limitations<a class="headerlink" href="#current-limitations" title="Link to this heading">¶</a></h2>
<p>The current implementation of the formal integral has some limitations:</p>
<ul class="simple">
<li><p>Once electron scattering is included, the scheme only produces accurate results when many resonances occur on the rays. This is simply because otherwise the average of <span class="math notranslate nohighlight">\(J^b\)</span> and <span class="math notranslate nohighlight">\(J^r\)</span> does not provide an accurate representation of the mean intensity between successive resonance points. Also, <span class="math notranslate nohighlight">\(d\tau\)</span> can become large which can create unphysical, negative intensities.</p></li>
</ul>
<p>It is always advised to check the results of the formal integration against the
spectrum constructed from the emerging Monte Carlo packets.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="virtualpackets.html" class="btn btn-neutral float-left" title="Spectrum Generation with Virtual Packets" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../tardisgamma/index.html" class="btn btn-neutral float-right" title="TARDIS-High Energy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 19 May 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>