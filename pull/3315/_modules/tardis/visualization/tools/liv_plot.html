

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-53HJHD1BWS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-53HJHD1BWS');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tardis.visualization.tools.liv_plot &mdash; tardis</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />

  
    <link rel="shortcut icon" href="../../../../_static/tardis_logo.ico"/>
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=29a32e3f"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.13/dist/embed-amd.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            tardis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/credits.html">Credits &amp; Publication Policies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/high_energy/run_high_energy_workflow.html">TARDIS High Energy Workflow Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/visualization/tutorial_montecarlo_packet_visualization.html">Montecarlo Packet Visualization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/index.html">Analyszing TARDIS Simulation Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/tutorial_read_configuration.html">Reading a Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/output/index.html">Additional Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../how-to/code_comparison/index.html">How to do Code Comparison using TARDIS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/intro/index.html">Physics Walkthrough Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/update_and_conv/update_and_conv.html">Updating Plasma and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/spectrum/index.html">Spectrum Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/tardisgamma/index.html">TARDIS-High Energy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/visualization_reference.html">Visualization Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/index.html">Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/hdf/index.html">Hierarchical Data Format (HDF5) Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/zreferences.html">Bibliography and Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/tools/index.html">Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/in_progress/index.html">Features In-Progress</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tardis.visualization.tools.liv_plot</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tardis.visualization.tools.liv_plot</h1><div class="highlight"><pre>
<span></span>import logging

import astropy.units as u
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import plotly.graph_objects as go

from tardis.util.base import (
    atomic_number2element_symbol,
    int_to_roman,
)
from tardis.visualization import plot_util as pu

logger = logging.getLogger(__name__)


<div class="viewcode-block" id="LIVPlotter">
<a class="viewcode-back" href="../../../../api/tardis.visualization.tools.liv_plot.html#tardis.visualization.tools.liv_plot.LIVPlotter">[docs]</a>
class LIVPlotter:
    &quot;&quot;&quot;
    Plotting interface for the last interaction velocity plot.
    &quot;&quot;&quot;

    def __init__(self):
        &quot;&quot;&quot;
        Initialize the plotter with required data from the simulation.
        &quot;&quot;&quot;
        self.packet_data = {
            &quot;real&quot;: {&quot;packets_df&quot;: None, &quot;packets_df_line_interaction&quot;: None},
            &quot;virtual&quot;: {
                &quot;packets_df&quot;: None,
                &quot;packets_df_line_interaction&quot;: None,
            },
        }
        self.velocity = None
        self.time_explosion = None

<div class="viewcode-block" id="LIVPlotter.from_simulation">
<a class="viewcode-back" href="../../../../api/tardis.visualization.tools.liv_plot.html#tardis.visualization.tools.liv_plot.LIVPlotter.from_simulation">[docs]</a>
    @classmethod
    def from_simulation(cls, sim):
        &quot;&quot;&quot;
        Create an instance of the plotter from a TARDIS simulation object.

        Parameters
        ----------
        sim : tardis.simulation.Simulation
            TARDIS simulation object produced by running a simulation.

        Returns
        -------
        LIVPlotter
        &quot;&quot;&quot;
        plotter = cls()
        plotter.velocity = sim.simulation_state.velocity
        plotter.time_explosion = sim.plasma.time_explosion

        modes = [&quot;real&quot;]
        if sim.transport.transport_state.virt_logging:
            modes.append(&quot;virtual&quot;)
        for mode in modes:
            plotter.packet_data[mode] = pu.extract_and_process_packet_data(
                sim, mode
            )

        return plotter</div>


<div class="viewcode-block" id="LIVPlotter.from_hdf">
<a class="viewcode-back" href="../../../../api/tardis.visualization.tools.liv_plot.html#tardis.visualization.tools.liv_plot.LIVPlotter.from_hdf">[docs]</a>
    @classmethod
    def from_hdf(cls, hdf_fpath):
        &quot;&quot;&quot;
        Create an instance of the Plotter from a simulation HDF file.

        Parameters
        ----------
        hdf_fpath : str
            Valid path to the HDF file where simulation is saved.

        Returns
        -------
        LIVPlotter
        &quot;&quot;&quot;
        plotter = cls()
        with pd.HDFStore(hdf_fpath, &quot;r&quot;) as hdf:
            plotter.time_explosion = (
                hdf[&quot;/simulation/plasma/scalars&quot;][&quot;time_explosion&quot;] * u.s
            )
            plotter.velocity = hdf[&quot;/simulation/simulation_state/velocity&quot;] * (
                u.cm / u.s
            )
            transport_state_scalars = hdf[
                &quot;/simulation/transport/transport_state/scalars&quot;
            ]
            has_virtual = bool(
                getattr(transport_state_scalars, &quot;virt_logging&quot;, False)
            )

            modes = [&quot;real&quot;] + ([&quot;virtual&quot;] if has_virtual else [])
            for mode in modes:
                plotter.packet_data[mode] = (
                    pu.extract_and_process_packet_data_hdf(hdf, mode)
                )

        return plotter</div>


<div class="viewcode-block" id="LIVPlotter.from_workflow">
<a class="viewcode-back" href="../../../../api/tardis.visualization.tools.liv_plot.html#tardis.visualization.tools.liv_plot.LIVPlotter.from_workflow">[docs]</a>
    @classmethod
    def from_workflow(cls, workflow):
        &quot;&quot;&quot;
        Create an instance of the plotter from a TARDIS workflow.

        Parameters
        ----------
        workflow : A TARDIS workflow object

        Returns
        -------
        LIVPlotter
        &quot;&quot;&quot;
        plotter = cls()
        plotter.velocity = workflow.simulation_state.velocity
        plotter.time_explosion = workflow.transport_state.time_explosion * u.s
        modes = [&quot;real&quot;]
        if workflow.enable_virtual_packet_logging:
            modes.append(&quot;virtual&quot;)

        for mode in modes:
            plotter.packet_data[mode] = pu.extract_and_process_packet_data(
                workflow, mode
            )

        return plotter</div>


    def _parse_species_list(self, species_list, packets_mode, nelements=None):
        &quot;&quot;&quot;
        Parse user requested species list and create list of species ids to be used.

        Parameters
        ----------
        species_list : list of species to plot
            List of species (e.g. Si II, Ca II, etc.) that the user wants to show as unique colours.
            Species can be given as an ion (e.g. Si II), an element (e.g. Si), a range of ions
            (e.g. Si I - V), or any combination of these (e.g. species_list = [Si II, Fe I-V, Ca])
        packets_mode : str, optional
            Packet mode, either &#39;virtual&#39; or &#39;real&#39;. Default is &#39;virtual&#39;.
        nelements : int, optional
            Number of elements to include in plot. The most interacting elements are included. If None, displays all elements.

        Raises
        ------
        ValueError
            If species list contains invalid entries.

        &quot;&quot;&quot;
        if species_list is not None:
            (
                species_mapped_tuples,
                requested_species_ids_tuples,
                keep_colour,
                full_species_list,
            ) = pu.parse_species_list_util(species_list)
            self._full_species_list = full_species_list
            self._species_list = requested_species_ids_tuples
            self._species_mapped = species_mapped_tuples
            self._keep_colour = keep_colour
        else:
            self._species_list = None
            self._species_mapped = None
            self._keep_colour = None

        if nelements:
            interaction_counts = self.packet_data[packets_mode][
                &quot;packets_df_line_interaction&quot;
            ][&quot;last_line_interaction_species&quot;].value_counts()
            # interaction_counts.index = interaction_counts.index // 100
            element_counts = interaction_counts.groupby(
                interaction_counts.index
            ).sum()
            top_elements = element_counts.nlargest(nelements).index
            top_species_list = [
                atomic_number2element_symbol(element[0])
                for element in top_elements
            ]
            self._parse_species_list(top_species_list, packets_mode)

    def _make_colorbar_labels(self):
        &quot;&quot;&quot;
        Generate labels for the colorbar based on species.

        If a species list is provided, uses that to generate labels.
        Otherwise, generates labels from the species in the model.
        &quot;&quot;&quot;
        if self._species_list is None:
            species_name = [
                atomic_number2element_symbol(atomic_num)
                for atomic_num in self.species
            ]
        else:
            species_name = []
            for species_key, species_ids in self._species_mapped.items():
                print(self.species, species_ids)
                if any(spec_id in self.species for spec_id in species_ids):
                    atomic_number, ion_number = species_key
                    if ion_number == 0:
                        label = atomic_number2element_symbol(atomic_number)
                    else:
                        ion_numeral = int_to_roman(ion_number + 1)
                        label = f&quot;{atomic_number2element_symbol(atomic_number)} {ion_numeral}&quot;
                    species_name.append(label)

        self._species_name = species_name

    def _make_colorbar_colors(self):
        &quot;&quot;&quot;
        Generate colors for the species to be plotted.

        This method creates a list of colors corresponding to the species names.
        The colors are generated based on the species present in the model and
        the requested species list.
        &quot;&quot;&quot;
        color_list = []
        species_keys = list(self._species_mapped.keys())
        num_species = len(species_keys)

        for species_counter, species_key in enumerate(species_keys):
            if any(
                species in self.species
                for species in self._species_mapped[species_key]
            ):
                color = self.cmap(species_counter / num_species)
                color_list.append(color)

        self._color_list = color_list

    def _generate_plot_data(self, packets_mode):
        &quot;&quot;&quot;
        Generate plot data and colors for species in the model.

        Parameters
        ----------
        packets_mode : str
            Packet mode, either &#39;virtual&#39; or &#39;real&#39;.
        &quot;&quot;&quot;
        groups = (
            self.packet_data[packets_mode][&quot;packets_df_line_interaction&quot;]
            .loc[self.packet_nu_line_range_mask]
            .groupby(by=&quot;last_line_interaction_species&quot;)
        )

        self.plot_colors = []
        self.plot_data = []
        species_not_wvl_range = []
        species_counter = 0

        time_explosion = self.time_explosion

        for species_list in self._species_mapped.values():
            full_v_last = []
            for species in species_list:
                if species in self.species:
                    if species not in groups.groups:
                        atomic_number, ion_number = species
                        ion_numeral = int_to_roman(ion_number + 1)
                        label = f&quot;{atomic_number2element_symbol(atomic_number)} {ion_numeral}&quot;
                        species_not_wvl_range.append(label)
                        continue
                    g_df = groups.get_group(species)
                    r_last_interaction = (
                        g_df[&quot;last_interaction_in_r&quot;].values * u.cm
                    )
                    v_last_interaction = (
                        r_last_interaction / time_explosion
                    ).to(&quot;km/s&quot;)
                    full_v_last.extend(v_last_interaction)
            if full_v_last:
                self.plot_data.append(full_v_last)
                self.plot_colors.append(self._color_list[species_counter])
                species_counter += 1

        if species_not_wvl_range:
            logger.info(
                &quot;%s were not found in the provided wavelength range.&quot;,
                species_not_wvl_range,
            )

    def _prepare_plot_data(
        self,
        packets_mode,
        packet_wvl_range,
        species_list,
        cmapname,
        num_bins,
        nelements,
    ):
        &quot;&quot;&quot;
        Prepare data and settings required for generating a plot.

        This method handles the common logic for preparing data and settings
        needed to generate both matplotlib and plotly plots. It parses the species
        list, generates color labels and colormap, and bins the velocity data.

        Parameters
        ----------
        packets_mode : str
            Packet mode, either &#39;virtual&#39; or &#39;real&#39;.
        packet_wvl_range : astropy.Quantity
            Wavelength range to restrict the analysis of escaped packets. It
            should be a quantity having units of Angstrom, containing two
            values - lower lambda and upper lambda i.e.
            [lower_lambda, upper_lambda] * u.AA
        species_list : list of str
            List of species to plot. Species can be specified as an ion
            (e.g., Si II), an element (e.g., Si), a range of ions (e.g., Si I-V),
            or any combination of these.
        cmapname : str
            Name of the colormap to use. A specific colormap can be chosen, such
            as &quot;jet&quot;, &quot;viridis&quot;, &quot;plasma&quot;, etc.
        num_bins : int, optional
            Number of bins for regrouping within the same range. If None,
            no regrouping is done.
        nelements : int, optional
            Number of elements to include in plot. The most interacting elements are included. If None, displays all elements.

        Raises
        ------
        ValueError
            If no species are provided for plotting, or if no valid species are
            found in the model.
        &quot;&quot;&quot;
        # Extract all unique elements from the packets data
        species_in_model = np.unique(
            self.packet_data[packets_mode][&quot;packets_df_line_interaction&quot;][
                &quot;last_line_interaction_species&quot;
            ]
            .apply(lambda x: (int(x[0]), int(x[1])))
            .to_numpy()
        )
        if species_list is None:
            species_list = [
                f&quot;{atomic_number2element_symbol(species[0])}&quot;
                for species in species_in_model
            ]
        self._parse_species_list(species_list, packets_mode, nelements)
        if self._species_list is None or not self._species_list:
            raise ValueError(&quot;No species provided for plotting.&quot;)
        self.species = list(set(self._species_list) &amp; set(species_in_model))

        if len(self.species) == 0:
            raise ValueError(&quot;No valid species found for plotting.&quot;)

        self._make_colorbar_labels()
        self.cmap = plt.get_cmap(cmapname, len(self._species_name))
        self._make_colorbar_colors()

        self.packet_nu_line_range_mask = pu.create_wavelength_mask(
            self.packet_data,
            packets_mode,
            packet_wvl_range,
            df_key=&quot;packets_df_line_interaction&quot;,
            column_name=&quot;nus&quot;,
        )

        self._generate_plot_data(packets_mode)
        bin_edges = (self.velocity).to(&quot;km/s&quot;)

        if num_bins:
            if num_bins &lt; 1:
                raise ValueError(&quot;Number of bins must be positive&quot;)
            if num_bins &gt; len(bin_edges) - 1:
                logger.warning(
                    &quot;Number of bins must be less than or equal to number of shells. Plotting with number of bins equals to number of shells.&quot;
                )
                self.new_bin_edges = bin_edges
            else:
                self.new_bin_edges = np.linspace(
                    bin_edges[0], bin_edges[-1], num_bins + 1
                )
        else:
            self.new_bin_edges = bin_edges

    def _get_step_plot_data(self, data, bin_edges):
        &quot;&quot;&quot;
        Generate step plot data from histogram data.

        Parameters
        ----------
        data : array-like
            Data to be binned into a histogram.
        bin_edges : array-like
            Edges of the bins for the histogram.
        &quot;&quot;&quot;
        hist, _ = np.histogram(data, bins=bin_edges)
        self.step_x = np.repeat(bin_edges, 2)[1:-1]
        self.step_y = np.repeat(hist, 2)

<div class="viewcode-block" id="LIVPlotter.generate_plot_mpl">
<a class="viewcode-back" href="../../../../api/tardis.visualization.tools.liv_plot.html#tardis.visualization.tools.liv_plot.LIVPlotter.generate_plot_mpl">[docs]</a>
    def generate_plot_mpl(
        self,
        species_list=None,
        nelements=None,
        packets_mode=&quot;virtual&quot;,
        packet_wvl_range=None,
        ax=None,
        figsize=(11, 5),
        cmapname=&quot;jet&quot;,
        xlog_scale=False,
        ylog_scale=False,
        num_bins=None,
        velocity_range=None,
    ):
        &quot;&quot;&quot;
        Generate the last interaction velocity distribution plot using matplotlib.

        Parameters
        ----------
        species_list : list of str, optional
            List of species to plot. Default is None which plots all species in the model.
        nelements : int, optional
            Number of elements to include in plot. The most interacting elements are included. If None, displays all elements.
        packets_mode : str, optional
            Packet mode, either &#39;virtual&#39; or &#39;real&#39;. Default is &#39;virtual&#39;.
        packet_wvl_range : astropy.Quantity
            Wavelength range to restrict the analysis of escaped packets. It
            should be a quantity having units of Angstrom, containing two
            values - lower lambda and upper lambda i.e.
            [lower_lambda, upper_lambda] * u.AA
        ax : matplotlib.axes.Axes, optional
            Axes object to plot on. If None, creates a new figure.
        figsize : tuple, optional
            Size of the figure. Default is (11, 5).
        cmapname : str, optional
            Colormap name. Default is &#39;jet&#39;. A specific colormap can be chosen, such as &quot;jet&quot;, &quot;viridis&quot;, &quot;plasma&quot;, etc.
        xlog_scale : bool, optional
            If True, x-axis is scaled logarithmically. Default is False.
        ylog_scale : bool, optional
            If True, y-axis is scaled logarithmically. Default is False.
        num_bins : int, optional
            Number of bins for regrouping within the same range. Default is None.
        velocity_range : tuple, optional
            Limits for the x-axis. If specified, overrides any automatically determined limits.

        Returns
        -------
        matplotlib.axes.Axes
            Axes object with the plot.
        &quot;&quot;&quot;
        # If species_list and nelements requested, tell user that nelements is ignored
        if species_list is not None and nelements is not None:
            logger.info(
                &quot;Both nelements and species_list were requested. Species_list takes priority; nelements is ignored&quot;
            )
            nelements = None

        self._prepare_plot_data(
            packets_mode,
            packet_wvl_range,
            species_list,
            cmapname,
            num_bins,
            nelements,
        )

        bin_edges = self.new_bin_edges

        if ax is None:
            self.ax = plt.figure(figsize=figsize).add_subplot(111)
        else:
            self.ax = ax

        for data, color, name in zip(
            self.plot_data, self.plot_colors, self._species_name
        ):
            self._get_step_plot_data(data, bin_edges)
            self.ax.plot(
                self.step_x,
                self.step_y,
                label=name,
                color=color,
                linewidth=2.5,
                drawstyle=&quot;steps-post&quot;,
                alpha=0.75,
            )

        self.ax.ticklabel_format(axis=&quot;y&quot;, scilimits=(0, 0))
        self.ax.tick_params(&quot;both&quot;, labelsize=15)
        self.ax.set_xlabel(&quot;Last Interaction Velocity (km/s)&quot;, fontsize=14)
        self.ax.set_ylabel(&quot;Packet Count&quot;, fontsize=15)
        self.ax.legend(fontsize=15, bbox_to_anchor=(1.0, 1.0), loc=&quot;upper left&quot;)
        self.ax.figure.tight_layout()
        if xlog_scale:
            self.ax.set_xscale(&quot;log&quot;)
        if ylog_scale:
            self.ax.set_yscale(&quot;log&quot;)
        if velocity_range:
            self.ax.set_xlim(velocity_range[0], velocity_range[1])

        return self.ax</div>


<div class="viewcode-block" id="LIVPlotter.generate_plot_ply">
<a class="viewcode-back" href="../../../../api/tardis.visualization.tools.liv_plot.html#tardis.visualization.tools.liv_plot.LIVPlotter.generate_plot_ply">[docs]</a>
    def generate_plot_ply(
        self,
        species_list=None,
        nelements=None,
        packets_mode=&quot;virtual&quot;,
        packet_wvl_range=None,
        fig=None,
        graph_height=600,
        cmapname=&quot;jet&quot;,
        xlog_scale=False,
        ylog_scale=False,
        num_bins=None,
        velocity_range=None,
    ):
        &quot;&quot;&quot;
        Generate the last interaction velocity distribution plot using plotly.

        Parameters
        ----------
        species_list : list of str, optional
            List of species to plot. Default is None which plots all species in the model.
        nelements : int, optional
            Number of elements to include in plot. The most interacting elements are included. If None, displays all elements.
        packets_mode : str, optional
            Packet mode, either &#39;virtual&#39; or &#39;real&#39;. Default is &#39;virtual&#39;.
        packet_wvl_range : astropy.Quantity
            Wavelength range to restrict the analysis of escaped packets. It
            should be a quantity having units of Angstrom, containing two
            values - lower lambda and upper lambda i.e.
            [lower_lambda, upper_lambda] * u.AA
        fig : plotly.graph_objects.Figure, optional
            Plotly figure object to add the plot to. If None, creates a new figure.
        graph_height : int, optional
            Height (in px) of the plotly graph to display. Default value is 600.
        cmapname : str, optional
            Colormap name. Default is &#39;jet&#39;. A specific colormap can be chosen, such as &quot;jet&quot;, &quot;viridis&quot;, &quot;plasma&quot;, etc.
        xlog_scale : bool, optional
            If True, x-axis is scaled logarithmically. Default is False.
        ylog_scale : bool, optional
            If True, y-axis is scaled logarithmically. Default is False.
        num_bins : int, optional
            Number of bins for regrouping within the same range. Default is None.
        velocity_range : tuple, optional
            Limits for the x-axis. If specified, overrides any automatically determined limits.

        Returns
        -------
        plotly.graph_objects.Figure
            Plotly figure object with the plot.
        &quot;&quot;&quot;
        # If species_list and nelements requested, tell user that nelements is ignored
        if species_list is not None and nelements is not None:
            logger.info(
                &quot;Both nelements and species_list were requested. Species_list takes priority; nelements is ignored&quot;
            )
            nelements = None

        self._prepare_plot_data(
            packets_mode,
            packet_wvl_range,
            species_list,
            cmapname,
            num_bins,
            nelements,
        )

        bin_edges = self.new_bin_edges

        if fig is None:
            self.fig = go.Figure()
        else:
            self.fig = fig

        for data, color, name in zip(
            self.plot_data, self.plot_colors, self._species_name
        ):
            self._get_step_plot_data(data, bin_edges)
            self.fig.add_trace(
                go.Scatter(
                    x=self.step_x,
                    y=self.step_y,
                    mode=&quot;lines&quot;,
                    line=dict(
                        color=pu.to_rgb255_string(color),
                        width=2.5,
                        shape=&quot;hv&quot;,
                    ),
                    name=name,
                    opacity=0.75,
                )
            )
        self.fig.update_layout(
            height=graph_height,
            xaxis_title=&quot;Last Interaction Velocity (km/s)&quot;,
            yaxis_title=&quot;Packet Count&quot;,
            font=dict(size=15),
            yaxis=dict(exponentformat=&quot;power&quot; if ylog_scale else &quot;e&quot;),
            xaxis=dict(exponentformat=&quot;power&quot; if xlog_scale else &quot;none&quot;),
        )
        if xlog_scale:
            self.fig.update_xaxes(type=&quot;log&quot;)
        if ylog_scale:
            self.fig.update_yaxes(type=&quot;log&quot;, dtick=1)

        if velocity_range:
            self.fig.update_xaxes(range=velocity_range)

        return self.fig</div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 03 Oct 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>