

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-53HJHD1BWS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-53HJHD1BWS');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tardis.opacities.macro_atom.macroatom_transitions &mdash; tardis</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />

  
    <link rel="shortcut icon" href="../../../../_static/tardis_logo.ico"/>
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=29a32e3f"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.13/dist/embed-amd.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            tardis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/credits.html">Credits &amp; Publication Policies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/high_energy/run_high_energy_workflow.html">TARDIS High Energy Workflow Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/visualization/tutorial_montecarlo_packet_visualization.html">Montecarlo Packet Visualization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/index.html">Analyszing TARDIS Simulation Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/tutorial_read_configuration.html">Reading a Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/output/index.html">Additional Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../how-to/code_comparison/index.html">How to do Code Comparison using TARDIS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/intro/index.html">Physics Walkthrough Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/update_and_conv/update_and_conv.html">Updating Plasma and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/spectrum/index.html">Spectrum Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/tardisgamma/index.html">TARDIS-High Energy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/visualization_reference.html">Visualization Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/index.html">Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/hdf/index.html">Hierarchical Data Format (HDF5) Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/zreferences.html">Bibliography and Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/tools/index.html">Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/in_progress/index.html">Features In-Progress</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tardis.opacities.macro_atom.macroatom_transitions</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tardis.opacities.macro_atom.macroatom_transitions</h1><div class="highlight"><pre>
<span></span>from tardis import constants as const
import numpy as np
import pandas as pd
from tardis.transport.montecarlo.macro_atom import MacroAtomTransitionType

CONST_C_CGS: float = const.c.cgs.value
CONST_H_CGS: float = const.h.cgs.value


<div class="viewcode-block" id="line_transition_internal_up">
<a class="viewcode-back" href="../../../../api/tardis.opacities.macro_atom.macroatom_transitions.html#tardis.opacities.macro_atom.macroatom_transitions.line_transition_internal_up">[docs]</a>
def line_transition_internal_up(
    line_f_lus: np.ndarray,
    line_nus: np.ndarray,
    energies_lower: np.ndarray,
    mean_intensities_blue_wing: pd.DataFrame,
    beta_sobolevs: pd.DataFrame,
    stimulated_emission_factors: np.ndarray,
    transition_a_i_l_u_array: np.ndarray,
    line_ids: np.ndarray,
) -&gt; tuple[pd.DataFrame, pd.DataFrame]:
    &quot;&quot;&quot;
    Calculate internal upward transition probabilities for line transitions in macro atoms.

    This function computes the probability of internal upward transitions between
    energy levels in macro atoms due to line transitions. It calculates the
    transition probabilities and creates metadata for tracking the transitions.

    Parameters
    ----------
    line_f_lus : array_like
        Oscillator strengths for line transitions from lower to upper levels.
    line_nus : array_like
        Frequencies of the line transitions in Hz.
    energies_lower : array_like
        Energy values of the lower levels in the transitions.
    mean_intensities_blue_wing : pd.DataFrame
        Mean radiation field intensities at the blue wing of the lines.
    beta_sobolevs : pd.DataFrame
        Sobolev escape probabilities for the line transitions.
    stimulated_emission_factors : array_like
        Factors accounting for stimulated emission in the transitions.
    transition_a_i_l_u_array : array_like
        2D array containing atomic number, ion number, lower level, and upper level
        indices for each transition. Shape should be (n_transitions, 4).
    line_ids : array_like
        Unique identifiers for each line transition.

    Returns
    -------
    p_internal_up : pandas.DataFrame
        DataFrame containing the calculated internal upward transition probabilities
        with source information, indexed by transition.
    internal_up_metadata : pandas.DataFrame
        DataFrame containing metadata for the transitions including transition line IDs,
        source and destination level information, transition type, and line indices.

    Notes
    -----
    The transition probability is calculated using the formula:
    P = (f_lu / (h * nu)) * stimulated_emission_factor * mean_intensity * beta * E_lower

    The function uses MacroAtomTransitionType to mark the transition type.
    &quot;&quot;&quot;
    p_internal_up = probability_internal_up(
        beta_sobolevs,
        line_nus,
        line_f_lus,
        stimulated_emission_factors,
        mean_intensities_blue_wing,
        energies_lower,
    )

    sources = list(map(tuple, transition_a_i_l_u_array[:, [0, 1, 2]]))
    transition_indices = np.arange(len(line_ids))
    destinations = list(map(tuple, transition_a_i_l_u_array[:, [0, 1, 3]]))

    internal_up_metadata = pd.DataFrame(
        {
            &quot;transition_line_id&quot;: line_ids,
            &quot;source&quot;: sources,
            &quot;destination&quot;: destinations,
            &quot;transition_type&quot;: MacroAtomTransitionType.INTERNAL_UP,
            &quot;transition_line_idx&quot;: transition_indices,
        },
        index=p_internal_up.index,
    )
    p_internal_up[&quot;source&quot;] = sources

    return p_internal_up, internal_up_metadata</div>



<div class="viewcode-block" id="probability_internal_up">
<a class="viewcode-back" href="../../../../api/tardis.opacities.macro_atom.macroatom_transitions.html#tardis.opacities.macro_atom.macroatom_transitions.probability_internal_up">[docs]</a>
def probability_internal_up(
    beta_sobolevs: pd.DataFrame,
    line_nus: np.ndarray,
    line_f_lus: np.ndarray,
    stimulated_emission_factors: np.ndarray,
    mean_intensities_blue_wing: pd.DataFrame,
    energies_lower: np.ndarray,
) -&gt; pd.DataFrame:
    &quot;&quot;&quot;
    Calculate internal upward transition probabilities.

    This function computes the probability of internal upward transitions between
    energy levels in macro atoms. The calculation involves oscillator strengths,
    stimulated emission factors, mean radiation field intensities, and energy values.

    Parameters
    ----------
    beta_sobolevs : pd.DataFrame
        Sobolev escape probabilities for the line transitions.
    line_nus : np.ndarray
        Frequencies of the line transitions in Hz.
    line_f_lus : np.ndarray
        Oscillator strengths for line transitions from lower to upper levels.
    stimulated_emission_factors : np.ndarray
        Factors accounting for stimulated emission in the transitions.
    mean_intensities_blue_wing : pd.DataFrame
        Mean radiation field intensities at the blue wing of the lines.
    energies_lower : np.ndarray
        Energy values of the lower levels in the transitions.

    Returns
    -------
    pd.DataFrame
        DataFrame containing the calculated internal upward transition probabilities.
    &quot;&quot;&quot;
    p_internal_up = beta_sobolevs * (
        line_f_lus
        / (CONST_H_CGS * line_nus)
        * stimulated_emission_factors
        * mean_intensities_blue_wing
        * energies_lower
    )
    return p_internal_up</div>



<div class="viewcode-block" id="line_transition_internal_down">
<a class="viewcode-back" href="../../../../api/tardis.opacities.macro_atom.macroatom_transitions.html#tardis.opacities.macro_atom.macroatom_transitions.line_transition_internal_down">[docs]</a>
def line_transition_internal_down(
    line_f_uls: np.ndarray,
    line_nus: np.ndarray,
    energies_lower: np.ndarray,
    beta_sobolevs: pd.DataFrame,
    transition_a_i_l_u_array: np.ndarray,
    line_ids: np.ndarray,
) -&gt; tuple[pd.DataFrame, pd.DataFrame]:
    &quot;&quot;&quot;
    Calculate internal downward transition probabilities for line transitions.

    This function computes the probability of internal downward transitions
    in macro atoms for line transitions, based on oscillator strengths,
    frequencies, and other atomic parameters.

    Parameters
    ----------
    line_f_uls : array_like
        Oscillator strengths for line transitions.
    line_nus : array_like
        Frequencies of line transitions.
    energies_lower : array_like
        Energies of the lower levels involved in transitions.
    beta_sobolevs : pd.DataFrame
        Sobolev beta factors for the transitions.
    transition_a_i_l_u_array : array_like
        Array containing atomic number, ion number, lower level, and upper level
        indices for each transition. Shape should be (n_transitions, 4).
    line_ids : array_like
        Identifiers for each line transition.

    Returns
    -------
    p_internal_down : pandas.DataFrame
        DataFrame containing the calculated internal downward transition
        probabilities with source information.
    internal_down_metadata : pandas.DataFrame
        DataFrame containing metadata for the transitions including
        transition line IDs, source and destination level information,
        transition type, and transition line indices.

    Notes
    -----
    The internal downward transition probability is calculated using the formula:
    p = 2 * nu^2 * f_ul / c^2 * beta * E_lower

    The function uses MacroAtomTransitionType to mark the transition type.
    &quot;&quot;&quot;
    p_internal_down = probability_internal_down(
        beta_sobolevs, line_nus, line_f_uls, energies_lower
    )

    sources = list(map(tuple, transition_a_i_l_u_array[:, [0, 1, 3]]))
    transition_indices = np.arange(len(line_ids))
    destinations = list(map(tuple, transition_a_i_l_u_array[:, [0, 1, 2]]))

    internal_down_metadata = pd.DataFrame(
        {
            &quot;transition_line_id&quot;: line_ids,
            &quot;source&quot;: sources,
            &quot;destination&quot;: destinations,
            &quot;transition_type&quot;: MacroAtomTransitionType.INTERNAL_DOWN,
            &quot;transition_line_idx&quot;: transition_indices,
        },
        index=p_internal_down.index,
    )
    p_internal_down[&quot;source&quot;] = sources

    return p_internal_down, internal_down_metadata</div>



<div class="viewcode-block" id="probability_internal_down">
<a class="viewcode-back" href="../../../../api/tardis.opacities.macro_atom.macroatom_transitions.html#tardis.opacities.macro_atom.macroatom_transitions.probability_internal_down">[docs]</a>
def probability_internal_down(
    beta_sobolevs: pd.DataFrame,
    line_nus: np.ndarray,
    line_f_uls: np.ndarray,
    energies_lower: np.ndarray,
) -&gt; pd.DataFrame:
    &quot;&quot;&quot;
    Calculate internal downward transition probabilities.

    This function computes the probability of internal downward transitions between
    energy levels in macro atoms. The calculation is based on oscillator strengths,
    line frequencies, and lower level energies.

    Parameters
    ----------
    beta_sobolevs : pd.DataFrame
        Sobolev escape probabilities for the line transitions.
    line_nus : np.ndarray
        Frequencies of the line transitions in Hz.
    line_f_uls : np.ndarray
        Oscillator strengths for line transitions from upper to lower levels.
    energies_lower : np.ndarray
        Energy values of the lower levels in the transitions.

    Returns
    -------
    pd.DataFrame
        DataFrame containing the calculated internal downward transition probabilities.
    &quot;&quot;&quot;
    p_internal_down = beta_sobolevs * (
        2 * line_nus**2 * line_f_uls / CONST_C_CGS**2 * energies_lower
    )
    return p_internal_down</div>



<div class="viewcode-block" id="line_transition_emission_down">
<a class="viewcode-back" href="../../../../api/tardis.opacities.macro_atom.macroatom_transitions.html#tardis.opacities.macro_atom.macroatom_transitions.line_transition_emission_down">[docs]</a>
def line_transition_emission_down(
    line_f_uls: np.ndarray,
    line_nus: np.ndarray,
    energies_upper: np.ndarray,
    energies_lower: np.ndarray,
    beta_sobolevs: pd.DataFrame,
    transition_a_i_l_u_array: np.ndarray,
    line_ids: np.ndarray,
) -&gt; tuple[pd.DataFrame, pd.DataFrame]:
    &quot;&quot;&quot;
    Calculate emission down transition probabilities for line transitions.

    This function computes the probability of emission down transitions for
    atomic line transitions using oscillator strengths, frequencies, energy
    differences, and Sobolev optical depths.

    Parameters
    ----------
    line_f_uls : array_like
        Oscillator strengths for the line transitions.
    line_nus : array_like
        Frequencies of the line transitions in Hz.
    energies_upper : array_like
        Energy values of the upper levels in the transitions.
    energies_lower : array_like
        Energy values of the lower levels in the transitions.
    beta_sobolevs : pd.DataFrame
        Sobolev escape probabilities for the transitions.
    transition_a_i_l_u_array : array_like
        Array containing atomic number, ion number, lower level, and upper level
        indices for each transition. Shape should be (n_transitions, 4).
    line_ids : array_like
        Unique identifiers for each line transition.

    Returns
    -------
    p_emission_down : pandas.DataFrame
        DataFrame containing the calculated emission down probabilities with
        source information. Contains columns for the probability values and
        &#39;source&#39; tuples.
    emission_down_metadata : pandas.DataFrame
        DataFrame containing metadata for the transitions including transition
        line IDs, source and destination level information, transition type,
        and transition line indices.

    Notes
    -----
    The emission down probability is calculated using the formula:
    P = 2 * nu^2 * f_ul / c^2 * beta * (E_upper - E_lower)

    The function uses MacroAtomTransitionType to mark the transition type.
    &quot;&quot;&quot;
    p_emission_down = probability_emission_down(
        beta_sobolevs, line_nus, line_f_uls, energies_upper, energies_lower
    )

    sources = list(map(tuple, transition_a_i_l_u_array[:, [0, 1, 3]]))
    transition_indices = np.arange(len(line_ids))
    destinations = list(map(tuple, transition_a_i_l_u_array[:, [0, 1, 2]]))

    emission_down_metadata = pd.DataFrame(
        {
            &quot;transition_line_id&quot;: line_ids,
            &quot;source&quot;: sources,
            &quot;destination&quot;: destinations,
            &quot;transition_type&quot;: MacroAtomTransitionType.BB_EMISSION,
            &quot;transition_line_idx&quot;: transition_indices,
        },
        index=p_emission_down.index,
    )
    p_emission_down[&quot;source&quot;] = sources

    return p_emission_down, emission_down_metadata</div>



<div class="viewcode-block" id="probability_emission_down">
<a class="viewcode-back" href="../../../../api/tardis.opacities.macro_atom.macroatom_transitions.html#tardis.opacities.macro_atom.macroatom_transitions.probability_emission_down">[docs]</a>
def probability_emission_down(
    beta_sobolevs: pd.DataFrame,
    line_nus: np.ndarray,
    line_f_uls: np.ndarray,
    energies_upper: np.ndarray,
    energies_lower: np.ndarray,
) -&gt; pd.DataFrame:
    &quot;&quot;&quot;
    Calculate emission down transition probabilities.

    This function computes the probability of emission down transitions for
    atomic line transitions. The calculation considers oscillator strengths,
    line frequencies, and the energy difference between upper and lower levels.

    Parameters
    ----------
    beta_sobolevs : pd.DataFrame
        Sobolev escape probabilities for the line transitions.
    line_nus : np.ndarray
        Frequencies of the line transitions in Hz.
    line_f_uls : np.ndarray
        Oscillator strengths for line transitions from upper to lower levels.
    energies_upper : np.ndarray
        Energy values of the upper levels in the transitions.
    energies_lower : np.ndarray
        Energy values of the lower levels in the transitions.

    Returns
    -------
    pd.DataFrame
        DataFrame containing the calculated emission down transition probabilities.
    &quot;&quot;&quot;
    p_emission_down = beta_sobolevs * (
        2
        * line_nus**2
        * line_f_uls
        / CONST_C_CGS**2
        * (energies_upper - energies_lower)
    )
    return p_emission_down</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 03 Oct 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>