

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-53HJHD1BWS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-53HJHD1BWS');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tardis.io.configuration.config_validator &mdash; tardis</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />

  
    <link rel="shortcut icon" href="../../../../_static/tardis_logo.ico"/>
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=8e209b53"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.13/dist/embed-amd.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            tardis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Input/Output</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/hdf/index.html">Hierarchical Data Format (HDF5)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/index.html">Configuration (Required Input)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/model/index.html">Reading Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/output/index.html">Additional Outputs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Analyzing Tardis</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/visualization/index.html">Visualization Tools &amp; Widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/spectrum/index.html">Analyzing TARDIS Spectra</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/liv_plot_notebook.html">Analyzing Last Interaction Velocity (LIV) Distribution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/rpacket_plot_notebook.html">Analysing Montecarlo Packets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/analysing_convergence_plot.html">Convergence Plots</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/intro/index.html">Physics Walkthrough Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/update_and_conv/update_and_conv.html">Updating Plasma and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/spectrum/index.html">Spectrum Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/tardisgamma/index.html">TARDIS-High Energy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/tools/index.html">Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/in_progress/index.html">Features In-Progress</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/credits.html">Credits &amp; Publication Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/code_comparison/index.html">Code Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/zreferences.html">References and Glossary</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tardis.io.configuration.config_validator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tardis.io.configuration.config_validator</h1><div class="highlight"><pre>
<span></span>&quot;&quot;&quot;
Configuration validation module for TARDIS.

This module provides functionality to validate TARDIS configuration files
against JSON schemas with support for cross-schema references and custom
type checking for Astropy Quantity objects.
&quot;&quot;&quot;

from __future__ import annotations

from copy import deepcopy
from pathlib import Path
from typing import TYPE_CHECKING

import yaml
from astropy.units.quantity import Quantity
from jsonschema import validators
from jsonschema.validators import Draft7Validator
from referencing import Registry, Resource
from referencing.jsonschema import DRAFT7

from tardis.io.util import YAMLLoader

if TYPE_CHECKING:
    from typing import Any

CONFIGURATION_DIR = Path(__file__).resolve().parent
SCHEMA_DIR = CONFIGURATION_DIR / &quot;schemas&quot;
CONFIG_SCHEMA_FNAME = SCHEMA_DIR / &quot;base.yml&quot;


<div class="viewcode-block" id="extend_with_default">
<a class="viewcode-back" href="../../../../api/tardis.io.configuration.config_validator.html#tardis.io.configuration.config_validator.extend_with_default">[docs]</a>
def extend_with_default(
    validator_class: type[Draft7Validator],
) -&gt; type[Draft7Validator]:
    &quot;&quot;&quot;
    Extend a jsonschema validator to automatically set default values on properties.

    By default, jsonschema ignores default values defined in schemas. This function
    creates an extended validator that will set default values during validation.

    Parameters
    ----------
    validator_class : type[Draft7Validator]
        The jsonschema validator class to extend (e.g., Draft7Validator)

    Returns
    -------
    type[Draft7Validator]
        Extended validator class that sets default values during validation

    Notes
    -----
    The extended validator also properly handles default values in schemas that
    use the oneOf keyword and validates that default values are of correct types.
    &quot;&quot;&quot;
    validate_properties = validator_class.VALIDATORS[&quot;properties&quot;]

    def set_defaults(
        validator: Any,
        properties: dict[str, Any],
        instance: dict[str, Any],
        schema: dict[str, Any],
    ) -&gt; Any:
        &quot;&quot;&quot;Set default values for properties that don&#39;t exist in the instance.&quot;&quot;&quot;
        # This validator also checks if default values are of the correct type
        # and properly sets default values on schemas that use the oneOf keyword
        if not list(validate_properties(validator, properties, instance, schema)):
            for property_name, subschema in properties.items():
                if &quot;default&quot; in subschema:
                    instance.setdefault(property_name, subschema[&quot;default&quot;])

        yield from validate_properties(validator, properties, instance, schema)

    return validators.extend(
        validator_class,
        {&quot;properties&quot;: set_defaults},
    )</div>



DefaultDraft7Validator = extend_with_default(Draft7Validator)


def _create_schema_registry() -&gt; Registry:
    &quot;&quot;&quot;
    Create a registry containing all schema files for reference resolution.

    Loads all YAML schema files from the schemas directory and creates a
    referencing Registry that can be used to resolve $ref references between
    schema files during validation.

    Returns
    -------
    Registry
        A referencing Registry containing all schema files with their
        filenames as URIs for cross-reference resolution

    Notes
    -----
    Schema files are loaded using the YAMLLoader and registered with
    Draft 7 JSON Schema specification for proper validation.
    &quot;&quot;&quot;
    registry = Registry()

    # Load all schema files in the schemas directory
    for schema_file in SCHEMA_DIR.glob(&quot;*.yml&quot;):
        with open(schema_file) as f:
            schema_content = yaml.load(f, Loader=YAMLLoader)

        # Create a resource with the filename as the URI, explicitly specifying Draft 7
        resource = Resource.from_contents(schema_content, default_specification=DRAFT7)
        registry = registry.with_resource(uri=schema_file.name, resource=resource)

    return registry


<div class="viewcode-block" id="is_quantity">
<a class="viewcode-back" href="../../../../api/tardis.io.configuration.config_validator.html#tardis.io.configuration.config_validator.is_quantity">[docs]</a>
def is_quantity(checker: Any, instance: Any) -&gt; bool:
    &quot;&quot;&quot;
    Check if the provided instance is of type astropy.units.quantity.Quantity.

    This function is used as a custom type checker for jsonschema validation
    to properly handle Astropy Quantity objects in configuration validation.

    Parameters
    ----------
    checker : Any
        Object of `TypeChecker`. Passed by jsonschema internally.
    instance : Any
        The instance to be checked for Quantity type.

    Returns
    -------
    bool
        True if the instance is of type astropy.units.quantity.Quantity,
        False otherwise.
    &quot;&quot;&quot;
    return isinstance(instance, Quantity)</div>



<div class="viewcode-block" id="validate_dict">
<a class="viewcode-back" href="../../../../api/tardis.io.configuration.config_validator.html#tardis.io.configuration.config_validator.validate_dict">[docs]</a>
def validate_dict(
    config_dict: dict[str, Any],
    schemapath: Path = CONFIG_SCHEMA_FNAME,
    validator: type[Draft7Validator] = DefaultDraft7Validator,
) -&gt; dict[str, Any]:
    &quot;&quot;&quot;
    Validate a configuration dictionary against a JSON schema.

    This function validates a configuration dictionary using a JSON schema,
    with support for cross-file schema references and custom type checking
    for Astropy Quantity objects. Default values are automatically set
    according to the schema definition.

    Parameters
    ----------
    config_dict : dict[str, Any]
        The configuration dictionary to validate.
    schemapath : Path, optional
        Path to the main schema file. Defaults to CONFIG_SCHEMA_FNAME.
    validator : type[Draft7Validator], optional
        The validator class to use. Defaults to DefaultDraft7Validator.

    Returns
    -------
    dict[str, Any]
        A validated and potentially modified copy of the input dictionary
        with default values set according to the schema.

    Raises
    ------
    jsonschema.ValidationError
        If the configuration dictionary does not conform to the schema.
    jsonschema.SchemaError
        If the schema itself is invalid.

    Notes
    -----
    This function creates a deep copy of the input dictionary before
    validation to avoid modifying the original data.
    &quot;&quot;&quot;
    with open(schemapath) as f:
        schema = yaml.load(f, Loader=YAMLLoader)

    # Create registry for schema references
    registry = _create_schema_registry()

    validated_dict = deepcopy(config_dict)
    custom_type_checker = validator.TYPE_CHECKER.redefine(&quot;quantity&quot;, is_quantity)
    custom_validator = validators.extend(validator, type_checker=custom_type_checker)

    # Create validator with registry for reference resolution
    validator_instance = custom_validator(schema=schema, registry=registry)
    validator_instance.validate(validated_dict)
    return validated_dict</div>



<div class="viewcode-block" id="validate_yaml">
<a class="viewcode-back" href="../../../../api/tardis.io.configuration.config_validator.html#tardis.io.configuration.config_validator.validate_yaml">[docs]</a>
def validate_yaml(
    configpath: Path,
    schemapath: Path = CONFIG_SCHEMA_FNAME,
    validator: type[Draft7Validator] = DefaultDraft7Validator,
) -&gt; dict[str, Any]:
    &quot;&quot;&quot;
    Validate a YAML configuration file against a JSON schema.

    This function loads a YAML configuration file and validates it using
    the validate_dict function. It provides a convenient interface for
    validating configuration files directly from disk.

    Parameters
    ----------
    configpath : Path
        Path to the YAML configuration file to validate.
    schemapath : Path, optional
        Path to the main schema file. Defaults to CONFIG_SCHEMA_FNAME.
    validator : type[Draft7Validator], optional
        The validator class to use. Defaults to DefaultDraft7Validator.

    Returns
    -------
    dict[str, Any]
        A validated configuration dictionary with default values set
        according to the schema.

    Raises
    ------
    FileNotFoundError
        If the configuration file cannot be found.
    yaml.YAMLError
        If the YAML file cannot be parsed.
    jsonschema.ValidationError
        If the configuration does not conform to the schema.
    jsonschema.SchemaError
        If the schema itself is invalid.

    Notes
    -----
    The YAML file is loaded using the custom YAMLLoader which may have
    specific behavior for handling certain YAML constructs.
    &quot;&quot;&quot;
    with open(configpath) as f:
        config = yaml.load(f, Loader=YAMLLoader)
    return validate_dict(config, schemapath, validator)</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 24 Jul 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>