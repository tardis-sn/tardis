

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-53HJHD1BWS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-53HJHD1BWS');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tardis.plasma.assembly.base &mdash; tardis</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />

  
    <link rel="shortcut icon" href="../../../../_static/tardis_logo.ico"/>
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=53bc6e61"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.13/dist/embed-amd.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            tardis
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../getting_started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart for TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/credits.html">Credits &amp; Publication Policies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tutorials/high_energy/run_high_energy_workflow.html">TARDIS High Energy Workflow Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/visualization/tutorial_montecarlo_packet_visualization.html">Montecarlo Packet Visualization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../how_to_guides.html">How-To Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analyzing_tardis/index.html">Analyszing TARDIS Simulation Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/tutorial_read_configuration.html">Reading a Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/output/index.html">Additional Outputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../how-to/code_comparison/index.html">How to do Code Comparison using TARDIS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/intro/index.html">Physics Walkthrough Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/update_and_conv/update_and_conv.html">Updating Plasma and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/spectrum/index.html">Spectrum Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics_walkthrough/tardisgamma/index.html">TARDIS-High Energy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/visualization_reference.html">Visualization Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/index.html">Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/hdf/index.html">Hierarchical Data Format (HDF5) Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CHANGELOG.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/research_done_using_TARDIS/research_papers.html">Papers Using TARDIS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../resources/zreferences.html">Bibliography and Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/tools/index.html">Developer Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/in_progress/index.html">Features In-Progress</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">tardis</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tardis.plasma.assembly.base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tardis.plasma.assembly.base</h1><div class="highlight"><pre>
<span></span>import importlib
import logging

import numpy as np
import pandas as pd
from astropy import units as u

from tardis.plasma import BasePlasma
from tardis.plasma.base import PlasmaSolverSettings
from tardis.plasma.equilibrium.rates.photoionization_strengths import (
    AnalyticPhotoionizationCoeffSolver,
)
from tardis.plasma.exceptions import PlasmaConfigError
from tardis.plasma.properties import (
    HeliumNumericalNLTE,
    IonNumberDensity,
    IonNumberDensityHeNLTE,
    LevelBoltzmannFactorNLTE,
    MarkovChainTransProbsCollector,
    RadiationFieldCorrection,
    StimulatedEmissionFactor,
)
from tardis.plasma.properties.base import TransitionProbabilitiesProperty
from tardis.plasma.properties.level_population import LevelNumberDensity
from tardis.plasma.properties.nlte_rate_equation_solver import (
    NLTEPopulationSolverLU,
    NLTEPopulationSolverRoot,
)
from tardis.plasma.properties.rate_matrix_index import NLTEIndexHelper
from tardis.transport.montecarlo.estimators.continuum_radfield_properties import (
    ContinuumProperties,
)
from tardis.util.base import species_string_to_tuple

logger = logging.getLogger(__name__)


<div class="viewcode-block" id="map_species_from_string">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.map_species_from_string">[docs]</a>
def map_species_from_string(species):
    return [species_string_to_tuple(spec) for spec in species]</div>



<div class="viewcode-block" id="convert_species_to_multi_index">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.convert_species_to_multi_index">[docs]</a>
def convert_species_to_multi_index(species_strs):
    return pd.MultiIndex.from_tuples(
        map_species_from_string(species_strs),
        names=[&quot;atomic_number&quot;, &quot;ion_number&quot;],
    )</div>



<div class="viewcode-block" id="PlasmaSolverFactory">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory">[docs]</a>
class PlasmaSolverFactory:
    ## Analytical Approximations
    excitation_analytical_approximation: str = &quot;lte&quot;
    ionization_analytical_approximation: str = &quot;lte&quot;
    nebular_ionization_delta_treatment: tuple  # species to use for the delta_treatment in nebular ionization ML93

    link_t_rad_t_electron: float = 1.0

    radiative_rates_type: str = &quot;dilute-blackbody&quot;

    delta_treatment = None

    ## Statistical Balance Solver
    legacy_nlte_species: list = []

    nlte_excitation_species: list = []
    nlte_ionization_species: list = []
    nlte_solver: str = &quot;lu&quot;

    ## Helium Treatment options
    helium_treatment: str = &quot;none&quot;
    heating_rate_data_file: str = &quot;none&quot;

    ## Continuum Interaction
    continuum_interaction_species: list = []
    enable_adiabatic_cooling: bool = False
    enable_two_photon_decay: bool = False

    ## Opacities
    line_interaction_type: str = &quot;scatter&quot;

    ## Assembly properties
    plasma_modules: list = []
    kwargs: dict = {}
    property_kwargs: dict = {}
    plasma_collection = importlib.import_module(
        &quot;tardis.plasma.properties.legacy_property_collections&quot;
    )

    def __init__(
        self,
        atom_data,
        config=None,
    ) -&gt; None:
        if config is not None:
            self.parse_plasma_config(config.plasma)
        self.atom_data = atom_data

    @property
    def continuum_interaction_species_multi_index(self):
        return convert_species_to_multi_index(
            self.continuum_interaction_species
        )

<div class="viewcode-block" id="PlasmaSolverFactory.parse_plasma_config">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.parse_plasma_config">[docs]</a>
    def parse_plasma_config(self, plasma_config):
        &quot;&quot;&quot;
        Parse the plasma configuration.

        Parameters
        ----------
        plasma_config : PlasmaConfig
            The plasma configuration object containing the plasma parameters.

        Returns
        -------
        None
        &quot;&quot;&quot;
        self.continuum_interaction_species = (
            plasma_config.continuum_interaction.species
        )
        self.set_nlte_species_from_string(plasma_config.nlte.species)
        self.line_interaction_type = plasma_config.line_interaction_type
        self.link_t_rad_t_electron = plasma_config.link_t_rad_t_electron

        self.excitation_analytical_approximation = plasma_config.excitation
        self.ionization_analytical_approximation = plasma_config.ionization
        self.delta_treatment = plasma_config.get(&quot;delta_treatment&quot;, None)

        self.helium_treatment = plasma_config.helium_treatment
        self.heating_rate_data_file = plasma_config.heating_rate_data_file

        self.nlte_ionization_species = plasma_config.nlte_ionization_species
        self.nlte_excitation_species = plasma_config.nlte_excitation_species

        self.nlte_solver = plasma_config.nlte_solver

        self.radiative_rates_type = plasma_config.radiative_rates_type

        self.enable_adiabatic_cooling = (
            plasma_config.continuum_interaction.enable_adiabatic_cooling
        )
        self.enable_two_photon_decay = (
            plasma_config.continuum_interaction.enable_two_photon_decay
        )</div>


<div class="viewcode-block" id="PlasmaSolverFactory.prepare_factory">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.prepare_factory">[docs]</a>
    def prepare_factory(
        self, selected_atomic_numbers, property_collections, config=None
    ):
        &quot;&quot;&quot;
        Set up the plasma factory.

        Parameters
        ----------
        selected_atomic_numbers : list of int
            Selected atomic numbers in the simulation.
        property_collections : str
            The property collection module to be used in the plasma assembly.
        config : object, optional
            Configuration object containing plasma settings (default: None).
        &quot;&quot;&quot;
        self.plasma_collection = importlib.import_module(property_collections)

        self.atom_data.prepare_atom_data(
            selected_atomic_numbers,
            line_interaction_type=self.line_interaction_type,
            continuum_interaction_species=self.continuum_interaction_species_multi_index,
            nlte_species=self.legacy_nlte_species,
        )

        self.check_continuum_interaction_species()

        self.plasma_modules = (
            self.plasma_collection.basic_inputs
            + self.plasma_collection.basic_properties
        )

        self.setup_analytical_approximations()
        self.property_kwargs[RadiationFieldCorrection] = dict(
            delta_treatment=self.delta_treatment
        )
        if (config is not None) and len(self.legacy_nlte_species) &gt; 0:
            self.setup_legacy_nlte(config.plasma.nlte)
        else:
            self.plasma_modules += self.plasma_collection.non_nlte_properties

        if self.line_interaction_type in (&quot;downbranch&quot;, &quot;macroatom&quot;) and (
            len(self.continuum_interaction_species) == 0
        ):
            self.plasma_modules += self.plasma_collection.macro_atom_properties

        self.setup_helium_treatment()

        if len(self.continuum_interaction_species) &gt; 0:
            self.setup_continuum_interactions()</div>


<div class="viewcode-block" id="PlasmaSolverFactory.setup_helium_treatment">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.setup_helium_treatment">[docs]</a>
    def setup_helium_treatment(self):
        &quot;&quot;&quot;
        Set up the helium treatment for the plasma assembly.

        Parameters
        ----------
        helium_treatment : str
            The type of helium treatment to be used. Possible values are:
            - &quot;recomb-nlte&quot;: Use recombination NLTE treatment for helium.
            - &quot;numerical-nlte&quot;: Use numerical NLTE treatment for helium.

        heating_rate_data_file : str or None
            The path to the heating rate data file. Required when using
            &quot;numerical-nlte&quot; helium treatment.

        Raises
        ------
        PlasmaConfigError
            If the helium NLTE treatment is incompatible with the NLTE ionization
            and excitation treatment.

            If the heating rate data file is not specified when using
            &quot;numerical-nlte&quot; helium treatment.
        &quot;&quot;&quot;
        if (
            self.helium_treatment == &quot;recomb-nlte&quot;
            or self.helium_treatment == &quot;numerical-nlte&quot;
        ) and (
            len(self.nlte_ionization_species + self.nlte_excitation_species) &gt; 0
        ):
            # Prevent the user from using helium NLTE treatment with
            # NLTE ionization and excitation treatment. This is because
            # the helium_nlte_properties could overwrite the NLTE ionization
            # and excitation ion number and electron densities.
            # helium_numerical_nlte_properties is also included here because
            # it is currently in the same if else block, and thus may block
            # the addition of the components from the else block.
            raise PlasmaConfigError(
                &quot;Helium NLTE treatment is incompatible with the NLTE ionization and excitation treatment.&quot;
            )

        # TODO: Disentangle these if else block such that compatible components
        # can be added independently.
        if self.helium_treatment == &quot;recomb-nlte&quot;:
            self.plasma_modules += self.plasma_collection.helium_nlte_properties
        elif self.helium_treatment == &quot;numerical-nlte&quot;:
            self.plasma_modules += (
                self.plasma_collection.helium_numerical_nlte_properties
            )
            if self.heating_rate_data_file in [&quot;none&quot;, None]:
                raise PlasmaConfigError(&quot;Heating rate data file not specified&quot;)
            self.property_kwargs[HeliumNumericalNLTE] = dict(
                heating_rate_data_file=self.heating_rate_data_file
            )
        else:
            # If nlte ionization species are present, we don&#39;t want to add the
            # IonNumberDensity from helium_lte_properties, since we want
            # to use the IonNumberDensity provided by the NLTE solver.
            if (
                len(self.nlte_ionization_species + self.nlte_excitation_species)
                &gt; 0
            ):
                self.plasma_modules.append(LevelNumberDensity)
            else:
                self.plasma_modules += (
                    self.plasma_collection.helium_lte_properties
                )</div>


<div class="viewcode-block" id="PlasmaSolverFactory.setup_legacy_nlte">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.setup_legacy_nlte">[docs]</a>
    def setup_legacy_nlte(self, nlte_config):
        &quot;&quot;&quot;
        Set up the non-LTE (NLTE) properties for the legacy species.

        Parameters
        ----------
        nlte_config : dict
            A dictionary containing the NLTE configuration.
        &quot;&quot;&quot;
        self.plasma_modules += self.plasma_collection.nlte_properties
        self.plasma_modules.append(
            LevelBoltzmannFactorNLTE.from_config(nlte_config)
        )
        self.property_kwargs[StimulatedEmissionFactor] = dict(
            nlte_species=self.legacy_nlte_species
        )</div>


<div class="viewcode-block" id="PlasmaSolverFactory.setup_analytical_approximations">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.setup_analytical_approximations">[docs]</a>
    def setup_analytical_approximations(self):
        &quot;&quot;&quot;
        Setup the analytical approximations for excitation and ionization.

        Returns
        -------
        None
        &quot;&quot;&quot;
        if self.excitation_analytical_approximation == &quot;lte&quot;:
            self.plasma_modules += (
                self.plasma_collection.lte_excitation_properties
            )
        elif self.excitation_analytical_approximation == &quot;dilute-lte&quot;:
            self.plasma_modules += (
                self.plasma_collection.dilute_lte_excitation_properties
            )
        else:
            raise PlasmaConfigError(
                f&#39;Invalid excitation analytical approximation. Configured as {self.excitation_analytical_approximation} but needs to be either &quot;lte&quot; or &quot;dilute-lte&quot;&#39;
            )

        if self.ionization_analytical_approximation == &quot;lte&quot;:
            self.plasma_modules += (
                self.plasma_collection.lte_ionization_properties
            )
        elif self.ionization_analytical_approximation == &quot;nebular&quot;:
            self.plasma_modules += (
                self.plasma_collection.nebular_ionization_properties
            )
        else:
            raise PlasmaConfigError(
                f&#39;Invalid excitation analytical approximation. Configured as {self.ionization_analytical_approximation} but needs to be either &quot;lte&quot; or &quot;nebular&quot;&#39;
            )</div>


<div class="viewcode-block" id="PlasmaSolverFactory.initialize_j_blues">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.initialize_j_blues">[docs]</a>
    def initialize_j_blues(self, dilute_planckian_radiation_field, lines_df):
        &quot;&quot;&quot;
        Initialize the j_blues DataFrame based on the radiative_rates_type and the dilute_planckian_radiation_field.

        Parameters
        ----------
        dilute_planckian_radiation_field : object
            The dilute Planckian radiation field object.
        lines_df : pandas.DataFrame
            The DataFrame containing lines information.

        Returns
        -------
        pandas.DataFrame
            The DataFrame with calculated mean intensity values.

        Raises
        ------
        ValueError
            If the radiative_rates_type is unknown.
        &quot;&quot;&quot;
        if (self.radiative_rates_type == &quot;dilute-blackbody&quot;) or (
            self.radiative_rates_type == &quot;detailed&quot;
        ):
            j_blues = pd.DataFrame(
                dilute_planckian_radiation_field.calculate_mean_intensity(
                    lines_df.nu.values
                ),
                index=lines_df.index,
            )

        elif self.radiative_rates_type == &quot;blackbody&quot;:
            planckian_rad_field = (
                dilute_planckian_radiation_field.to_planckian_radiation_field()
            )
            j_blues = pd.DataFrame(
                planckian_rad_field.calculate_mean_intensity(
                    lines_df.nu.values
                ),
                index=lines_df.index,
            )

        else:
            raise ValueError(
                f&quot;radiative_rates_type type unknown - {self.radiative_rates_type}&quot;
            )

        return j_blues</div>


<div class="viewcode-block" id="PlasmaSolverFactory.set_continuum_interaction_species_from_string">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.set_continuum_interaction_species_from_string">[docs]</a>
    def set_continuum_interaction_species_from_string(
        self, continuum_interaction_species
    ):
        &quot;&quot;&quot;
        Set the continuum interaction species from a list of species strings.

        Parameters
        ----------
        continuum_interaction_species : list of str
            List of species strings representing the continuum interaction species.

        Returns
        -------
        None
        &quot;&quot;&quot;
        self.continuum_interaction_species = [
            species_string_to_tuple(species)
            for species in continuum_interaction_species
        ]</div>


<div class="viewcode-block" id="PlasmaSolverFactory.check_continuum_interaction_species">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.check_continuum_interaction_species">[docs]</a>
    def check_continuum_interaction_species(self):
        &quot;&quot;&quot;
        Check if all continuum interaction species belong to atoms that have been specified in the configuration.

        Raises
        ------
            PlasmaConfigError: If not all continuum interaction species belong to specified atoms.
        &quot;&quot;&quot;
        continuum_atoms = (
            self.continuum_interaction_species_multi_index.get_level_values(
                &quot;atomic_number&quot;
            )
        )

        continuum_atoms_in_selected_atoms = np.all(
            continuum_atoms.isin(self.atom_data.selected_atomic_numbers)
        )

        if not continuum_atoms_in_selected_atoms:
            raise PlasmaConfigError(
                &quot;Not all continuum interaction species &quot;
                &quot;belong to atoms that have been specified &quot;
                &quot;in the configuration.&quot;
            )</div>


<div class="viewcode-block" id="PlasmaSolverFactory.set_nlte_species_from_string">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.set_nlte_species_from_string">[docs]</a>
    def set_nlte_species_from_string(self, nlte_species):
        &quot;&quot;&quot;
        Sets the non-LTE species from a string representation.

        Parameters
        ----------
        nlte_species : str
            A string representation of the non-LTE species.

        Returns
        -------
        None
            This method does not return anything.
        &quot;&quot;&quot;
        self.legacy_nlte_species = map_species_from_string(nlte_species)</div>


<div class="viewcode-block" id="PlasmaSolverFactory.setup_continuum_interactions">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.setup_continuum_interactions">[docs]</a>
    def setup_continuum_interactions(self):
        &quot;&quot;&quot;
        Set up continuum interactions for the plasma assembly.

        Raises
        ------
            PlasmaConfigError: If the line_interaction_type is not &quot;macroatom&quot;.
            PlasmaConfigError: If an NLTE ionization species is not in the continuum species.
            PlasmaConfigError: If an NLTE excitation species is not in the continuum species.
            PlasmaConfigError: If the NLTE solver type is unknown.
        &quot;&quot;&quot;
        if self.line_interaction_type != &quot;macroatom&quot;:
            raise PlasmaConfigError(
                &quot;Continuum interactions require line_interaction_type &quot;
                f&quot;macroatom (instead of {self.line_interaction_type}).&quot;
            )

        self.plasma_modules += (
            self.plasma_collection.continuum_interaction_properties
        )
        self.plasma_modules += (
            self.plasma_collection.continuum_interaction_inputs
        )

        if self.enable_adiabatic_cooling:
            self.plasma_modules += (
                self.plasma_collection.adiabatic_cooling_properties
            )

        if self.enable_two_photon_decay:
            self.plasma_modules += self.plasma_collection.two_photon_properties

        transition_probabilities_outputs = [
            plasma_property.transition_probabilities_outputs
            for plasma_property in self.plasma_modules
            if issubclass(plasma_property, TransitionProbabilitiesProperty)
        ]
        transition_probabilities_outputs = [
            item
            for sublist in transition_probabilities_outputs
            for item in sublist
        ]

        self.property_kwargs[MarkovChainTransProbsCollector] = {
            &quot;inputs&quot;: transition_probabilities_outputs
        }
        if len(self.nlte_ionization_species + self.nlte_excitation_species) &gt; 0:
            if self.nlte_ionization_species:
                nlte_ionization_species = self.nlte_ionization_species
                for species in nlte_ionization_species:
                    if species not in self.continuum_interaction_species:
                        raise PlasmaConfigError(
                            f&quot;NLTE ionization species {species} not in continuum species.&quot;
                        )
            if self.nlte_excitation_species:
                nlte_excitation_species = self.nlte_excitation_species
                for species in nlte_excitation_species:
                    if species not in self.continuum_interaction_species:
                        raise PlasmaConfigError(
                            f&quot;NLTE excitation species {species} not in continuum species.&quot;
                        )
            self.property_kwargs[NLTEIndexHelper] = {
                &quot;nlte_ionization_species&quot;: self.nlte_ionization_species,
                &quot;nlte_excitation_species&quot;: self.nlte_excitation_species,
            }
            if self.nlte_solver == &quot;lu&quot;:
                self.plasma_modules += (
                    self.plasma_collection.nlte_lu_solver_properties
                )
                logger.warning(
                    &quot;LU solver will be inaccurate for NLTE excitation, proceed with caution.&quot;
                )
            elif self.nlte_solver == &quot;root&quot;:
                self.plasma_modules += (
                    self.plasma_collection.nlte_root_solver_properties
                )
            else:
                raise PlasmaConfigError(
                    f&quot;NLTE solver type unknown - {self.nlte_solver}&quot;
                )</div>


<div class="viewcode-block" id="PlasmaSolverFactory.setup_electron_densities">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.setup_electron_densities">[docs]</a>
    def setup_electron_densities(self, electron_densities):
        if self.helium_treatment == &quot;numerical-nlte&quot;:
            self.property_kwargs[IonNumberDensityHeNLTE] = dict(
                electron_densities=electron_densities
            )
        elif (
            len(self.nlte_ionization_species + self.nlte_excitation_species) &gt; 0
        ) and self.nlte_solver == &quot;root&quot;:
            self.property_kwargs[NLTEPopulationSolverRoot] = dict(
                electron_densities=electron_densities
            )
        elif (
            len(self.nlte_ionization_species + self.nlte_excitation_species) &gt; 0
        ) and self.nlte_solver == &quot;lu&quot;:
            self.property_kwargs[NLTEPopulationSolverLU] = dict(
                electron_densities=electron_densities
            )
        else:
            self.property_kwargs[IonNumberDensity] = dict(
                electron_densities=electron_densities
            )</div>


<div class="viewcode-block" id="PlasmaSolverFactory.initialize_continuum_properties">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.initialize_continuum_properties">[docs]</a>
    def initialize_continuum_properties(self, dilute_planckian_radiation_field):
        &quot;&quot;&quot;
        Initialize the continuum properties of the plasma.

        Parameters
        ----------
        dilute_planckian_radiation_field : DilutePlanckianRadiationField
            The dilute Planckian radiation field.

        Returns
        -------
        initial_continuum_properties : `~tardis.plasma.properties.ContinuumProperties`
            The initial continuum properties of the plasma.
        &quot;&quot;&quot;
        t_electrons = dilute_planckian_radiation_field.temperature.to(u.K)

        initial_continuum_solver = AnalyticPhotoionizationCoeffSolver(
            self.atom_data.photoionization_data
        )
        initial_continuum_properties = ContinuumProperties(
            *initial_continuum_solver.solve(
                dilute_planckian_radiation_field, t_electrons
            )
        )
        return initial_continuum_properties</div>


<div class="viewcode-block" id="PlasmaSolverFactory.assemble">
<a class="viewcode-back" href="../../../../api/tardis.plasma.assembly.base.html#tardis.plasma.assembly.base.PlasmaSolverFactory.assemble">[docs]</a>
    def assemble(
        self,
        number_densities,
        dilute_planckian_radiation_field,
        time_explosion,
        electron_densities=None,
        **kwargs,
    ):
        &quot;&quot;&quot;
        Assemble the plasma based on the provided parameters and settings.

        Parameters
        ----------
        number_densities : dict
            Dictionary of number densities for different species.
        dilute_planckian_radiation_field : object
            The dilute Planckian radiation field object.
        time_explosion : float
            The time of explosion.
        electron_densities : array-like, optional
            Optional electron densities.

        Returns
        -------
        BasePlasma
            The assembled plasma object.

        Raises
        ------
        ValueError
            If an error occurs during assembly.
        &quot;&quot;&quot;
        j_blues = self.initialize_j_blues(
            dilute_planckian_radiation_field, self.atom_data.lines
        )
        plasma_solver_settings = PlasmaSolverSettings(
            RADIATIVE_RATES_TYPE=self.radiative_rates_type
        )

        plasma_assemble_kwargs = dict(
            time_explosion=time_explosion,
            dilute_planckian_radiation_field=dilute_planckian_radiation_field,
            number_density=number_densities,
            link_t_rad_t_electron=self.link_t_rad_t_electron,
            atomic_data=self.atom_data,
            j_blues=j_blues,
            continuum_interaction_species=self.continuum_interaction_species_multi_index,
            nlte_ionization_species=self.nlte_ionization_species,
            nlte_excitation_species=self.nlte_excitation_species,
        )
        if len(self.continuum_interaction_species) &gt; 0:
            initial_continuum_properties = self.initialize_continuum_properties(
                dilute_planckian_radiation_field
            )
            plasma_assemble_kwargs.update(
                gamma=initial_continuum_properties.photo_ionization_rate_coefficient,
                bf_heating_coeff_estimator=None,
                stim_recomb_cooling_coeff_estimator=None,
                alpha_stim_factor=initial_continuum_properties.stimulated_recombination_rate_factor,
            )

        if electron_densities is not None:
            electron_densities = pd.Series(electron_densities.cgs.value)

        self.setup_electron_densities(electron_densities)
        plasma_assemble_kwargs[&quot;helium_treatment&quot;] = self.helium_treatment
        plasma_assemble_kwargs.update(kwargs)
        return BasePlasma(
            plasma_properties=self.plasma_modules,
            property_kwargs=self.property_kwargs,
            plasma_solver_settings=plasma_solver_settings,
            **plasma_assemble_kwargs,
        )</div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, TARDIS Collaboration.
      <span class="lastupdated">Last updated on 12 Oct 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>